<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>בדיקת דיפלוי סופי</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>🔍 בדיקת דיפלוי סופי - 16/12/2024</h1>
    
    <div class="test-section">
        <div class="test-title">📡 בדיקת חיבור לשרת</div>
        <button onclick="testConnection()">בדוק חיבור</button>
        <div id="connection-result"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">🏢 בדיקת רשימת חברות</div>
        <button onclick="testContracts()">טען חברות</button>
        <div id="contracts-result"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">📊 בדיקת נתוני תפוסה (Pooling)</div>
        <button onclick="testPooling()">בדוק תפוסה לחברה 2</button>
        <div id="pooling-result"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">👥 בדיקת פילטור מנויים</div>
        <button onclick="testConsumers()">טען מנויים לחברה 2</button>
        <div id="consumers-result"></div>
    </div>
    
    <script>
        const RENDER_URL = 'https://s-b-parking-reports.onrender.com';
        const LOCAL_URL = 'http://localhost:5000';
        
        // Determine which URL to use
        const BASE_URL = window.location.hostname === 'localhost' ? LOCAL_URL : RENDER_URL;
        
        async function testConnection() {
            const resultDiv = document.getElementById('connection-result');
            resultDiv.innerHTML = '<div class="info">בודק חיבור...</div>';
            
            try {
                const response = await fetch(`${BASE_URL}/api/test-render-connection`);
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">✅ חיבור תקין!</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">❌ בעיה בחיבור</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">❌ שגיאה: ${error.message}</div>
                `;
            }
        }
        
        async function testContracts() {
            const resultDiv = document.getElementById('contracts-result');
            resultDiv.innerHTML = '<div class="info">טוען חברות...</div>';
            
            try {
                const response = await fetch(`${BASE_URL}/api/company-manager/proxy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parking_id: 'b4954e1c-646d-4905-9ab8-9e433bed75e4',
                        endpoint: 'contracts',
                        method: 'GET'
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    const contracts = data.data;
                    let hebrewTest = contracts.find(c => c.id === '1000');
                    
                    resultDiv.innerHTML = `
                        <div class="success">✅ נמצאו ${contracts.length} חברות</div>
                        <div class="info">
                            🔤 בדיקת עברית (חברה 1000): ${hebrewTest ? hebrewTest.name : 'לא נמצא'}
                        </div>
                        <pre>${JSON.stringify(contracts.slice(0, 5), null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">❌ לא נמצאו חברות</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">❌ שגיאה: ${error.message}</div>
                `;
            }
        }
        
        async function testPooling() {
            const resultDiv = document.getElementById('pooling-result');
            resultDiv.innerHTML = '<div class="info">טוען נתוני תפוסה...</div>';
            
            try {
                const response = await fetch(`${BASE_URL}/api/company-manager/proxy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parking_id: 'b4954e1c-646d-4905-9ab8-9e433bed75e4',
                        endpoint: 'contracts/2/detail',
                        method: 'GET'
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    const detail = data.data;
                    const pooling = detail.pooling;
                    
                    if (pooling && pooling.poolingDetail) {
                        const facilities = Array.isArray(pooling.poolingDetail) ? 
                            pooling.poolingDetail : [pooling.poolingDetail];
                        
                        const mainFacility = facilities.find(f => f.facility === "0" || f.facility === 0);
                        
                        resultDiv.innerHTML = `
                            <div class="success">✅ נתוני תפוסה נמצאו</div>
                            ${mainFacility ? `
                                <div class="info">
                                    🚗 סיכום כללי: ${mainFacility.presentCounter}/${mainFacility.maxCounter} רכבים
                                </div>
                            ` : ''}
                            <div class="info">
                                🏢 ${facilities.length} חניונים
                            </div>
                            <pre>${JSON.stringify(pooling, null, 2)}</pre>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="error">❌ אין נתוני pooling</div>
                            <pre>${JSON.stringify(detail, null, 2)}</pre>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">❌ לא נמצאו נתונים</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">❌ שגיאה: ${error.message}</div>
                `;
            }
        }
        
        async function testConsumers() {
            const resultDiv = document.getElementById('consumers-result');
            resultDiv.innerHTML = '<div class="info">טוען מנויים...</div>';
            
            try {
                const response = await fetch(`${BASE_URL}/api/company-manager/proxy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parking_id: 'b4954e1c-646d-4905-9ab8-9e433bed75e4',
                        endpoint: 'consumers',
                        method: 'GET',
                        payload: { contractId: '2' }
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    const consumers = data.data;
                    
                    resultDiv.innerHTML = `
                        <div class="${consumers.length <= 100 ? 'success' : 'info'}">
                            👥 נמצאו ${consumers.length} מנויים
                            ${consumers.length > 100 ? ' (⚠️ יתכן שהפילטור לא עובד)' : ' ✅'}
                        </div>
                        <pre>${JSON.stringify(consumers.slice(0, 3), null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">❌ לא נמצאו מנויים</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">❌ שגיאה: ${error.message}</div>
                `;
            }
        }
    </script>
</body>
</html>
