<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דוח תנועות מנוי</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .btn-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .transactions-container {
            display: none;
        }
        
        .transactions-container.show {
            display: block;
        }
        
        .summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .summary-label {
            color: #666;
            margin-top: 5px;
        }
        
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .transactions-table thead {
            background: #667eea;
            color: white;
        }
        
        .transactions-table th,
        .transactions-table td {
            padding: 12px;
            text-align: right;
            border: 1px solid #ddd;
        }
        
        .transactions-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .transactions-table tbody tr:hover {
            background: #e9ecef;
        }
        
        .transaction-in {
            background: #d4edda !important;
        }
        
        .transaction-out {
            background: #f8d7da !important;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }
        
        .success.show {
            display: block;
        }
        
        .filters {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-label {
            font-weight: bold;
            color: #555;
        }
        
        .filter-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .legend {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            font-size: 14px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .legend-icon.entry {
            background: #28a745;
        }
        
        .legend-icon.exit {
            background: #dc3545;
        }
        
        .legend-icon.transfer {
            background: #ffc107;
        }
        
        .export-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            float: left;
            margin-top: 20px;
        }
        
        .export-btn:hover {
            background: #218838;
        }
        
        .quick-dates {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        .quick-date-btn {
            padding: 5px 10px;
            background: #e9ecef;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .quick-date-btn:hover {
            background: #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 דוח תנועות מנוי</h1>
        
        <div class="controls">
            <div class="form-row">
                <div class="form-group">
                    <label for="companyId">מספר חברה:</label>
                    <input type="text" id="companyId" placeholder="לדוגמה: 1000" value="1000">
                </div>
                <div class="form-group">
                    <label for="subscriberId">מספר מנוי:</label>
                    <input type="text" id="subscriberId" placeholder="לדוגמה: 1">
                </div>
            </div>
            
            <div class="date-range">
                <div class="form-group">
                    <label for="startDate">מתאריך:</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label for="endDate">עד תאריך:</label>
                    <input type="date" id="endDate">
                </div>
            </div>
            
            <div class="quick-dates">
                <button class="quick-date-btn" onclick="setQuickDate('today')">היום</button>
                <button class="quick-date-btn" onclick="setQuickDate('week')">שבוע אחרון</button>
                <button class="quick-date-btn" onclick="setQuickDate('month')">חודש אחרון</button>
                <button class="quick-date-btn" onclick="setQuickDate('3months')">3 חודשים</button>
                <button class="quick-date-btn" onclick="setQuickDate('year')">שנה</button>
            </div>
            
            <div class="form-group" style="margin-top: 15px;">
                <label for="exportType">סוג תנועות:</label>
                <select id="exportType">
                    <option value="-1">כל התנועות</option>
                    <option value="0">תנועות חדשות בלבד</option>
                    <option value="1">תנועות שכבר נשלחו</option>
                </select>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="loadTransactions()">
                    🔍 הצג תנועות
                </button>
                <button class="btn btn-secondary" onclick="testWithoutDates()">
                    🧪 בדיקה בלי תאריכים
                </button>
                <button class="btn btn-secondary" onclick="clearResults()">
                    🔄 נקה
                </button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>טוען תנועות...</p>
        </div>
        
        <div class="error" id="error"></div>
        <div class="success" id="success"></div>
        
        <div class="transactions-container" id="transactionsContainer">
            <div class="summary" id="summary">
                <div class="summary-item">
                    <div class="summary-value" id="totalTransactions">0</div>
                    <div class="summary-label">סה"כ תנועות</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="totalAmount">₪0</div>
                    <div class="summary-label">סה"כ סכום</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="entriesCount">0</div>
                    <div class="summary-label">כניסות</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="exitsCount">0</div>
                    <div class="summary-label">יציאות</div>
                </div>
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <span class="legend-icon entry"></span>
                    <span>קודים 1-2: כניסה</span>
                </div>
                <div class="legend-item">
                    <span class="legend-icon exit"></span>
                    <span>קודים 11-12: יציאה</span>
                </div>
                <div class="legend-item">
                    <span>יחידות 100-199: כניסה</span>
                </div>
                <div class="legend-item">
                    <span>יחידות 200-299: יציאה</span>
                </div>
                <div class="legend-item">
                    <span>יחידות 300-399: מעבר</span>
                </div>
            </div>
            
            <div class="filters">
                <span class="filter-label">סינון:</span>
                <button class="filter-btn active" onclick="filterTransactions('all')">הכל</button>
                <button class="filter-btn" onclick="filterTransactions('entries')">כניסות בלבד</button>
                <button class="filter-btn" onclick="filterTransactions('exits')">יציאות בלבד</button>
            </div>
            
            <table class="transactions-table" id="transactionsTable">
                <thead>
                    <tr>
                        <th>תאריך ושעה</th>
                        <th>סוג תנועה</th>
                        <th>מספר רכב</th>
                        <th>חניון</th>
                        <th>יחידה</th>
                    </tr>
                </thead>
                <tbody id="transactionsBody">
                </tbody>
            </table>
            
            <button class="export-btn" onclick="exportToExcel()">
                📥 ייצוא לאקסל
            </button>
        </div>
    </div>
    
    <script src="config.js"></script>
    <script src="parking-api-xml.js"></script>
    <script>
        let allTransactions = [];
        let currentFilter = 'all';
        
        // Set default dates
        window.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const lastMonth = new Date(today);
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            
            document.getElementById('startDate').value = lastMonth.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        });
        
        function setQuickDate(period) {
            const today = new Date();
            const startDate = new Date();
            
            switch(period) {
                case 'today':
                    startDate.setDate(today.getDate());
                    break;
                case 'week':
                    startDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    startDate.setMonth(today.getMonth() - 1);
                    break;
                case '3months':
                    startDate.setMonth(today.getMonth() - 3);
                    break;
                case 'year':
                    startDate.setFullYear(today.getFullYear() - 1);
                    break;
            }
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }
        
        async function loadTransactions() {
            const companyId = document.getElementById('companyId').value;
            const subscriberId = document.getElementById('subscriberId').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const exportType = document.getElementById('exportType').value;
            
            if (!companyId || !subscriberId) {
                showError('יש להזין מספר חברה ומספר מנוי');
                return;
            }
            
            hideAll();
            showLoading(true);
            
            try {
                // Initialize API
                const api = window.parkingAPIXML || new ParkingAPIXML();
                
                // Build URL
                let url = `/consumers/${companyId},${subscriberId}/parktrans`;
                const params = [];
                
                // Try without dates first to test the endpoint
                console.log('[Transactions] Testing endpoint without date filters first...');
                
                // Only add date params if they're provided
                // Note: API expects YYYY-MM-DD format
                if (startDate) {
                    console.log('[Transactions] Adding minDate:', startDate);
                    params.push(`minDate=${startDate}`);
                }
                if (endDate) {
                    console.log('[Transactions] Adding maxDate:', endDate);
                    params.push(`maxDate=${endDate}`);
                }
                if (exportType !== '-1') {
                    params.push(`exported=${exportType}`);
                }
                
                if (params.length > 0) {
                    url += '?' + params.join('&');
                }
                
                console.log('[Transactions] Final URL:', url);
                
                // Make request
                const result = await api.makeRequest(url);
                
                if (result.success && result.data) {
                    allTransactions = parseTransactions(result.data);
                    displayTransactions(allTransactions);
                    showSuccess(`נמצאו ${allTransactions.length} תנועות`);
                } else if (result.status === 204) {
                    allTransactions = [];
                    displayTransactions([]);
                    showSuccess('לא נמצאו תנועות בתקופה המבוקשת');
                } else {
                    // Check for specific error codes
                    if (result.status === 500) {
                        showError('שגיאת שרת (500) - ייתכן שהפורמט של התאריכים לא נכון או שאין גישה לנתונים');
                        console.error('Server error details:', result);
                    } else if (result.status === 404) {
                        showError('המנוי לא נמצא - בדוק את מספר החברה ומספר המנוי');
                    } else {
                        showError(result.error || 'לא נמצאו תנועות');
                    }
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                showError('שגיאה בטעינת התנועות: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function parseTransactions(data) {
            // Handle empty or missing data
            if (!data || !data.parkTransaction) return [];
            
            // Handle single transaction vs array
            const transactions = Array.isArray(data.parkTransaction) 
                ? data.parkTransaction 
                : [data.parkTransaction];
                
            return transactions.map(t => {
                // Determine direction based on transaction type
                const typeNum = parseInt(t.transactionType);
                const isEntry = (typeNum === 1 || typeNum === 2);
                const isExit = (typeNum === 11 || typeNum === 12);
                
                return {
                    time: t.transactionTime,
                    type: getTransactionType(t.transactionType),
                    transactionTypeNum: t.transactionType,
                    lpn: t.lpn || '-',  // מספר רכב
                    parkingLot: t.facilityin || t.facilityout || 'חניון ראשי',
                    computer: t.computer || '-',
                    device: getDeviceType(t.device || '-'),
                    deviceNum: t.device || '-',
                    amount: parseFloat(t.amount || 0),
                    direction: isEntry ? 'in' : (isExit ? 'out' : 'unknown')
                };
            }).filter(t => parseInt(t.transactionTypeNum) !== 42);  // סינון קוד 42
        }
        
        function getTransactionType(type) {
            // 1 או 2 = כניסה
            // 11 או 12 = יציאה
            const typeNum = parseInt(type);
            if (typeNum === 1 || typeNum === 2) {
                return 'כניסה';
            } else if (typeNum === 11 || typeNum === 12) {
                return 'יציאה';
            }
            return `סוג ${type}`;
        }
        
        function getDeviceType(device) {
            // 100-199 = יחידת כניסה
            // 200-299 = יחידת יציאה
            // 300-399 = יחידת מעבר
            const deviceNum = parseInt(device);
            if (deviceNum >= 100 && deviceNum < 200) {
                return `יחידת כניסה ${device}`;
            } else if (deviceNum >= 200 && deviceNum < 300) {
                return `יחידת יציאה ${device}`;
            } else if (deviceNum >= 300 && deviceNum < 400) {
                return `יחידת מעבר ${device}`;
            }
            return `יחידה ${device}`;
        }
        
        function displayTransactions(transactions) {
            // Update summary
            const totalAmount = transactions.reduce((sum, t) => sum + t.amount, 0);
            const entries = transactions.filter(t => t.direction === 'in').length;
            const exits = transactions.filter(t => t.direction === 'out').length;
            
            document.getElementById('totalTransactions').textContent = transactions.length;
            document.getElementById('totalAmount').textContent = `₪${totalAmount.toFixed(2)}`;
            document.getElementById('entriesCount').textContent = entries;
            document.getElementById('exitsCount').textContent = exits;
            
            // Display table
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '';
            
            transactions.forEach(t => {
                const row = document.createElement('tr');
                row.className = t.direction === 'in' ? 'transaction-in' : 'transaction-out';
                
                const time = new Date(t.time);
                const formattedTime = `${time.toLocaleDateString('he-IL')} ${time.toLocaleTimeString('he-IL')}`;
                
                // Icon based on direction
                let directionIcon = '';
                if (t.direction === 'in') {
                    directionIcon = '🟢 כניסה';
                } else if (t.direction === 'out') {
                    directionIcon = '🔴 יציאה';
                } else {
                    directionIcon = '⚪ אחר';
                }
                
                row.innerHTML = `
                    <td>${formattedTime}</td>
                    <td>${directionIcon}</td>
                    <td>${t.lpn}</td>
                    <td>${t.parkingLot}</td>
                    <td>${t.device}</td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('transactionsContainer').classList.add('show');
        }
        
        function filterTransactions(type) {
            currentFilter = type;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filter transactions
            let filtered = allTransactions;
            if (type === 'entries') {
                filtered = allTransactions.filter(t => t.direction === 'in');
            } else if (type === 'exits') {
                filtered = allTransactions.filter(t => t.direction === 'out');
            }
            
            displayTransactions(filtered);
        }
        
        function exportToExcel() {
            let filtered = allTransactions;
            if (currentFilter === 'entries') {
                filtered = allTransactions.filter(t => t.direction === 'in');
            } else if (currentFilter === 'exits') {
                filtered = allTransactions.filter(t => t.direction === 'out');
            }
            
            // Create CSV content
            const headers = ['תאריך ושעה', 'סוג תנועה', 'מספר רכב', 'חניון', 'יחידה'];
            const rows = filtered.map(t => {
                const time = new Date(t.time);
                let directionText = '';
                if (t.direction === 'in') {
                    directionText = 'כניסה';
                } else if (t.direction === 'out') {
                    directionText = 'יציאה';
                } else {
                    directionText = 'אחר';
                }
                
                return [
                    `${time.toLocaleDateString('he-IL')} ${time.toLocaleTimeString('he-IL')}`,
                    directionText,
                    t.lpn,
                    t.parkingLot,
                    t.deviceNum
                ];
            });
            
            // Add BOM for Hebrew
            const BOM = '\uFEFF';
            const csvContent = BOM + headers.join(',') + '\n' + 
                rows.map(row => row.join(',')).join('\n');
            
            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const filename = `transactions_${document.getElementById('subscriberId').value}_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function testWithoutDates() {
            const companyId = document.getElementById('companyId').value || '2';
            const subscriberId = document.getElementById('subscriberId').value || '1';
            
            if (!companyId || !subscriberId) {
                showError('יש להזין מספר חברה ומספר מנוי');
                return;
            }
            
            hideAll();
            showLoading(true);
            
            try {
                const api = window.parkingAPIXML || new ParkingAPIXML();
                
                // Try without any query params first
                const url = `/consumers/${companyId},${subscriberId}/parktrans`;
                console.log('[Test] Testing basic endpoint:', url);
                
                const result = await api.makeRequest(url);
                console.log('[Test] Result:', result);
                
                if (result.success && result.data) {
                    allTransactions = parseTransactions(result.data);
                    displayTransactions(allTransactions);
                    showSuccess(`בדיקה הצליחה! נמצאו ${allTransactions.length} תנועות (ללא סינון תאריכים)`);
                } else if (result.status === 204) {
                    allTransactions = [];
                    displayTransactions([]);
                    showSuccess('הבדיקה הצליחה - אין תנועות למנוי זה');
                } else {
                    if (result.status === 500) {
                        showError('שגיאת שרת (500) - נראה שה-endpoint לא זמין או שיש בעיה בשרת');
                    } else if (result.status === 404) {
                        showError('המנוי לא נמצא או ה-endpoint לא קיים');
                    } else {
                        showError(`שגיאה: ${result.error || 'לא ידוע'} (סטטוס: ${result.status})`);
                    }
                }
            } catch (error) {
                console.error('[Test] Error:', error);
                showError('שגיאה בבדיקה: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function clearResults() {
            document.getElementById('companyId').value = '';
            document.getElementById('subscriberId').value = '';
            hideAll();
        }
        
        function hideAll() {
            document.getElementById('loading').classList.remove('show');
            document.getElementById('error').classList.remove('show');
            document.getElementById('success').classList.remove('show');
            document.getElementById('transactionsContainer').classList.remove('show');
        }
        
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }
        
        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = '❌ ' + message;
            errorEl.classList.add('show');
        }
        
        function showSuccess(message) {
            const successEl = document.getElementById('success');
            successEl.textContent = '✅ ' + message;
            successEl.classList.add('show');
        }
    </script>
</body>
</html>
