<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ×× ×•×™×™ ×—× ×™×•×Ÿ | ×©×™×™×“×˜ ××ª ×‘×›××Ÿ ×™×©×¨××œ</title>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
            --border-color: #dee2e6;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            direction: rtl;
            font-size: 13px; /* Reduced font size */
            transition: font-size 0.3s ease;
        }

        body.small-font {
            font-size: 12px;
        }

        body.large-font {
            font-size: 18px;
        }

        body.xlarge-font {
            font-size: 22px;
        }

        body[lang="en"] {
            direction: ltr;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Section */
        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            color: var(--dark-text);
            font-size: 1.75em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Language & Accessibility Controls */
        .lang-switch, .font-controls, .accessibility-btn {
            display: flex;
            gap: 5px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .btn:disabled,
        .btn[disabled] {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            background-color: #cccccc !important;
            color: #666666 !important;
        }
        
        .btn:disabled:hover,
        .btn[disabled]:hover {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-info {
            background: #17a2b8 !important;
            color: white !important;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            min-width: 35px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-info:hover {
            background: #138496 !important;
            transform: scale(1.1);
        }

        .btn-success {
            background: #28a745 !important;
            color: white !important;
            border: none !important;
            padding: 5px 10px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 16px !important;
            min-width: 35px !important;
            height: 30px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .btn-success:hover {
            background: #218838 !important;
            transform: scale(1.1);
        }
        
        /* Force button visibility in table */
        td .btn-success {
            display: inline-flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        

        
        /* Uniform action buttons styling */
        .action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .action-btn {
            padding: 10px 20px !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            border-radius: 6px !important;
            border: none !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            height: 38px !important;
            min-width: 120px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            white-space: nowrap !important;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .action-btn.btn-success {
            background: #28a745 !important;
            color: white !important;
        }
        
        .action-btn.btn-warning {
            background: #ffc107 !important;
            color: #212529 !important;
        }
        
        .action-btn.btn-primary {
            background: #007bff !important;
            color: white !important;
        }
        
        .action-btn.btn-info {
            background: #17a2b8 !important;
            color: white !important;
        }

        .btn-warning {
            background: var(--warning-color);
            color: #212529;
        }

        .btn-icon {
            padding: 8px 12px;
            font-size: 1.2em;
        }

        /* Company Selection */
        .company-selector {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .company-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .company-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .company-card.selected {
            background: var(--primary-color);
            color: white;
        }

        .company-card.selected .company-number {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .company-card.selected .stat-label,
        .company-card.selected .stat-value,
        .company-card.selected .facility-item {
            color: white;
        }

        .company-card p {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* Main Content Area */
        .main-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-title {
            color: var(--dark-text);
            font-size: 1.5em;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }

        /* Search and Filter */
        .search-filter-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95em;
        }

        .filter-select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95em;
            min-width: 150px;
        }

        /* Subscribers Table */
        .table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .subscribers-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .subscribers-table th,
        .subscribers-table td {
            padding: 10px 8px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            font-size: inherit;
        }

        body[lang="en"] .subscribers-table th,
        body[lang="en"] .subscribers-table td {
            text-align: left;
        }

        .subscribers-table th {
            background: var(--light-bg);
            font-weight: 600;
            color: var(--dark-text);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .subscribers-table tr:hover {
            background: #f0f0f0;
            cursor: pointer;
        }

        .subscribers-table tr.selected {
            background: #e7f3ff;
        }

        .tag-badge {
            background: var(--info-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .status-active {
            color: var(--success-color);
        }

        .status-inactive {
            color: var(--danger-color);
        }
        
        /* Sortable Headers */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background 0.2s;
        }
        
        .sortable:hover {
            background: rgba(0, 102, 204, 0.05);
        }
        
        .sort-icon {
            font-size: 0.8em;
            margin-left: 5px;
            color: #999;
            display: inline-block;
            transition: all 0.3s;
        }
        
        .sortable.sort-asc .sort-icon {
            color: var(--primary-color);
            transform: rotate(0deg);
        }
        
        .sortable.sort-desc .sort-icon {
            color: var(--primary-color);
            transform: rotate(180deg);
        }

        /* Edit Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        /* ×”×‘×˜×—×ª ×”×¦×’×ª ×”×›×¤×ª×•×¨×™× */
        .modal-content .btn {
            display: inline-flex !important;
            align-items: center;
            gap: 5px;
        }
        
        .modal-content button[style*="display: none"] {
            display: inline-flex !important;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-actions-top {
            display: flex !important;
            justify-content: flex-end;
            gap: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            background: #f8f9fa;
            margin-left: -25px;
            margin-right: -25px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .modal-actions-top .btn {
            display: inline-flex !important;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            min-width: 100px;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .modal-actions-top .btn span {
            display: inline-block;
        }
        
        .modal-actions-top .btn span:first-child {
            font-size: 18px;
        }

        .modal-title {
            font-size: 1.5em;
            color: var(--dark-text);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .form-group input,
        .form-group         select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95em;
        }
        
        select:disabled {
            background-color: #f0f0f0;
            color: #888;
            cursor: not-allowed;
            opacity: 0.8;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input[readonly] {
            background: var(--light-bg);
            cursor: not-allowed;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid var(--light-bg);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Accessibility Features */
        .accessibility-panel {
            display: none;
            position: fixed;
            top: 100px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            z-index: 999;
            min-width: 250px;
        }

        body[lang="en"] .accessibility-panel {
            right: auto;
            left: 20px;
        }

        .accessibility-panel.show {
            display: block;
        }

        .accessibility-panel h3 {
            margin-bottom: 15px;
            color: var(--dark-text);
        }

        .accessibility-option {
            margin-bottom: 15px;
        }

        .accessibility-option label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }

        body[lang="en"] .toast-container {
            right: auto;
            left: 20px;
        }

        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Hover loading animation */
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        
        /* Loading row style */
        tr.loading-details {
            background: linear-gradient(90deg, #f0f0f0 0%, #ffffff 50%, #f0f0f0 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            opacity: 0.7;
        }
        
        /* Hover effect for loadable rows */
        tbody tr[data-hover-loadable="true"]:not(.loading-details):hover {
            background-color: #f8f9fa;
            transition: background-color 0.2s ease;
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .company-list {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 20px;
            }

            .subscribers-table {
                font-size: 0.85em;
            }

            .subscribers-table th,
            .subscribers-table td {
                padding: 8px;
            }

            .search-filter-container {
                flex-direction: column;
            }

            .search-box,
            .filter-select {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .header-controls {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                padding: 8px 16px;
                font-size: 0.85em;
            }
        }

        /* Enhanced Company Card Styles */
        .company-card {
            background: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            text-align: right;
            position: relative;
        }
        
        .company-card .company-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .company-card h3 {
            font-size: 1.1em;
            margin: 0;
            color: var(--dark-text);
        }
        
        .company-card .company-number {
            font-size: 0.9em;
            color: #666;
            background: white;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .company-card .stats-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 0.9em;
        }
        
        .company-card .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        
        .company-card .stat-label {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 2px;
        }
        
        .company-card .stat-value {
            font-weight: 600;
            color: var(--dark-text);
            font-size: 1.1em;
        }
        
        .company-card .occupancy-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .company-card .occupancy-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--primary-color));
            transition: width 0.5s ease;
        }
        
        .company-card .facilities-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            font-size: 0.85em;
        }
        
        .company-card .facility-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            color: #666;
        }
        
        /* Force modal buttons to be visible */
        #cancelTopBtn, #saveTopBtn {
            display: inline-flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1000 !important;
        }
        
        .modal.show .modal-actions-top {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .modal.show .modal-actions-top * {
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }

            .header-controls,
            .accessibility-panel,
            .modal,
            .toast-container {
                display: none !important;
            }

            .main-content {
                box-shadow: none;
                padding: 0;
            }

            .subscribers-table {
                border: 1px solid #000;
            }
        }
        
        /* Footer styles */
        .footer {
            text-align: center;
            padding: 30px 20px;
            margin-top: 50px;
            border-top: 2px solid #e0e0e0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
            color: #666;
            font-size: 14px;
        }
        
        .footer .credit {
            margin-top: 12px;
            font-size: 16px;
            color: #333;
        }
        
        .footer .company {
            font-weight: 600;
            color: #444;
            font-size: 15px;
            margin-bottom: 8px;
        }
        
        .footer .developer {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            font-size: 17px;
        }
        
        /* Hover Loading Styles for Advanced Features */
        tr[data-hover-loadable="true"] {
            cursor: help;
            position: relative;
        }
        
        tr[data-hover-loadable="true"]::after {
            content: "â³";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            font-size: 14px;
        }
        
        tr.loading-details {
            background: linear-gradient(90deg, #f0f0f0 0%, #ffffff 50%, #f0f0f0 100%);
            background-size: 200% 100%;
            animation: loading-shimmer 1.5s infinite;
        }
        
        @keyframes loading-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Large Company Indicator */
        .large-company-indicator {
            background: #fef3c7;
            color: #92400e;
            padding: 8px 16px;
            border-radius: 4px;
            margin: 10px 0;
            display: inline-block;
            font-size: 14px;
        }
        
        .large-company-indicator::before {
            content: "âš ï¸ ";
            margin-left: 5px;
        }
        
        /* Progress indicator for background loading */
        .background-progress {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.9; }
            50% { opacity: 1; }
            100% { opacity: 0.9; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <span>ğŸ…¿ï¸</span>
                <span data-translate="title">××¢×¨×›×ª × ×™×”×•×œ ×× ×•×™×™ ×—× ×™×•×Ÿ</span>
                <br>
                <span style="font-size: 0.5em; font-weight: normal; ">××‘×™×ª ×©×™×™×“×˜ ××ª ×‘×›××Ÿ ×™×©×¨××œ</span>
            </h1>
            <div class="header-controls">
                <div class="user-info" style="padding: 5px 10px; background: var(--light-bg); border-radius: 6px; margin-right: 10px;">
                    <span>ğŸ‘¤ ××©×ª××©: <span id="currentUsername">×˜×•×¢×Ÿ...</span></span>
                    <span style="margin: 0 10px;">|</span>
                    <span id="userRole">×× ×”×œ ×—×‘×¨×”</span>
                    <span style="margin: 0 10px;">|</span>
                    <button class="btn btn-danger" onclick="logout()" style="background: #dc3545; color: white; padding: 5px 10px; border-radius: 6px;">
                        ğŸšª ×”×ª× ×ª×§
                    </button>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button onclick="adjustFontSize(-1)" class="btn btn-secondary btn-sm" title="×”×§×˜×Ÿ ×¤×•× ×˜" style="padding: 5px 10px;">A-</button>
                    <button onclick="adjustFontSize(0)" class="btn btn-secondary btn-sm" title="×’×•×“×œ ×¨×’×™×œ" style="padding: 5px 10px;">A</button>
                    <button onclick="adjustFontSize(1)" class="btn btn-secondary btn-sm" title="×”×’×“×œ ×¤×•× ×˜" style="padding: 5px 10px;">A+</button>
                </div>
                <div class="lang-switch">
                    <button class="btn btn-secondary" onclick="toggleLanguage()">
                        <span data-translate="lang">English</span>
                    </button>
                </div>
                <button class="btn btn-warning" onclick="toggleAccessibility()" title="× ×’×™×©×•×ª">
                    â™¿ <span data-translate="accessibility">× ×’×™×©×•×ª</span>
                </button>
            </div>
        </div>

        <!-- Accessibility Panel -->
        <div class="accessibility-panel" id="accessibilityPanel">
            <h3 data-translate="accessibilityOptions">××¤×©×¨×•×™×•×ª × ×’×™×©×•×ª</h3>
            <div class="accessibility-option">
                <label>
                    <input type="checkbox" id="highContrast" onchange="toggleHighContrast()">
                    <span data-translate="highContrast">× ×™×’×•×“×™×•×ª ×’×‘×•×”×”</span>
                </label>
            </div>
            <div class="accessibility-option">
                <label>
                    <input type="checkbox" id="underlineLinks" onchange="toggleUnderlineLinks()">
                    <span data-translate="underlineLinks">×”×“×’×©×ª ×§×™×©×•×¨×™×</span>
                </label>
            </div>
            <div class="accessibility-option">
                <label>
                    <input type="checkbox" id="focusHighlight" onchange="toggleFocusHighlight()">
                    <span data-translate="focusHighlight">×”×“×’×©×ª ×¤×•×§×•×¡</span>
                </label>
            </div>
            <div class="accessibility-option">
                <button class="btn btn-primary" onclick="resetAccessibility()">
                    <span data-translate="reset">××™×¤×•×¡</span>
                </button>
            </div>
        </div>

        <!-- Company Selector -->
        <div class="company-selector" id="companySelector">
            <h2 class="section-title" data-translate="selectCompany">×‘×—×¨ ×—×‘×¨×”</h2>
            <div class="company-list" id="companyList">
                <!-- Companies will be loaded here -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <span data-translate="subscribers">×× ×•×™×™×</span>
                    <span id="companyName"></span>
                </h2>
                <div class="action-buttons">
                    <button class="btn btn-success action-btn" onclick="addNewSubscriber()">
                        <span data-translate="addNew">+ ×”×•×¡×£ ×× ×•×™ ×—×“×©</span>
                    </button>
                    <button class="btn btn-warning action-btn" onclick="addGuestSubscriber()">
                        <span data-translate="addGuest">+ ×”×•×¡×£ ××•×¨×—</span>
                    </button>
                    <button class="btn btn-info action-btn" onclick="openReportsModal()">
                        <span data-translate="reports">ğŸ“Š ×“×•×—×•×ª</span>
                    </button>
                    <button class="btn btn-primary action-btn" onclick="exportToExcel()">
                        <span data-translate="export">ğŸ“¥ ×™×™×¦×•× ×œ××§×¡×œ</span>
                    </button>
                    <button class="btn btn-secondary action-btn" id="reloadFullButton" onclick="reloadFullData()" style="display: none;">
                        <span data-translate="reloadFull">ğŸ”„ ×˜×¢×™× ×” ××œ××”</span>
                    </button>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="search-filter-container">
                <input type="text" class="search-box" id="searchBox" 
                       placeholder="×—×™×¤×•×© ×œ×¤×™ ×©×, ××¡×¤×¨ ×× ×•×™, ××¡×¤×¨ ×¨×›×‘..." 
                       data-translate-placeholder="searchPlaceholder">
                <select class="filter-select" id="filterPresence">
                    <option value="" data-translate="allPresence">×”×›×œ</option>
                    <option value="present" data-translate="presentOnly">× ×•×›×—×™× ×‘×œ×‘×“</option>
                    <option value="absent" data-translate="absentOnly">×œ× × ×•×›×—×™×</option>
                </select>
                <select class="filter-select" id="filterDate">
                    <option value="" data-translate="allDates">×›×œ ×”×ª××¨×™×›×™×</option>
                    <option value="valid" data-translate="validOnly">×‘×ª×•×§×£</option>
                    <option value="expired" data-translate="expiredOnly">×¤×’ ×ª×•×§×£</option>
                    <option value="expiring30" data-translate="expiring30">×¤×’ ×‘×¢×•×“ 30 ×™×•×</option>
                    <option value="expiring7" data-translate="expiring7">×¤×’ ×‘×¢×•×“ 7 ×™××™×</option>
                </select>
            </div>

            <!-- Loading State -->
            <div class="loading" id="loadingState" style="display: none;">
                <div class="spinner"></div>
                <p data-translate="loading">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
            </div>

            <!-- Subscribers Table -->
            <div class="table-container" id="tableContainer">
                <table class="subscribers-table" id="subscribersTable">
                    <thead>
                        <tr>
                            <th data-translate="companyNum" data-sort="companyNum" class="sortable">××¡' ×—×‘×¨×” <span class="sort-icon">â‡…</span></th>
                            <th data-translate="companyName" data-sort="companyName" class="sortable">×©× ×—×‘×¨×” <span class="sort-icon">â‡…</span></th>
                            <th data-translate="subscriberNum" data-sort="subscriberNum" class="sortable">××¡' ×× ×•×™ <span class="sort-icon">â‡…</span></th>
                            <th data-translate="firstName" data-sort="firstName" class="sortable">×©× ×¤×¨×˜×™ <span class="sort-icon">â‡…</span></th>
                            <th data-translate="lastName" data-sort="lastName" class="sortable">×©× ××©×¤×—×” <span class="sort-icon">â‡…</span></th>
                            <th data-translate="tagNum" data-sort="tagNum" class="sortable">××¡' ×ª×’ <span class="sort-icon">â‡…</span></th>
                            <th data-translate="vehicle1" data-sort="vehicle1" class="sortable">×¨×›×‘ 1 <span class="sort-icon">â‡…</span></th>
                            <th data-translate="vehicle2">×¨×›×‘ 2</th>
                            <th data-translate="vehicle3">×¨×›×‘ 3</th>
                            <th data-translate="validUntil" data-sort="validUntil" class="sortable">×‘×ª×•×§×£ ×¢×“ <span class="sort-icon">â‡…</span></th>
                            <th data-translate="profile">×¤×¨×•×¤×™×œ</th>
                            <th data-translate="validFrom" data-sort="validFrom" class="sortable">×ª×—×™×œ×ª ×ª×•×§×£ <span class="sort-icon">â‡…</span></th>
                            <th data-translate="presence" data-sort="presence" class="sortable">× ×•×›×—×•×ª <span class="sort-icon">â‡…</span></th>
                        </tr>
                    </thead>
                    <tbody id="subscribersTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Edit Modal -->
        <div class="modal" id="editModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" data-translate="editSubscriber">×¢×¨×™×›×ª ×× ×•×™</h2>
                    <button class="close-btn" onclick="closeModal()">&times;</button>
                </div>
                
                <!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” ×œ××¢×œ×” -->
                <div class="modal-actions-top" style="display: flex !important;">
                    <button type="button" onclick="closeModal()" class="btn btn-secondary" id="cancelTopBtn" style="display: inline-flex !important; visibility: visible !important;">
                        <span>âŒ</span>
                        <span data-translate="cancel">×‘×™×˜×•×œ</span>
                    </button>
                    <button type="button" onclick="saveSubscriber()" class="btn btn-primary" id="saveTopBtn" style="display: inline-flex !important; visibility: visible !important;">
                        <span>ğŸ’¾</span>
                        <span data-translate="save">×©××•×¨ ×©×™× ×•×™×™×</span>
                    </button>
                </div>
                
                <form id="editForm">
                    <div style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                        * ×©×“×•×ª ×—×•×‘×”: ×©× ××©×¤×—×”, ×ª×—×™×œ×ª ×ª×•×§×£, ×‘×ª×•×§×£ ×¢×“
                    </div>
                    <div class="form-group">
                        <label for="editCompanyNum" data-translate="companyNum">××¡×¤×¨ ×—×‘×¨×”</label>
                        <input type="text" id="editCompanyNum" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label for="editCompanyName" data-translate="companyName">×©× ×—×‘×¨×”</label>
                        <input type="text" id="editCompanyName" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label for="editSubscriberNum" data-translate="subscriberNum">××¡×¤×¨ ×× ×•×™</label>
                        <input type="text" id="editSubscriberNum" readonly style="background-color: #f0f0f0; cursor: not-allowed;" placeholder="×™×•×§×¦×” ××•×˜×•××˜×™×ª">
                        <small style="color: #666;">* ×”××¡×¤×¨ ×™×•×§×¦×” ××•×˜×•××˜×™×ª ×¢"×™ ×”×©×¨×ª</small>
                    </div>
                    <div class="form-group">
                        <label for="editFirstName" data-translate="firstName">×©× ×¤×¨×˜×™</label>
                        <input type="text" id="editFirstName" placeholder="×”×›× ×¡ ×©× ×¤×¨×˜×™ (×œ×“×•×’××”: ×“×•×“)">
                    </div>
                    <div class="form-group">
                        <label for="editLastName" data-translate="lastName">×©× ××©×¤×—×” *</label>
                        <input type="text" id="editLastName" placeholder="×”×›× ×¡ ×©× ××©×¤×—×” (×œ×“×•×’××”: ×›×”×Ÿ) ×©×“×” ×—×•×‘×”" required>
                    </div>
                    <div class="form-group">
                        <label for="editTagNum" data-translate="tagNum">××¡×¤×¨ ×ª×’</label>
                        <input type="text" id="editTagNum" placeholder="××¡×¤×¨ ×ª×’">
                    </div>
                    <div class="form-group">
                        <label for="editVehicle1" data-translate="vehicle1">×¨×›×‘ 1</label>
                        <input type="text" id="editVehicle1" placeholder="××¡×¤×¨ ×¨×›×‘ (×œ×“×•×’××”: 12345001)">
                    </div>
                    <div class="form-group">
                        <label for="editVehicle2" data-translate="vehicle2">×¨×›×‘ 2</label>
                        <input type="text" id="editVehicle2" placeholder="××¡×¤×¨ ×¨×›×‘ (×œ×“×•×’××”: 98765002)">
                    </div>
                    <div class="form-group">
                        <label for="editVehicle3" data-translate="vehicle3">×¨×›×‘ 3</label>
                        <input type="text" id="editVehicle3" placeholder="××¡×¤×¨ ×¨×›×‘ (×œ×“×•×’××”: 55666003)">
                    </div>
                    <div class="form-group">
                        <label for="editValidFrom" data-translate="validFrom">×ª×—×™×œ×ª ×ª×•×§×£ *</label>
                        <input type="text" id="editValidFrom" placeholder="DD/MM/YYYY (×©×“×” ×—×•×‘×”)" required>
                        <small style="color: #666;">×¤×•×¨××˜: ×™×•×/×—×•×“×©/×©× ×”</small>
                    </div>
                    <div class="form-group">
                        <label for="editValidUntil" data-translate="validUntil">×‘×ª×•×§×£ ×¢×“ *</label>
                        <input type="text" id="editValidUntil" placeholder="DD/MM/YYYY ×©×“×” ×—×•×‘×” (××§×¡×™××•× 31/12/3035)" required>
                        <small style="color: #666;">×¤×•×¨××˜: ×™×•×/×—×•×“×©/×©× ×” â€¢ ××§×¡×™××•×: 31/12/3035</small>
                    </div>
                    <div class="form-group">
                        <label for="editProfile" data-translate="profile">×¤×¨×•×¤×™×œ ×›×¨×˜×™×¡</label>
                        <select id="editProfile">
                            <option value="1" data-profile-name="regular" data-translate="regular">×¨×’×™×œ</option>
                            <option value="2" data-profile-name="vip" data-translate="vip">VIP</option>
                            <option value="3" data-profile-name="disabled" data-translate="disabled">× ×›×”</option>
                        </select>
                        <small style="color: #888;" id="profileHelpText">* ×¢×“×›×•×Ÿ ×¤×¨×•×¤×™×œ ×“×•×¨×© ×”×¨×©××ª P</small>
                    </div>
                    
                    <div class="form-group" id="emailGroup">
                        <label for="editEmail" data-translate="email">××™××™×™×œ</label>
                        <input type="email" id="editEmail" placeholder="×›×ª×•×‘×ª ××™××™×™×œ (××•×¤×¦×™×•× ×œ×™)">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">
                            <span>âŒ</span>
                            <span data-translate="cancel">×‘×™×˜×•×œ</span>
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <span>ğŸ’¾</span>
                            <span data-translate="save">×©××•×¨ ×©×™× ×•×™×™×</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Transactions Modal -->
        <div class="modal" id="transactionsModal" style="display: none;">
            <div class="modal-content" style="max-width: 1200px; width: 90%;">
                <div class="modal-header">
                    <h2 class="modal-title">ğŸ“Š ×ª× ×•×¢×•×ª ×× ×•×™</h2>
                    <button class="close-btn" onclick="closeTransactionsModal()">&times;</button>
                </div>
                
                <div class="alert alert-info" style="margin: 20px 0; padding: 15px; background: #d1ecf1; border-left: 4px solid #0c5460; color: #0c5460;">
                    <strong>×”×¢×¨×”:</strong> ×‘×¢×ª×™×“, ×’×™×©×” ×œ×“×•×— ×–×” ×ª×”×™×” ××•×’×‘×œ×ª ×œ××©×ª××©×™× ×¢× ×”×¨×©××•×ª ××ª××™××•×ª ×‘×œ×‘×“.
                </div>
                
                <div style="margin: 20px 0;">
                    <label>×˜×•×•×— ×ª××¨×™×›×™×:</label>
                    <input type="date" id="transStartDate" style="margin: 0 10px; padding: 5px;">
                    <label>×¢×“</label>
                    <input type="date" id="transEndDate" style="margin: 0 10px; padding: 5px;">
                    <button class="btn btn-primary" onclick="loadTransactions()">×˜×¢×Ÿ ×ª× ×•×¢×•×ª</button>
                    <button class="btn btn-secondary" onclick="exportTransactions()">ğŸ“¥ ×™×™×¦× ×œ××§×¡×œ</button>
                </div>
                
                <div id="transactionsLoading" style="display: none; text-align: center; padding: 40px;">
                    <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    <p>×˜×•×¢×Ÿ ×ª× ×•×¢×•×ª...</p>
                </div>
                
                <div id="transactionsSummary" style="display: none; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <span style="margin-right: 20px;"><strong>×¡×”"×› ×ª× ×•×¢×•×ª:</strong> <span id="totalTrans">0</span></span>
                    <span style="margin-right: 20px;"><strong>×›× ×™×¡×•×ª:</strong> <span id="totalEntries">0</span></span>
                    <span style="margin-right: 20px;"><strong>×™×¦×™××•×ª:</strong> <span id="totalExits">0</span></span>
                </div>
                
                <div id="transactionsTableContainer" style="max-height: 500px; overflow-y: auto; display: none;">
                    <table class="subscribers-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>×ª××¨×™×š ×•×©×¢×”</th>
                                <th>×¡×•×’ ×ª× ×•×¢×”</th>
                                <th>××¡×¤×¨ ×¨×›×‘</th>
                                <th>×—× ×™×•×Ÿ</th>
                                <th>×™×—×™×“×”</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                        </tbody>
                    </table>
                </div>
                
                <div id="noTransactions" style="display: none; text-align: center; padding: 40px; color: #666;">
                    <p>×œ× × ××¦××• ×ª× ×•×¢×•×ª ×‘×ª×§×•×¤×” ×”××‘×•×§×©×ª</p>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <div class="company">×©×™×™×“×˜ ××ª ×‘×›××Ÿ ×™×©×¨××œ</div>
            <div class="credit">
                × ×•×¦×¨ ×¢"×™ <span class="developer">×“×¨×•×¨ ×¤×¨×™× ×¥</span>
            </div>
            <div style="margin-top: 10px; font-size: 12px; color: #999;">
                Â© 2025 ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Mock data for demonstration - updated for new server
        const mockCompanies = [
            { id: '1000', name: '×—×‘×¨×” 1000', subscribersCount: 45 },
            { id: '2', name: '×—×‘×¨×” 2', subscribersCount: 120 },
            { id: '3', name: '×—×‘×¨×” 3', subscribersCount: 25 },
            { id: '4', name: '×—×‘×¨×” 4', subscribersCount: 30 },
        ];

        const mockSubscribers = [
            {
                companyNum: '1001',
                companyName: '2222',
                subscriberNum: '10001',
                firstName: '×“×•×“',
                lastName: '×›×”×Ÿ',
                tagNum: '20001',
                vehicle1: '1234567',
                vehicle2: '9876543',
                vehicle3: '',
                validFrom: '2024-01-01',
                validUntil: '2025-12-31',
                profile: 'regular',
                presence: true,
                lastEntry: '2025-01-13 08:30'
            },
            {
                companyNum: '1001',
                companyName: '2222',
                subscriberNum: '10002',
                firstName: '×¨×—×œ',
                lastName: '×œ×•×™',
                tagNum: '20002',
                vehicle1: '5566677',
                vehicle2: '',
                vehicle3: '',
                validFrom: '2024-06-01',
                validUntil: '2025-06-30',
                profile: 'vip',
                presence: false,
                lastEntry: '2025-01-12 17:45'
            },
            {
                companyNum: '1001',
                companyName: '2222',
                subscriberNum: '10003',
                firstName: '××©×”',
                lastName: '×¤×¨×¥',
                tagNum: 'TAG003',
                vehicle1: '1122233',
                vehicle2: '4455566',
                vehicle3: '7788899',
                validFrom: '2024-09-15',
                validUntil: '2025-09-15',
                profile: 'disabled',
                presence: true,
                lastEntry: '2025-01-13 09:15'
            }
        ];

        // Translation dictionary
        const translations = {
            he: {
                title: '××¢×¨×›×ª × ×™×”×•×œ ×× ×•×™×™ ×—× ×™×•×Ÿ',
                lang: 'English',
                accessibility: '× ×’×™×©×•×ª',
                accessibilityOptions: '××¤×©×¨×•×™×•×ª × ×’×™×©×•×ª',
                highContrast: '× ×™×’×•×“×™×•×ª ×’×‘×•×”×”',
                underlineLinks: '×”×“×’×©×ª ×§×™×©×•×¨×™×',
                focusHighlight: '×”×“×’×©×ª ×¤×•×§×•×¡',
                reset: '××™×¤×•×¡',
                selectCompany: '×‘×—×¨ ×—×‘×¨×”',
                subscribers: '×× ×•×™×™×',
                addNew: '+ ×”×•×¡×£ ×× ×•×™ ×—×“×©',
                addGuest: '+ ×”×•×¡×£ ××•×¨×—',
                export: 'ğŸ“¥ ×™×™×¦×•× ×œ××§×¡×œ',
                reloadFull: 'ğŸ”„ ×˜×¢×™× ×” ××œ××”',
                searchPlaceholder: '×—×™×¤×•×© ×œ×¤×™ ×©×, ××¡×¤×¨ ×× ×•×™, ××¡×¤×¨ ×¨×›×‘...',
                allPresence: '×”×›×œ',
                presentOnly: '× ×•×›×—×™× ×‘×œ×‘×“',
                absentOnly: '×œ× × ×•×›×—×™×',
                allDates: '×›×œ ×”×ª××¨×™×›×™×',
                validOnly: '×‘×ª×•×§×£',
                expiredOnly: '×¤×’ ×ª×•×§×£',
                expiring30: '×¤×’ ×‘×¢×•×“ 30 ×™×•×',
                expiring7: '×¤×’ ×‘×¢×•×“ 7 ×™××™×',
                regular: '×¨×’×™×œ',
                vip: 'VIP',
                disabled: '× ×›×”',
                loading: '×˜×•×¢×Ÿ × ×ª×•× ×™×...',
                companyNum: '××¡\' ×—×‘×¨×”',
                companyName: '×©× ×—×‘×¨×”',
                subscriberNum: '××¡\' ×× ×•×™',
                firstName: '×©× ×¤×¨×˜×™',
                lastName: '×©× ××©×¤×—×”',
                tagNum: '××¡\' ×ª×’',
                vehicle1: '×¨×›×‘ 1',
                vehicle2: '×¨×›×‘ 2',
                vehicle3: '×¨×›×‘ 3',
                validUntil: '×‘×ª×•×§×£ ×¢×“',
                profile: '×¤×¨×•×¤×™×œ',
                validFrom: '×ª×—×™×œ×ª ×ª×•×§×£',
                notes: '×”×¢×¨×•×ª',
                email: '××™××™×™×œ',
                ignorePresence: '×œ×œ× ×‘×“×™×§×ª × ×•×›×—×•×ª',
                presence: '× ×•×›×—×•×ª',
                lastEntry: '×›× ×™×¡×” ××—×¨×•× ×”',
                editSubscriber: '×¢×¨×™×›×ª ×× ×•×™',
                cancel: '×‘×™×˜×•×œ',
                save: '×©××•×¨',
                present: '× ×•×›×—',
                absent: '×œ× × ×•×›×—',
                subscribersText: '×× ×•×™×™×'
            },
            en: {
                title: 'Parking Subscribers Management System',
                lang: '×¢×‘×¨×™×ª',
                accessibility: 'Accessibility',
                accessibilityOptions: 'Accessibility Options',
                highContrast: 'High Contrast',
                underlineLinks: 'Underline Links',
                focusHighlight: 'Focus Highlight',
                reset: 'Reset',
                selectCompany: 'Select Company',
                subscribers: 'Subscribers',
                addNew: '+ Add New Subscriber',
                addGuest: '+ Add Guest',
                export: 'ğŸ“¥ Export to Excel',
                searchPlaceholder: 'Search by name, subscriber number, vehicle number...',
                allPresence: 'All',
                presentOnly: 'Present Only',
                absentOnly: 'Absent Only',
                allDates: 'All Dates',
                validOnly: 'Valid',
                expiredOnly: 'Expired',
                expiring30: 'Expiring in 30 days',
                expiring7: 'Expiring in 7 days',
                regular: 'Regular',
                vip: 'VIP',
                disabled: 'Disabled',
                loading: 'Loading data...',
                companyNum: 'Company No.',
                companyName: 'Company Name',
                subscriberNum: 'Subscriber No.',
                firstName: 'First Name',
                lastName: 'Last Name',
                tagNum: 'Tag No.',
                vehicle1: 'Vehicle 1',
                vehicle2: 'Vehicle 2',
                vehicle3: 'Vehicle 3',
                validUntil: 'Valid Until',
                profile: 'Profile',
                validFrom: 'Valid From',
                notes: 'Notes',
                email: 'Email',
                ignorePresence: 'Ignore Presence Check',
                presence: 'Presence',
                lastEntry: 'Last Entry',
                editSubscriber: 'Edit Subscriber',
                cancel: 'Cancel',
                save: 'Save',
                present: 'Present',
                absent: 'Absent',
                subscribersText: 'subscribers'
            }
        };

        let currentLang = 'he';
        let currentCompany = null;
        let currentSubscribers = [];
        let editingSubscriber = null;
        
        // Get user permissions from window variable (set by server)
        const getUserPermissions = () => window.userPermissions || '';
        
        // Check user permission
        // G-guest, N-New, P-profile, R-report
        function checkUserPermission(action) {
            const permissions = getUserPermissions();
            console.log(`[checkUserPermission] Checking ${action} against permissions: ${permissions}`);
            
            switch(action) {
                case 'add_subscriber':
                    return permissions.includes('N'); // New subscriber
                case 'add_guest':
                    return permissions.includes('G'); // Guest
                case 'edit_subscriber':
                    return true; // Always allow basic editing
                case 'update_profile':
                    return permissions.includes('P'); // Profile updates only
                case 'view_reports':
                    return permissions.includes('R'); // Reports only
                case 'export':
                    return true; // Export always allowed
                default:
                    return false;
            }
        }
        
        // Update button states based on permissions
        function updateButtonPermissions() {
            const permissions = getUserPermissions();
            console.log('[updateButtonPermissions] Updating buttons based on permissions:', permissions);
            
            // Add New Subscriber button
            const addNewBtn = document.querySelector('button[onclick="addNewSubscriber()"]');
            if (addNewBtn) {
                if (!permissions.includes('N')) {
                    addNewBtn.disabled = true;
                    addNewBtn.title = '××™×Ÿ ×”×¨×©××” ×œ×”×•×¡×™×£ ×× ×•×™ ×—×“×© (×“×¨×•×©×” ×”×¨×©××ª N)';
                    addNewBtn.style.opacity = '0.5';
                    addNewBtn.style.cursor = 'not-allowed';
                } else {
                    addNewBtn.disabled = false;
                    addNewBtn.title = '';
                    addNewBtn.style.opacity = '1';
                    addNewBtn.style.cursor = 'pointer';
                }
            }
            
            // Add Guest button
            const addGuestBtn = document.querySelector('button[onclick="addGuestSubscriber()"]');
            if (addGuestBtn) {
                if (!permissions.includes('G')) {
                    addGuestBtn.disabled = true;
                    addGuestBtn.title = '××™×Ÿ ×”×¨×©××” ×œ×”×•×¡×™×£ ××•×¨×— (×“×¨×•×©×” ×”×¨×©××ª G)';
                    addGuestBtn.style.opacity = '0.5';
                    addGuestBtn.style.cursor = 'not-allowed';
                } else {
                    addGuestBtn.disabled = false;
                    addGuestBtn.title = '';
                    addGuestBtn.style.opacity = '1';
                    addGuestBtn.style.cursor = 'pointer';
                }
            }
            
            // Reports button
            const reportsBtn = document.querySelector('button[onclick="openReportsModal()"]');
            if (reportsBtn) {
                if (!permissions.includes('R')) {
                    reportsBtn.disabled = true;
                    reportsBtn.title = '××™×Ÿ ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×“×•×—×•×ª (×“×¨×•×©×” ×”×¨×©××ª R)';
                    reportsBtn.style.opacity = '0.5';
                    reportsBtn.style.cursor = 'not-allowed';
                } else {
                    reportsBtn.disabled = false;
                    reportsBtn.title = '';
                    reportsBtn.style.opacity = '1';
                    reportsBtn.style.cursor = 'pointer';
                }
            }
            
            // Export button - always enabled
            const exportBtn = document.querySelector('button[onclick="exportToExcel()"]');
            if (exportBtn) {
                exportBtn.disabled = false;
                exportBtn.title = '';
                exportBtn.style.opacity = '1';
                exportBtn.style.cursor = 'pointer';
            }
        }

        // Sorting variables
        let currentSortField = null;
        let currentSortDirection = 'asc';
        
        // Initialize application
        function init() {
            loadCompanies();
            setupEventListeners();
            setupSorting();
            updateUIBasedOnPermissions();
            
            // Load saved font size
            const savedFontSize = localStorage.getItem('fontSize');
            if (savedFontSize) {
                changeFontSize(savedFontSize);
            }
            
            // Check if only one company
            if (mockCompanies.length === 1) {
                selectCompany(mockCompanies[0]);
            }
            
            // Ensure modal buttons are always visible
            ensureModalButtonsVisible();
        }
        
        // Function to ensure modal buttons remain visible
        function ensureModalButtonsVisible() {
            // Monitor the modal for changes
            const modalObserver = new MutationObserver(() => {
                const topButtons = document.querySelectorAll('.modal-actions-top .btn');
                topButtons.forEach(btn => {
                    if (btn.style.display === 'none' || btn.style.visibility === 'hidden') {
                        btn.style.display = 'inline-flex';
                        btn.style.visibility = 'visible';
                    }
                });
            });
            
            const modal = document.getElementById('editModal');
            if (modal) {
                modalObserver.observe(modal, {
                    attributes: true,
                    childList: true,
                    subtree: true,
                    attributeFilter: ['style', 'class']
                });
            }
            
            // Also check periodically
            setInterval(() => {
                const topButtons = document.querySelectorAll('.modal-actions-top .btn');
                topButtons.forEach(btn => {
                    if (btn && (btn.style.display === 'none' || btn.style.visibility === 'hidden')) {
                        btn.style.display = 'inline-flex';
                        btn.style.visibility = 'visible';
                    }
                });
            }, 500);
        }
        
        // Force show modal buttons
        function forceShowModalButtons() {
            // Get buttons
            const cancelBtn = document.getElementById('cancelTopBtn');
            const saveBtn = document.getElementById('saveTopBtn');
            const modalActions = document.querySelector('.modal-actions-top');
            
            // Force display modal actions container
            if (modalActions) {
                modalActions.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important; position: sticky !important; top: 0 !important; z-index: 100 !important;';
            }
            
            // Force display cancel button
            if (cancelBtn) {
                cancelBtn.style.cssText = 'display: inline-flex !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 1000 !important;';
                cancelBtn.removeAttribute('hidden');
                cancelBtn.removeAttribute('disabled');
            }
            
            // Force display save button
            if (saveBtn) {
                saveBtn.style.cssText = 'display: inline-flex !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 1000 !important;';
                saveBtn.removeAttribute('hidden');
                saveBtn.removeAttribute('disabled');
            }
            
            // Double check after a short delay
            setTimeout(() => {
                const btns = document.querySelectorAll('#cancelTopBtn, #saveTopBtn');
                btns.forEach(btn => {
                    if (btn) {
                        btn.style.display = 'inline-flex';
                        btn.style.visibility = 'visible';
                        btn.style.opacity = '1';
                    }
                });
            }, 100);
        }
        
        // Update UI based on user permissions
        function updateUIBasedOnPermissions() {
            // Update user role display
            const roleText = {
                'admin': '×× ×”×œ ××¢×¨×›×ª',
                'company_manager': '×× ×”×œ ×—×‘×¨×”',
                'user': '××©×ª××© ×¨×’×™×œ'
            };
            document.getElementById('userRole').textContent = roleText[userPermissions.role] || '××©×ª××©';
            
            // Hide/show buttons based on permissions
            const addButton = document.querySelector('[onclick="addNewSubscriber()"]');
            const exportButton = document.querySelector('[onclick="exportToExcel()"]');
            
            if (addButton && !userPermissions.canAddSubscriber) {
                addButton.style.display = 'none';
            }
            
            if (exportButton && !userPermissions.canExport) {
                exportButton.style.display = 'none';
            }
        }

        // Load companies
        function loadCompanies() {
            // Skip if parkingUIXML is available - it will handle everything
            if (window.parkingUIXML) {
                return;
            }
            
            const companyList = document.getElementById('companyList');
            companyList.innerHTML = '';
            
            mockCompanies.forEach(company => {
                const card = document.createElement('div');
                card.className = 'company-card';
                card.onclick = () => selectCompany(company);
                card.innerHTML = `
                    <h3>${company.name}</h3>
                    <p>${company.subscribersCount} ${translations[currentLang].subscribersText}</p>
                `;
                companyList.appendChild(card);
            });
        }

        // Select company
        function selectCompany(company) {
            // Skip if parkingUIXML is available - it will handle everything
            if (window.parkingUIXML) {
                return;
            }
            
            currentCompany = company;
            document.querySelectorAll('.company-card').forEach(card => {
                card.classList.remove('selected');
            });
            event && event.currentTarget && event.currentTarget.classList.add('selected');
            
            // Hide company selector if only one company
            if (mockCompanies.length === 1) {
                document.getElementById('companySelector').style.display = 'none';
            }
            
            // Show main content
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('companyName').textContent = `- ${company.name}`;
            
            
            // Load subscribers
            loadSubscribers();
        }

        // Load subscribers
        function loadSubscribers() {
            // Skip if parkingUIXML is available - it will handle everything
            if (window.parkingUIXML) {
                return;
            }
            
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('tableContainer').style.display = 'none';
            
            // Simulate API call
            setTimeout(() => {
                currentSubscribers = mockSubscribers.filter(s => s.companyNum === currentCompany.id);
                displaySubscribers(currentSubscribers);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('tableContainer').style.display = 'block';
            }, 500);
        }

        // Display subscribers in table
        function displaySubscribers(subscribers) {
            // Skip if parkingUIXML is available - it will handle everything
            if (window.parkingUIXML) {
                return;
            }
            
            const tbody = document.getElementById('subscribersTableBody');
            tbody.innerHTML = '';
            
            subscribers.forEach(subscriber => {
                const row = document.createElement('tr');
                row.onclick = (e) => {
                    // Don't edit if clicking on button
                    if (e.target.tagName !== 'BUTTON') {
                        editSubscriber(subscriber);
                    }
                };
                
                const validDate = new Date(subscriber.validUntil);
                const isExpired = validDate < new Date();
                
                row.innerHTML = `
                    <td>${subscriber.companyNum}</td>
                    <td>${subscriber.companyName}</td>
                    <td>${subscriber.subscriberNum}</td>
                    <td>${subscriber.firstName}</td>
                    <td>${subscriber.lastName}</td>
                    <td>${subscriber.tagNum ? `<span class="tag-badge">${subscriber.tagNum}</span>` : ''}</td>
                    <td>${subscriber.vehicle1 || ''}</td>
                    <td>${subscriber.vehicle2 || ''}</td>
                    <td>${subscriber.vehicle3 || ''}</td>
                    <td class="${isExpired ? 'status-inactive' : 'status-active'}">${formatDate(subscriber.validUntil) || ''}</td>
                    <td style="color: #888;">${subscriber.profile || ''}</td>
                    <td>${formatDate(subscriber.validFrom) || ''}</td>
                    <td style="text-align: center; font-size: 18px;">${subscriber.presence ? 'âœ…' : 'âŒ'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Edit subscriber
        async function editSubscriber(subscriber) {
            console.log('[editSubscriber] Called with subscriber:', subscriber);
            
            // Always allow viewing/editing subscriber details
            // Permission check will be done when saving (for profile updates)
            
            // IMPORTANT: Store the subscriber globally for saveSubscriber to check
            // Make sure we have a valid subscriber object
            if (!subscriber || typeof subscriber !== 'object') {
                console.error('[editSubscriber] Invalid subscriber object:', subscriber);
                showToast('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×× ×•×™', 'error');
                return;
            }
            
            window.currentEditingSubscriber = subscriber;
            editingSubscriber = subscriber;
            console.log('[editSubscriber] Set editingSubscriber:', editingSubscriber);
            console.log('[editSubscriber] Set window.currentEditingSubscriber:', window.currentEditingSubscriber);
            console.log('[editSubscriber] Subscriber number:', subscriber.subscriberNum);
            
            // CRITICAL: Store the edit mode in the modal itself
            const modal = document.getElementById('editModal');
            if (modal) {
                modal.setAttribute('data-edit-mode', 'UPDATE');
                modal.setAttribute('data-subscriber-num', subscriber.subscriberNum);
                console.log('[editSubscriber] Set modal data-edit-mode to UPDATE');
            }
            
            // Force show buttons
            forceShowModalButtons();
            
            // Don't load profiles for existing subscriber - just use what they have
            // The profile will be set from the subscriber data below
            
            // Populate form - handle company name properly
            document.getElementById('editCompanyNum').value = subscriber.companyNum;
            // Fix company name - use the correct value from subscriber
            const correctCompanyName = subscriber.companyName || subscriber.company || '';
            document.getElementById('editCompanyName').value = correctCompanyName;
            document.getElementById('editSubscriberNum').value = subscriber.subscriberNum;
            document.getElementById('editFirstName').value = subscriber.firstName;
            document.getElementById('editLastName').value = subscriber.lastName;
            document.getElementById('editTagNum').value = subscriber.tagNum || '';
            // Display vehicle numbers as they come from the server - check both vehicle and lpn fields
            document.getElementById('editVehicle1').value = subscriber.vehicle1 || subscriber.lpn1 || '';
            document.getElementById('editVehicle2').value = subscriber.vehicle2 || subscriber.lpn2 || '';
            document.getElementById('editVehicle3').value = subscriber.vehicle3 || subscriber.lpn3 || '';
            // Use xValidUntil if validUntil is empty (for dates from consumer details)
            const validFrom = subscriber.validFrom || subscriber.xValidFrom || '';
            const validUntil = subscriber.validUntil || subscriber.xValidUntil || '';
            
            console.log(`[editSubscriber] Date mapping - validFrom: ${validFrom}, validUntil: ${validUntil}`);
            
            document.getElementById('editValidFrom').value = formatDateForDisplay(validFrom) || '';
            document.getElementById('editValidUntil').value = formatDateForDisplay(validUntil) || '';
            

            
            // Remove guest mode class for regular edit
            document.getElementById('editModal').classList.remove('guest-mode');
            
            // Set profile for existing subscriber - show ONLY their profile
            const profileSelect = document.getElementById('editProfile');
            
            // Clear all options first
            profileSelect.innerHTML = '';
            
            // Add only the subscriber's profile - check various fields including identification
            const profileId = subscriber.profileId || subscriber.profile || subscriber.extCardProfile || subscriber.identification?.usageProfile?.id || '1';
            const profileName = subscriber.profileName || 
                               subscriber.identification?.usageProfile?.name ||
                               (profileId === '1' ? '×›×•×œ ×”×—× ×™×•× ×™×' : 
                                profileId === '0' ? '×¨×’×™×œ' : 
                                profileId === '2' ? '×—× ×™×•×Ÿ ×¨××©×™' :
                                `×¤×¨×•×¤×™×œ ${profileId}`);
            
            const option = document.createElement('option');
            option.value = profileId;
            option.setAttribute('data-profile-name', profileName);
            option.textContent = profileName;
            profileSelect.appendChild(option);
            profileSelect.value = profileId;
            
            // No additional fallback needed - we already handle it above
            
            // Check if user has permission to update profile
            const permissions = getUserPermissions();
            const canUpdateProfile = permissions.includes('P');
            
            profileSelect.disabled = !canUpdateProfile;
            if (!canUpdateProfile) {
            profileSelect.style.backgroundColor = '#f0f0f0';
            profileSelect.style.color = '#888';
            profileSelect.style.cursor = 'not-allowed';
            } else {
                profileSelect.style.backgroundColor = '';
                profileSelect.style.color = '';
                profileSelect.style.cursor = '';
            }
            
            // Update help text
            const profileHelpText = document.getElementById('profileHelpText');
            if (profileHelpText) {
                profileHelpText.textContent = canUpdateProfile ? '* × ×™×ª×Ÿ ×œ×¢×“×›×•×Ÿ ×¤×¨×•×¤×™×œ' : '* ×¢×“×›×•×Ÿ ×¤×¨×•×¤×™×œ ×“×•×¨×© ×”×¨×©××ª P';
                profileHelpText.style.color = canUpdateProfile ? '#666' : '#888';
            }
            
            document.getElementById('editEmail').value = subscriber.email || '';
            
            // Show modal
            document.getElementById('editModal').classList.add('show');
            
            // Ensure buttons are visible
            setTimeout(() => {
                const topButtons = document.querySelectorAll('.modal-actions-top .btn');
                topButtons.forEach(btn => {
                    btn.style.display = 'inline-flex';
                    btn.style.visibility = 'visible';
                    btn.style.opacity = '1';
                });
                
                const modalActions = document.querySelector('.modal-actions-top');
                if (modalActions) {
                    modalActions.style.display = 'flex';
                    modalActions.style.visibility = 'visible';
                    modalActions.style.opacity = '1';
                }
            }, 10);
        }

        // Add guest subscriber
        function addGuestSubscriber() {
            addNewSubscriber(true);
        }
        
        // Open reports modal
        function openReportsModal() {
            console.log('[openReportsModal] Opening reports modal');
            
            // Check user permissions
            if (!checkUserPermission('view_reports')) {
                showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×“×•×—×•×ª (×“×¨×•×©×” ×”×¨×©××ª R)', 'error');
                return;
            }
            const modal = document.getElementById('reportsModal');
            if (!modal) {
                console.log('[openReportsModal] Creating modal HTML');
                // Create modal if it doesn't exist
                const modalHtml = `
                    <div id="reportsModal" class="modal">
                        <div class="modal-content" style="max-width: 700px;">
                            <div class="modal-header">
                                <h2>×‘×—×¨ ×× ×•×™ ×œ×“×•×— ×ª× ×•×¢×•×ª</h2>
                                <button class="close-btn" onclick="closeReportsModal()">Ã—</button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group" style="position: relative;">
                                    <input type="text" id="reportSearchBox" class="form-control" 
                                           placeholder="×—×¤×© ×œ×¤×™ ×©× ××• ××¡×¤×¨ ×× ×•×™..." 
                                           oninput="filterReportSubscribers()"
                                           onkeypress="if(event.key === 'Enter') searchAndSelectSubscriber()"
                                           style="width: 100%; padding: 10px 45px 10px 10px; border-radius: 4px; border: 1px solid #ddd;">
                                    <button onclick="searchAndSelectSubscriber()" 
                                            style="position: absolute; left: 5px; top: 50%; transform: translateY(-50%); 
                                                   background: #17a2b8; color: white; border: none; border-radius: 4px; 
                                                   padding: 5px 10px; cursor: pointer;">
                                        ğŸ” ×—×¤×©
                                    </button>
                                </div>
                                <div class="subscriber-select-list" id="reportSubscriberList" 
                                     style="max-height: 400px; overflow-y: auto; margin-top: 20px;">
                                    <!-- Subscribers will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            // Load subscribers for current company
            console.log('[openReportsModal] Loading report subscribers');
            loadReportSubscribers();
            
            console.log('[openReportsModal] Showing modal');
            document.getElementById('reportsModal').classList.add('show');
        }
        
        function closeReportsModal() {
            const modal = document.getElementById('reportsModal');
            if (modal) modal.classList.remove('show');
        }
        
        function loadReportSubscribers() {
            console.log('[loadReportSubscribers] Starting to load subscribers for reports');
            const list = document.getElementById('reportSubscriberList');
            if (!list) {
                console.error('[loadReportSubscribers] List element not found');
                return;
            }
            
            // Get subscribers from current company only
            let subscribers = [];
            
            // Try to get from parkingUIXML first (most reliable)
            if (window.parkingUIXML && window.parkingUIXML.subscribers) {
                subscribers = window.parkingUIXML.subscribers;
                console.log('[loadReportSubscribers] Using parkingUIXML.subscribers:', subscribers.length, 'subscribers');
            } else if (currentSubscribers && currentSubscribers.length > 0) {
                subscribers = currentSubscribers;
                console.log('[loadReportSubscribers] Using currentSubscribers:', subscribers.length, 'subscribers');
            } else {
                console.warn('[loadReportSubscribers] No subscribers found');
            }
            
            // Get current company
            let currentCompanyNum = null;
            if (window.parkingUIXML && window.parkingUIXML.currentContract) {
                currentCompanyNum = window.parkingUIXML.currentContract.id;
                console.log('[loadReportSubscribers] Current company:', currentCompanyNum);
            } else if (currentCompany) {
                currentCompanyNum = currentCompany.id;
                console.log('[loadReportSubscribers] Current company (fallback):', currentCompanyNum);
            }
            
            console.log('[loadReportSubscribers] Total subscribers before filtering:', subscribers.length);
            
            list.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; text-align: right;">××¡×¤×¨ ×× ×•×™</th>
                            <th style="padding: 10px; text-align: right;">×©×</th>
                            <th style="padding: 10px; text-align: right;">×¨×›×‘</th>
                            <th style="padding: 10px; text-align: center;">×¤×¢×•×œ×”</th>
                        </tr>
                    </thead>
                    <tbody id="reportSubscriberTableBody">
                        ${subscribers.map(s => `
                            <tr class="report-subscriber-row" data-name="${s.name || ''}" data-id="${s.subscriberNum}">
                                <td style="padding: 8px; border-bottom: 1px solid #eee;">${s.subscriberNum}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee;">${s.name || '-'}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee;">${s.vehicle1 || '-'}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">
                                    <button class="btn btn-sm btn-info" 
                                            onclick="selectSubscriberForReport('${currentCompanyNum || s.companyNum}', '${s.subscriberNum}')"
                                            style="padding: 5px 15px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        ×‘×—×¨
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            console.log('[loadReportSubscribers] Loaded', subscribers.length, 'subscribers to report list');
        }
        
        function filterReportSubscribers() {
            const searchText = document.getElementById('reportSearchBox').value.toLowerCase();
            const rows = document.querySelectorAll('.report-subscriber-row');
            console.log('[filterReportSubscribers] Filtering with text:', searchText, 'Total rows:', rows.length);
            
            let visibleCount = 0;
            rows.forEach(row => {
                const name = (row.getAttribute('data-name') || '').toLowerCase();
                const id = (row.getAttribute('data-id') || '').toLowerCase();
                
                if (name.includes(searchText) || id.includes(searchText)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            console.log('[filterReportSubscribers] Visible rows after filter:', visibleCount);
        }
        
        function searchAndSelectSubscriber() {
            const searchBox = document.getElementById('reportSearchBox');
            const searchText = searchBox.value.trim();
            
            if (!searchText) {
                showToast('âš ï¸ ×™×© ×œ×”×–×™×Ÿ ××¡×¤×¨ ×× ×•×™ ××• ×©× ×œ×—×™×¤×•×©', 'warning');
                return;
            }
            
            // Try to find exact match by subscriber number first
            const rows = document.querySelectorAll('.report-subscriber-row');
            let foundRow = null;
            
            rows.forEach(row => {
                const id = row.getAttribute('data-id');
                const name = row.getAttribute('data-name');
                
                // Exact match by subscriber number
                if (id === searchText) {
                    foundRow = row;
                    return;
                }
                
                // Partial match by name (if no exact ID match found)
                if (!foundRow && name.toLowerCase().includes(searchText.toLowerCase())) {
                    foundRow = row;
                }
            });
            
            if (foundRow) {
                // Highlight the found row
                rows.forEach(r => r.style.background = '');
                foundRow.style.background = '#e3f2fd';
                
                // Scroll to the found row
                foundRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // If exact match, auto-select
                const id = foundRow.getAttribute('data-id');
                if (id === searchText) {
                    const button = foundRow.querySelector('button');
                    if (button) button.click();
                }
            } else {
                showToast('âš ï¸ ×œ× × ××¦× ×× ×•×™ ××ª××™×', 'warning');
            }
        }
        
        function selectSubscriberForReport(companyNum, subscriberNum) {
            console.log('[selectSubscriberForReport] Selected:', { companyNum, subscriberNum });
            closeReportsModal();
            
            // Call viewTransactions to show the report
            viewTransactions(companyNum, subscriberNum);
        }
        
                // Store current report subscriber
        let currentReportSubscriber = null;
        
        // View transactions report for a subscriber
        async function viewTransactions(companyNum, subscriberNum) {
            console.log('[viewTransactions] Loading transactions for subscriber:', subscriberNum);
            console.log('[viewTransactions] Company:', companyNum);
            
            // Store subscriber number for later use
            currentReportSubscriber = subscriberNum;
            
            // Show loading
            showToast('ğŸ”„ ×˜×•×¢×Ÿ ×“×•×— ×ª× ×•×¢×•×ª...', 'info');
            
            // Create modal for report
            let modal = document.getElementById('transactionsModal');
            if (!modal) {
                const modalHtml = `
                    <div id="transactionsModal" class="modal">
                        <div class="modal-content" style="max-width: 900px;">
                            <div class="modal-header">
                                <h2 id="reportTitle">×“×•×— ×ª× ×•×¢×•×ª</h2>
                                <button class="close-btn" onclick="closeTransactionsModal()">Ã—</button>
                            </div>
                            <div class="modal-body">
                                <div class="report-filters" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                                    <div>
                                        <label>××ª××¨×™×š:</label>
                                        <input type="date" id="reportMinDate" style="padding: 5px;">
                                    </div>
                                    <div>
                                        <label>×¢×“ ×ª××¨×™×š:</label>
                                        <input type="date" id="reportMaxDate" style="padding: 5px;">
                                    </div>
                                    <button class="btn btn-primary" onclick="refreshReport()">ğŸ”„ ×¨×¢× ×Ÿ</button>
                                    <button class="btn btn-success" onclick="exportReportToCSV()">ğŸ“¥ ×™×™×¦× ×œ××§×¡×œ</button>
                                </div>
                                <div id="reportContent" style="max-height: 500px; overflow-y: auto;">
                                    <div style="text-align: center; padding: 40px;">
                                        <div class="spinner"></div>
                                        <p>×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                modal = document.getElementById('transactionsModal');
            }
            
            // Update title
            document.getElementById('reportTitle').textContent = `×“×•×— ×ª× ×•×¢×•×ª - ×× ×•×™ ${subscriberNum}`;
            
            // Show modal
            modal.classList.add('show');
            
            // Set default dates (last month)
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            
            document.getElementById('reportMinDate').valueAsDate = lastMonth;
            document.getElementById('reportMaxDate').valueAsDate = today;
            
            // Load report data
            try {
                const ui = window.parkingUIXML || window.parkingUI;
                if (!ui || !ui.getSubscriberReport) {
                    throw new Error('Report function not available');
                }
                
                // Format dates for API
                const minDate = lastMonth.toISOString().split('T')[0];
                const maxDate = today.toISOString().split('T')[0];
                
                const result = await ui.getSubscriberReport(subscriberNum, minDate, maxDate);
                
                if (result.success) {
                    displayTransactionsReport(result.data, result.summary);
            } else {
                    throw new Error(result.error || 'Failed to load report');
                }
            } catch (error) {
                console.error('[viewTransactions] Error:', error);
                document.getElementById('reportContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: red;">
                        âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×•×—: ${error.message}
                    </div>
                `;
                showToast('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×•×—', 'error');
            }
        }
        
        function displayTransactionsReport(transactions, summary) {
            const content = document.getElementById('reportContent');
            
            if (!transactions || transactions.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="font-size: 18px; color: #666;">×œ× × ××¦××• ×ª× ×•×¢×•×ª ×œ×ª×§×•×¤×” ×”××‘×•×§×©×ª</p>
                        <p style="font-size: 14px; color: #999; margin-top: 10px;">× ×¡×” ×œ×©× ×•×ª ××ª ×˜×•×•×— ×”×ª××¨×™×›×™× ××• ×‘×“×•×§ ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="padding: 10px; background: #f0f0f0; margin-bottom: 10px;">
                    <strong>×¡×”"×› ×ª× ×•×¢×•×ª:</strong> ${summary.total} | 
                    <strong>×¡×”"×› ×¡×›×•×:</strong> â‚ª${summary.totalAmount.toFixed(2)}
                </div>
                <table class="subscribers-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>×ª××¨×™×š ×•×©×¢×”</th>
                            <th>×¡×•×’ ×¤×¢×•×œ×”</th>
                            <th>×›× ×™×¡×”</th>
                            <th>×™×¦×™××”</th>
                            <th>××›×©×™×¨</th>
                            <th>×¡×›×•×</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            transactions.forEach(trans => {
                html += `
                    <tr>
                        <td>${trans.date}</td>
                        <td>${trans.type}</td>
                        <td>${trans.entrance}</td>
                        <td>${trans.exit}</td>
                        <td>${trans.device}</td>
                        <td>${trans.amount}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            content.innerHTML = html;
        }
        
        function closeTransactionsModal() {
            const modal = document.getElementById('transactionsModal');
            if (modal) modal.classList.remove('show');
        }
        
        async function refreshReport() {
            if (!currentReportSubscriber) {
                showToast('×œ× × ×‘×—×¨ ×× ×•×™', 'error');
                return;
            }
            
            const minDate = document.getElementById('reportMinDate').value;
            const maxDate = document.getElementById('reportMaxDate').value;
            
            document.getElementById('reportContent').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p>×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
                </div>
            `;
            
            try {
                const ui = window.parkingUIXML || window.parkingUI;
                const result = await ui.getSubscriberReport(currentReportSubscriber, minDate, maxDate);
                
                if (result.success) {
                    displayTransactionsReport(result.data, result.summary);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                document.getElementById('reportContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: red;">
                        âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×•×—: ${error.message}
                    </div>
                `;
            }
        }
        
        function exportReportToCSV() {
            // Get current displayed data
            const table = document.querySelector('#reportContent table');
            if (!table) {
                showToast('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×', 'warning');
                return;
            }
            
            // Create CSV content
            let csv = '\ufeff'; // BOM for Hebrew
            csv += '×ª××¨×™×š ×•×©×¢×”,×¡×•×’ ×¤×¢×•×œ×”,×›× ×™×¡×”,×™×¦×™××”,××›×©×™×¨,×¡×›×•×\n';
            
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => `"${cell.textContent}"`).join(',');
                csv += rowData + '\n';
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `report_${currentReportSubscriber}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('âœ… ×”×“×•×— ×™×•×¦× ×‘×”×¦×œ×—×”', 'success');
        }
        
        // Guest date handlers for week limitation
        let guestDateChangeHandler = null;
        
        function setupGuestDateHandlers() {
            const validFromInput = document.getElementById('editValidFrom');
            const validUntilInput = document.getElementById('editValidUntil');
            
            // Handler function for date changes
            guestDateChangeHandler = function() {
                const fromValue = validFromInput.value;
                if (!fromValue) return;
                
                // Parse the date (DD/MM/YYYY format)
                const parts = fromValue.split('/');
                if (parts.length !== 3) return;
                
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // JavaScript months are 0-based
                const year = parseInt(parts[2]);
                
                if (isNaN(day) || isNaN(month) || isNaN(year)) return;
                
                const fromDate = new Date(year, month, day);
                
                // Get day of week (0 = Sunday, 6 = Saturday)
                const dayOfWeek = fromDate.getDay();
                
                // Calculate days until Saturday (end of week)
                const daysUntilSaturday = (6 - dayOfWeek + 7) % 7 || 7; // If it's Saturday, set to same day
                
                // Calculate end date (max Saturday of same week)
                const maxEndDate = new Date(fromDate);
                maxEndDate.setDate(fromDate.getDate() + daysUntilSaturday);
                
                // Format the date back to DD/MM/YYYY
                const endDay = String(maxEndDate.getDate()).padStart(2, '0');
                const endMonth = String(maxEndDate.getMonth() + 1).padStart(2, '0');
                const endYear = maxEndDate.getFullYear();
                
                // Set the valid until date to the same week's Saturday
                validUntilInput.value = `${endDay}/${endMonth}/${endYear}`;
                
                // Add a help text about the week limitation
                let helpText = document.getElementById('guestWeekHelp');
                if (!helpText) {
                    helpText = document.createElement('small');
                    helpText.id = 'guestWeekHelp';
                    helpText.style.color = '#17a2b8';
                    helpText.style.display = 'block';
                    helpText.style.marginTop = '5px';
                    validUntilInput.parentElement.appendChild(helpText);
                }
                helpText.textContent = `* ××•×¨×— ××•×’×‘×œ ×œ×©×‘×•×¢ ×”× ×•×›×—×™ (×¢×“ ×™×•× ×©×‘×ª ${endDay}/${endMonth})`;
            };
            
            // Add event listener
            validFromInput.addEventListener('change', guestDateChangeHandler);
            validFromInput.addEventListener('blur', guestDateChangeHandler);
            
            // Also limit the until date input
            validUntilInput.addEventListener('change', function() {
                const fromValue = validFromInput.value;
                const untilValue = validUntilInput.value;
                
                if (!fromValue || !untilValue) return;
                
                // Parse both dates
                const fromParts = fromValue.split('/');
                const untilParts = untilValue.split('/');
                
                if (fromParts.length !== 3 || untilParts.length !== 3) return;
                
                const fromDate = new Date(
                    parseInt(fromParts[2]), 
                    parseInt(fromParts[1]) - 1, 
                    parseInt(fromParts[0])
                );
                
                const untilDate = new Date(
                    parseInt(untilParts[2]), 
                    parseInt(untilParts[1]) - 1, 
                    parseInt(untilParts[0])
                );
                
                // Calculate the Saturday of the from date's week
                const dayOfWeek = fromDate.getDay();
                const daysUntilSaturday = (6 - dayOfWeek + 7) % 7 || 7;
                const maxEndDate = new Date(fromDate);
                maxEndDate.setDate(fromDate.getDate() + daysUntilSaturday);
                
                // If the selected until date is after the week's Saturday, reset it
                if (untilDate > maxEndDate) {
                    const endDay = String(maxEndDate.getDate()).padStart(2, '0');
                    const endMonth = String(maxEndDate.getMonth() + 1).padStart(2, '0');
                    const endYear = maxEndDate.getFullYear();
                    validUntilInput.value = `${endDay}/${endMonth}/${endYear}`;
                    
                    showToast('âš ï¸ ××•×¨×— ××•×’×‘×œ ×œ×©×‘×•×¢ ×”× ×•×›×—×™ ×‘×œ×‘×“', 'warning');
                }
            });
            
            // Trigger initial calculation
            if (validFromInput.value) {
                guestDateChangeHandler();
            }
        }
        
        function removeGuestDateHandlers() {
            const validFromInput = document.getElementById('editValidFrom');
            const validUntilInput = document.getElementById('editValidUntil');
            
            // Remove event listeners
            if (guestDateChangeHandler) {
                validFromInput.removeEventListener('change', guestDateChangeHandler);
                validFromInput.removeEventListener('blur', guestDateChangeHandler);
            }
            
            // Remove help text
            const helpText = document.getElementById('guestWeekHelp');
            if (helpText) {
                helpText.remove();
            }
            
            // Clone and replace to remove all event listeners
            const newUntilInput = validUntilInput.cloneNode(true);
            validUntilInput.parentNode.replaceChild(newUntilInput, validUntilInput);
        }
        
        // Add new subscriber
        async function addNewSubscriber(isGuest = false) {
            // Check user permissions
            const requiredPermission = isGuest ? 'add_guest' : 'add_subscriber';
            if (!checkUserPermission(requiredPermission)) {
                const message = isGuest ? 
                    '××™×Ÿ ×œ×š ×”×¨×©××” ×œ×”×•×¡×™×£ ××•×¨×—×™× (×“×¨×•×©×” ×”×¨×©××ª G)' : 
                    '××™×Ÿ ×œ×š ×”×¨×©××” ×œ×”×•×¡×™×£ ×× ×•×™×™× ×—×“×©×™× (×“×¨×•×©×” ×”×¨×©××ª N)';
                showToast(message, 'error');
                return;
            }
            
            // Get current company from parkingUIXML if available, otherwise use global
            let companyInfo = currentCompany;
            if (window.parkingUIXML && window.parkingUIXML.currentContract) {
                companyInfo = window.parkingUIXML.currentContract;
            }
            
            if (!companyInfo) {
                showToast('âš ï¸ ×™×© ×œ×‘×—×•×¨ ×—×‘×¨×” ×ª×—×™×œ×”', 'error');
                return;
            }
            
            // Load usage profiles from server if available (new subscriber - enabled)
            if (window.parkingUIXML && window.parkingUIXML.loadUsageProfiles) {
                await window.parkingUIXML.loadUsageProfiles(true); // true = new subscriber
            }
            
            // Get dates
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            let startDateStr, defaultEndDateStr;
            
            if (isGuest) {
                // Guest - start today, end on Saturday of current week
                startDateStr = formatDateForDisplay(today.toISOString().split('T')[0]);
                
                // Calculate end of week (Saturday)
                const dayOfWeek = today.getDay();
                const daysUntilSaturday = (6 - dayOfWeek + 7) % 7 || 7; // If it's Saturday, use next Saturday
                const saturday = new Date(today);
                saturday.setDate(today.getDate() + daysUntilSaturday);
                defaultEndDateStr = formatDateForDisplay(saturday.toISOString().split('T')[0]);
            } else {
                // Regular subscriber - start tomorrow
                startDateStr = formatDateForDisplay(tomorrow.toISOString().split('T')[0]);
                // Regular subscriber - until end of current year
                const currentYear = new Date().getFullYear();
                defaultEndDateStr = `31/12/${currentYear}`;
            }
            
            editingSubscriber = null; // New subscriber
            window.currentEditingSubscriber = null; // Clear global reference for new subscriber
            console.log('[addNewSubscriber] Cleared both editingSubscriber and window.currentEditingSubscriber for new subscriber');
            
            // CRITICAL: Store the edit mode in the modal itself
            const modal = document.getElementById('editModal');
            if (modal) {
                modal.setAttribute('data-edit-mode', 'new');
                modal.removeAttribute('data-subscriber-num');
                console.log('[addNewSubscriber] Set modal data-edit-mode to NEW');
            }
            
            // Force show buttons
            forceShowModalButtons();
            
            // Clear form
            document.getElementById('editCompanyNum').value = companyInfo.id || '';
            document.getElementById('editCompanyName').value = companyInfo.name || companyInfo.companyName || '';
            // Leave subscriber number empty - will be calculated when saving
            document.getElementById('editSubscriberNum').value = '';
            document.getElementById('editSubscriberNum').readOnly = true;
            document.getElementById('editSubscriberNum').placeholder = isGuest ? '×™×•×¦×¨ ××•×˜×•××˜×™×ª (40001+)' : '×™×•×¦×¨ ××•×˜×•××˜×™×ª';
            document.getElementById('editFirstName').value = '';
            document.getElementById('editLastName').value = '';
            // Don't auto-generate tag number - user will enter manually
            document.getElementById('editTagNum').value = '';
            document.getElementById('editTagNum').readOnly = false; // Allow editing tag for new subscribers
            document.getElementById('editTagNum').style.backgroundColor = '';
            document.getElementById('editTagNum').style.cursor = '';
            // tagHelpText was removed
            document.getElementById('editVehicle1').value = '';
            document.getElementById('editVehicle2').value = '';
            document.getElementById('editVehicle3').value = '';
            document.getElementById('editValidFrom').value = startDateStr;
            document.getElementById('editValidUntil').value = defaultEndDateStr;
            // Profile will be set by loadUsageProfiles based on company profiles
            // document.getElementById('editProfile').value = '1'; // Will be set automatically
            document.getElementById('editEmail').value = '';
            
            // If guest, disable vehicle 2 and 3
            if (isGuest) {
                document.getElementById('editVehicle2').disabled = true;
                document.getElementById('editVehicle3').disabled = true;
                
                // Add guest mode indicator to modal
                document.getElementById('editModal').classList.add('guest-mode');
                
                // For guest - profile can be selected but default to 2
                const profileSelect = document.getElementById('editProfile');
                // If profile 2 exists, select it
                for (let i = 0; i < profileSelect.options.length; i++) {
                    if (profileSelect.options[i].value === '2') {
                        profileSelect.value = '2';
                        break;
                    }
                }
                
                // Guest can choose profile but defaults to 2
                profileSelect.disabled = false;
                
                // Update help text for guest
                const profileHelpText = document.getElementById('profileHelpText');
                if (profileHelpText) {
                    profileHelpText.textContent = '* ××•×¨×— - ×‘×¨×™×¨×ª ××—×“×œ ×¤×¨×•×¤×™×œ 2';
                    profileHelpText.style.color = '#666';
                }
                
                // Setup guest date handlers for week limitation
                setupGuestDateHandlers();
            } else {
                document.getElementById('editVehicle2').disabled = false;
                document.getElementById('editVehicle3').disabled = false;
                // Keep subscriber number readonly - always auto-generated
                document.getElementById('editSubscriberNum').readOnly = true;
                
                // Remove guest mode indicator
                document.getElementById('editModal').classList.remove('guest-mode');
                
                // Remove guest date handlers
                removeGuestDateHandlers();
                
                // New subscriber can always choose profile
                const profileSelect = document.getElementById('editProfile');
                profileSelect.disabled = false;
                profileSelect.style.backgroundColor = '';
                profileSelect.style.color = '';
                profileSelect.style.cursor = '';
                
                // Update help text for new subscriber
                const profileHelpText = document.getElementById('profileHelpText');
                if (profileHelpText) {
                    profileHelpText.textContent = '* ×‘×—×¨ ×¤×¨×•×¤×™×œ ×œ×× ×•×™ ×”×—×“×©';
                    profileHelpText.style.color = '#666';
                }
            }
            
            // Show modal
            document.getElementById('editModal').classList.add('show');
            
            // Ensure buttons are visible
            setTimeout(() => {
                const topButtons = document.querySelectorAll('.modal-actions-top .btn');
                topButtons.forEach(btn => {
                    btn.style.display = 'inline-flex';
                    btn.style.visibility = 'visible';
                    btn.style.opacity = '1';
                });
                
                const modalActions = document.querySelector('.modal-actions-top');
                if (modalActions) {
                    modalActions.style.display = 'flex';
                    modalActions.style.visibility = 'visible';
                    modalActions.style.opacity = '1';
                }
            }, 10);
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('editModal');
            if (modal && modal.classList.contains('show')) {
                modal.classList.remove('show');
                editingSubscriber = null;
                window.currentEditingSubscriber = null;  // Clear global reference too
                
                // Clear modal data attributes
                modal.removeAttribute('data-edit-mode');
                modal.removeAttribute('data-subscriber-num');
                
                console.log('[closeModal] Cleared both editingSubscriber and window.currentEditingSubscriber');
                console.log('[closeModal] Cleared modal data attributes');
            }
        }
        
        // Function to reload full data for large companies
        async function reloadFullData() {
            const ui = window.parkingUIXML || window.parkingUI;
            if (!ui || !ui.currentContract) {
                alert('×× × ×‘×—×¨ ×—×‘×¨×” ×ª×—×™×œ×”');
                return;
            }
            
            // Show loading notification
            ui.showNotification('ğŸ”„ ×˜×•×¢×Ÿ ××ª ×›×œ × ×ª×•× ×™ ×”×× ×•×™×™×...', 'info');
            
            try {
                // Force reload with full details
                await ui.loadSubscribers(true); // Force full reload
                ui.showNotification('âœ… ×›×œ ×”× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×”', 'success');
            } catch (error) {
                console.error('Error reloading full data:', error);
                ui.showNotification('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×', 'error');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            document.getElementById('searchBox').addEventListener('input', filterSubscribers);
            
            // Filter listeners - trigger filtering when changed
            document.getElementById('filterPresence').addEventListener('change', () => {
                filterSubscribers();
            });
            
            document.getElementById('filterDate').addEventListener('change', () => {
                filterSubscribers();
            });
            
            // Edit form submit
            document.getElementById('editForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSubscriber();
            });
            
            // Close modal on outside click
            // Modal backdrop click to close - fixed to prevent accidental closing
            const editModal = document.getElementById('editModal');
            if (editModal) {
                editModal.addEventListener('click', function(e) {
                    // Only close if clicking on the backdrop itself, not on modal content
                    if (e.target === this && e.target.id === 'editModal') {
                        closeModal();
                    }
                });
            }
        }

        // Filter subscribers
        function filterSubscribers() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const presenceFilter = document.getElementById('filterPresence').value;
            const dateFilter = document.getElementById('filterDate').value;
            
            // Get subscribers from UI integration - includes full details
            const ui = window.parkingUIXML || window.parkingUI;
            let filtered = ui && ui.subscribers ? ui.subscribers : currentSubscribers;
            
            // Search filter
            if (searchTerm) {
                filtered = filtered.filter(s => {
                    const firstName = (s.firstName || '').toLowerCase();
                    const lastName = (s.lastName || '').toLowerCase();
                    const subscriberNum = (s.subscriberNum || '').toString();
                    const vehicle1 = (s.vehicle1 || s.lpn1 || '');
                    const vehicle2 = (s.vehicle2 || s.lpn2 || '');
                    const vehicle3 = (s.vehicle3 || s.lpn3 || '');
                    const tagNum = (s.tagNum || s.cardno || '').toLowerCase();
                    
                    return firstName.includes(searchTerm) ||
                           lastName.includes(searchTerm) ||
                           subscriberNum.includes(searchTerm) ||
                           vehicle1.includes(searchTerm) ||
                           vehicle2.includes(searchTerm) ||
                           vehicle3.includes(searchTerm) ||
                           tagNum.includes(searchTerm);
                });
            }
            
            // Presence filter
            if (presenceFilter) {
                filtered = filtered.filter(s => {
                    if (presenceFilter === 'present') return s.presence === true;
                    if (presenceFilter === 'absent') return s.presence === false;
                    return true;
                });
            }
            
            // Date filter
            if (dateFilter) {
                const now = new Date();
                filtered = filtered.filter(s => {
                    const validDate = new Date(s.validUntil);
                    const daysUntilExpiry = Math.floor((validDate - now) / (1000 * 60 * 60 * 24));
                    
                    switch(dateFilter) {
                        case 'valid':
                            return validDate >= now;
                        case 'expired':
                            return validDate < now;
                        case 'expiring30':
                            return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
                        case 'expiring7':
                            return daysUntilExpiry >= 0 && daysUntilExpiry <= 7;
                        default:
                            return true;
                    }
                });
            }
            
            // Apply sorting if active
            if (currentSortField) {
                filtered = sortSubscribersArray(filtered);
            }
            
            displaySubscribers(filtered);
        }
        
        // Helper function to sort subscribers array
        function sortSubscribersArray(subscribers) {
            if (!currentSortField || !subscribers) return subscribers;
            
            return [...subscribers].sort((a, b) => {
                let aVal = a[currentSortField];
                let bVal = b[currentSortField];
                
                // Handle dates
                if (currentSortField === 'validUntil' || currentSortField === 'validFrom') {
                    aVal = new Date(aVal || '1900-01-01');
                    bVal = new Date(bVal || '1900-01-01');
                }
                
                // Handle presence (boolean)
                if (currentSortField === 'presence') {
                    aVal = aVal ? 1 : 0;
                    bVal = bVal ? 1 : 0;
                }
                
                // Handle numbers
                if (!isNaN(aVal) && !isNaN(bVal)) {
                    aVal = Number(aVal);
                    bVal = Number(bVal);
                }
                
                // Handle null/undefined
                if (aVal === null || aVal === undefined) aVal = '';
                if (bVal === null || bVal === undefined) bVal = '';
                
                // Compare
                if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        // Setup sorting on headers
        function setupSorting() {
            const sortableHeaders = document.querySelectorAll('.sortable');
            sortableHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const field = this.getAttribute('data-sort');
                    
                    // Reset all headers
                    sortableHeaders.forEach(h => {
                        h.classList.remove('sort-asc', 'sort-desc');
                        const icon = h.querySelector('.sort-icon');
                        if (icon) icon.innerHTML = 'â‡…';
                    });
                    
                    // Update sort direction
                    if (currentSortField === field) {
                        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSortField = field;
                        currentSortDirection = 'asc';
                    }
                    
                    // Update header visual
                    this.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                    
                    // Update sort icon
                    const icon = this.querySelector('.sort-icon');
                    if (icon) {
                        icon.innerHTML = currentSortDirection === 'asc' ? 'â†‘' : 'â†“';
                    }
                    
                    // Sort and redisplay
                    sortAndDisplaySubscribers();
                });
            });
        }
        
        // Sort and display subscribers
        function sortAndDisplaySubscribers() {
            // Just call filter which will apply sorting too
            filterSubscribers();
        }
        
        // Get filtered subscribers (helper for sorting)
        function getFilteredSubscribers() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const presenceFilter = document.getElementById('filterPresence').value;
            const dateFilter = document.getElementById('filterDate').value;
            
            // Get subscribers from UI integration - includes full details
            const ui = window.parkingUIXML || window.parkingUI;
            let filtered = ui && ui.subscribers ? ui.subscribers : currentSubscribers;
            
            // Apply same filters as filterSubscribers
            if (searchTerm) {
                filtered = filtered.filter(s => {
                    const firstName = (s.firstName || '').toLowerCase();
                    const lastName = (s.lastName || '').toLowerCase();
                    const subscriberNum = (s.subscriberNum || '').toString();
                    const vehicle1 = (s.vehicle1 || s.lpn1 || '');
                    const vehicle2 = (s.vehicle2 || s.lpn2 || '');
                    const vehicle3 = (s.vehicle3 || s.lpn3 || '');
                    const tagNum = (s.tagNum || s.cardno || '').toLowerCase();
                    
                    return firstName.includes(searchTerm) ||
                           lastName.includes(searchTerm) ||
                           subscriberNum.includes(searchTerm) ||
                           vehicle1.includes(searchTerm) ||
                           vehicle2.includes(searchTerm) ||
                           vehicle3.includes(searchTerm) ||
                           tagNum.includes(searchTerm);
                });
            }
            
            if (presenceFilter) {
                filtered = filtered.filter(s => {
                    if (presenceFilter === 'present') return s.presence === true;
                    if (presenceFilter === 'absent') return s.presence === false;
                    return true;
                });
            }
            
            if (dateFilter) {
                const now = new Date();
                filtered = filtered.filter(s => {
                    const validDate = new Date(s.validUntil);
                    const daysUntilExpiry = Math.floor((validDate - now) / (1000 * 60 * 60 * 24));
                    
                    switch(dateFilter) {
                        case 'valid':
                            return validDate >= now;
                        case 'expired':
                            return validDate < now;
                        case 'expiring30':
                            return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
                        case 'expiring7':
                            return daysUntilExpiry >= 0 && daysUntilExpiry <= 7;
                        default:
                            return true;
                    }
                });
            }
            
            return filtered;
        }

        // Save subscriber
        async function saveSubscriber() {
            // Check if we have the UI integration
            if (window.parkingUIXML || window.parkingUI) {
                const uiIntegration = window.parkingUIXML || window.parkingUI;
                
                // Debug logging
                console.log('[saveSubscriber] CRITICAL CHECK - editingSubscriber:', editingSubscriber);
                console.log('[saveSubscriber] CRITICAL CHECK - window.currentEditingSubscriber:', window.currentEditingSubscriber);
                console.log('[saveSubscriber] typeof editingSubscriber:', typeof editingSubscriber);
                console.log('[saveSubscriber] typeof window.currentEditingSubscriber:', typeof window.currentEditingSubscriber);
                
                // Use both local and global to ensure we have the right value
                const currentlyEditing = editingSubscriber || window.currentEditingSubscriber;
                console.log('[saveSubscriber] currentlyEditing:', currentlyEditing);
                
                // Extra validation
                const subscriberNumFromForm = document.getElementById('editSubscriberNum').value;
                console.log('[saveSubscriber] Subscriber number from form:', subscriberNumFromForm);
                
                // If we have a subscriber number in the form and it's not empty, it's definitely an update
                const isDefinitelyUpdate = subscriberNumFromForm && subscriberNumFromForm !== '' && subscriberNumFromForm !== '0';
                console.log('[saveSubscriber] isDefinitelyUpdate (has subscriber number):', isDefinitelyUpdate);
                
                // ULTIMATE FIX: Check the modal's data attribute for edit mode
                const modal = document.getElementById('editModal');
                const modalEditMode = modal ? modal.getAttribute('data-edit-mode') : null;
                const modalSubscriberNum = modal ? modal.getAttribute('data-subscriber-num') : null;
                console.log('[saveSubscriber] Modal edit mode:', modalEditMode, 'Modal subscriber num:', modalSubscriberNum);
                
                // Determine if new based on multiple factors
                let isNew = false;
                
                // PRIMARY CHECK: If we have a subscriber number, it's ALWAYS an update
                if (isDefinitelyUpdate) {
                    isNew = false;
                    console.log('[saveSubscriber] Has subscriber number - DEFINITELY UPDATE');
                } else if (modalEditMode === 'UPDATE' || modalEditMode === 'update') {
                    isNew = false;
                    console.log('[saveSubscriber] Modal says UPDATE');
                } else if (currentlyEditing) {
                    isNew = false;
                    console.log('[saveSubscriber] Has editing context - UPDATE');
                } else if (modalEditMode === 'NEW' || modalEditMode === 'new') {
                    isNew = true;
                    console.log('[saveSubscriber] Modal says NEW');
                } else {
                    // If no clear indication but we have a subscriber num, it's update
                    if (subscriberNumFromForm && subscriberNumFromForm !== '' && subscriberNumFromForm !== '0') {
                        isNew = false;
                        console.log('[saveSubscriber] No mode but has subscriber number - UPDATE');
                    } else {
                        isNew = true;
                        console.log('[saveSubscriber] No clear indication - assuming NEW');
                    }
                }
                
                console.log('[saveSubscriber] FINAL isNew decision:', isNew);
                
                // Collect form data
                const formData = {
                    companyNum: document.getElementById('editCompanyNum').value,
                    companyName: document.getElementById('editCompanyName').value,
                    subscriberNum: document.getElementById('editSubscriberNum').value || '',  // Empty string for auto-generation
                    firstName: document.getElementById('editFirstName').value.trim() || '',  // Allow empty first name
                    lastName: document.getElementById('editLastName').value.trim(),  // Required field
                    tagNum: document.getElementById('editTagNum').value || '',
                    // Clean vehicle numbers - remove dashes
                    vehicle1: (document.getElementById('editVehicle1').value || '').replace(/-/g, ''),
                    vehicle2: (document.getElementById('editVehicle2').value || '').replace(/-/g, ''),
                    vehicle3: (document.getElementById('editVehicle3').value || '').replace(/-/g, ''),
                    validFrom: convertDateToServer(document.getElementById('editValidFrom').value.trim()),
                    validUntil: convertDateToServer(document.getElementById('editValidUntil').value.trim()),
                    profile: document.getElementById('editProfile').selectedOptions[0]?.getAttribute('data-profile-name') || 'regular',
                    profileId: document.getElementById('editProfile').value || '1',
                    email: document.getElementById('editEmail').value || '',
                    isNew: isNew,  // Use the calculated value that considers both editing state and form data
                    // Check if creating a guest (first name is "××•×¨×—" or modal has guest indicator)
                    isGuest: document.getElementById('editFirstName').value.trim() === '××•×¨×—' || 
                            document.getElementById('editModal')?.classList.contains('guest-mode')
                };
                
                console.log('[saveSubscriber] formData:', formData);
                
                // Validate required fields
                // Last name is required
                if (!formData.lastName) {
                    showToast('âš ï¸ ×©× ××©×¤×—×” ×”×•× ×©×“×” ×—×•×‘×”!', 'error');
                    document.getElementById('editLastName').focus();
                    document.getElementById('editLastName').style.borderColor = 'red';
                    return;
                }
                
                // Dates are required
                if (!formData.validFrom) {
                    showToast('âš ï¸ ×ª×—×™×œ×ª ×ª×•×§×£ ×”×•× ×©×“×” ×—×•×‘×”!', 'error');
                    document.getElementById('editValidFrom').focus();
                    document.getElementById('editValidFrom').style.borderColor = 'red';
                    return;
                }
                
                if (!formData.validUntil) {
                    showToast('âš ï¸ ×ª×•×§×£ ×¢×“ ×”×•× ×©×“×” ×—×•×‘×”!', 'error');
                    document.getElementById('editValidUntil').focus();
                    document.getElementById('editValidUntil').style.borderColor = 'red';
                    return;
                }
                
                // Validate date format and limit - accept both DD/MM/YYYY and YYYY-MM-DD
                const euroDateRegex = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
                const isoDateRegex = /^(\d{4})-(\d{2})-(\d{2})$/;
                
                let fromDay, fromMonth, fromYear;
                let untilDay, untilMonth, untilYear;
                
                // Check validFrom format
                const fromEuroMatch = formData.validFrom.match(euroDateRegex);
                const fromIsoMatch = formData.validFrom.match(isoDateRegex);
                
                if (fromEuroMatch) {
                    fromDay = parseInt(fromEuroMatch[1]);
                    fromMonth = parseInt(fromEuroMatch[2]);
                    fromYear = parseInt(fromEuroMatch[3]);
                } else if (fromIsoMatch) {
                    fromYear = parseInt(fromIsoMatch[1]);
                    fromMonth = parseInt(fromIsoMatch[2]);
                    fromDay = parseInt(fromIsoMatch[3]);
                } else {
                    showToast('âš ï¸ ×¤×•×¨××˜ ×ª××¨×™×š ×ª×—×™×œ×ª ×ª×•×§×£ ×œ× ×ª×§×™×Ÿ (DD/MM/YYYY)', 'error');
                    document.getElementById('editValidFrom').focus();
                    document.getElementById('editValidFrom').style.borderColor = 'red';
                    return;
                }
                
                // Check validUntil format
                const untilEuroMatch = formData.validUntil.match(euroDateRegex);
                const untilIsoMatch = formData.validUntil.match(isoDateRegex);
                
                if (untilEuroMatch) {
                    untilDay = parseInt(untilEuroMatch[1]);
                    untilMonth = parseInt(untilEuroMatch[2]);
                    untilYear = parseInt(untilEuroMatch[3]);
                } else if (untilIsoMatch) {
                    untilYear = parseInt(untilIsoMatch[1]);
                    untilMonth = parseInt(untilIsoMatch[2]);
                    untilDay = parseInt(untilIsoMatch[3]);
                } else {
                    showToast('âš ï¸ ×¤×•×¨××˜ ×ª××¨×™×š ×ª×•×§×£ ×¢×“ ×œ× ×ª×§×™×Ÿ (DD/MM/YYYY)', 'error');
                    document.getElementById('editValidUntil').focus();
                    document.getElementById('editValidUntil').style.borderColor = 'red';
                    return;
                }
                

                
                // Validate date values are in valid ranges
                if (fromDay < 1 || fromDay > 31 || fromMonth < 1 || fromMonth > 12) {
                    showToast('âš ï¸ ×ª××¨×™×š ×ª×—×™×œ×ª ×ª×•×§×£ ×œ× ×ª×§×™×Ÿ', 'error');
                    document.getElementById('editValidFrom').focus();
                    document.getElementById('editValidFrom').style.borderColor = 'red';
                    return;
                }
                
                if (untilDay < 1 || untilDay > 31 || untilMonth < 1 || untilMonth > 12) {
                    showToast('âš ï¸ ×ª××¨×™×š ×ª×•×§×£ ×¢×“ ×œ× ×ª×§×™×Ÿ', 'error');
                    document.getElementById('editValidUntil').focus();
                    document.getElementById('editValidUntil').style.borderColor = 'red';
                    return;
                }
                
                // Check date limit (max 31/12/3035)
                const maxYear = 3035;
                if (untilYear > maxYear || (untilYear === maxYear && untilMonth > 12) || 
                    (untilYear === maxYear && untilMonth === 12 && untilDay > 31)) {
                    showToast(`âš ï¸ ×ª××¨×™×š ×ª×•×§×£ ×¢×“ ×œ× ×™×›×•×œ ×œ×”×™×•×ª ××—×¨×™ 31/12/${maxYear}`, 'error');
                    document.getElementById('editValidUntil').focus();
                    document.getElementById('editValidUntil').style.borderColor = 'red';
                    return;
                }
                
                // Create date objects for comparison
                const fromDate = new Date(fromYear, fromMonth - 1, fromDay);
                const untilDate = new Date(untilYear, untilMonth - 1, untilDay);
                
                // Check that until date is after from date
                if (untilDate <= fromDate) {
                    showToast('âš ï¸ ×ª××¨×™×š ×ª×•×§×£ ×¢×“ ×—×™×™×‘ ×œ×”×™×•×ª ××—×¨×™ ×ª××¨×™×š ×ª×—×™×œ×ª ×ª×•×§×£', 'error');
                    document.getElementById('editValidUntil').focus();
                    document.getElementById('editValidUntil').style.borderColor = 'red';
                    return;
                }
                
                // Allow phone numbers in names - per user request
                
                // Reset border colors
                document.getElementById('editFirstName').style.borderColor = '';
                document.getElementById('editLastName').style.borderColor = '';
                document.getElementById('editValidFrom').style.borderColor = '';
                document.getElementById('editValidUntil').style.borderColor = '';
                
                // Show loading
                showToast('×©×•××¨ × ×ª×•× ×™×...', 'info');
                
                // Send to server via API
                const success = await uiIntegration.saveSubscriber(formData);
                
                if (success) {
                    // Show success toast
                    showToast('×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×” ×‘×©×¨×ª', 'success');
                    // Close modal
                    closeModal();
                    
                    // Update only the specific subscriber instead of reloading all
                    if (window.parkingUIXML) {
                        if (formData.isNew) {
                            // For new subscriber, refresh only if necessary
                            // The saveSubscriber function should have already updated the UI
                            window.parkingUIXML.refreshSingleSubscriber(formData.subscriberNum);
                        } else {
                            // For existing subscriber, update the specific row
                            const subscriberToRefresh = currentlyEditing || editingSubscriber;
                            if (subscriberToRefresh && subscriberToRefresh.subscriberNum) {
                                window.parkingUIXML.refreshSingleSubscriber(subscriberToRefresh.subscriberNum);
                            } else {
                                // Fallback to full refresh if we don't have the subscriber number
                                window.parkingUIXML.loadSubscribers();
                            }
                        }
                    }
                } else {
                    // Show error
                    showToast('×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×', 'error');
                }
            } else {
                // Fallback to mock save
                showToast('××¦×‘ ×“××• - ×”× ×ª×•× ×™× × ×©××¨×• ××§×•××™×ª', 'info');
                closeModal();
                loadSubscribers();
            }
        }

        // Language toggle
        function toggleLanguage() {
            currentLang = currentLang === 'he' ? 'en' : 'he';
            document.body.lang = currentLang;
            document.body.dir = currentLang === 'he' ? 'rtl' : 'ltr';
            
            // Update all translated elements
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                element.textContent = translations[currentLang][key];
            });
            
            // Update placeholders
            document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                element.placeholder = translations[currentLang][key];
            });
            
            // Refresh display
            if (currentSubscribers.length > 0) {
                displaySubscribers(currentSubscribers);
            }
        }

        // Font size control
        function changeFontSize(size) {
            document.body.classList.remove('small-font', 'large-font', 'xlarge-font');
            if (size === 'small') {
                document.body.classList.add('small-font');
            } else if (size === 'large') {
                document.body.classList.add('large-font');
            } else if (size === 'xlarge') {
                document.body.classList.add('xlarge-font');
            }
            localStorage.setItem('fontSize', size);
        }

        // Accessibility panel toggle
        function toggleAccessibility() {
            const panel = document.getElementById('accessibilityPanel');
            panel.classList.toggle('show');
        }

        // High contrast toggle
        function toggleHighContrast() {
            document.body.classList.toggle('high-contrast');
        }

        // Underline links toggle
        function toggleUnderlineLinks() {
            document.body.classList.toggle('underline-links');
        }

        // Focus highlight toggle
        function toggleFocusHighlight() {
            document.body.classList.toggle('focus-highlight');
        }

        // Reset accessibility settings
        function resetAccessibility() {
            document.body.classList.remove('high-contrast', 'underline-links', 'focus-highlight');
            document.getElementById('highContrast').checked = false;
            document.getElementById('underlineLinks').checked = false;
            document.getElementById('focusHighlight').checked = false;
            changeFontSize('normal');
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? 'âœ…' : 'âŒ'}</span>
                <span>${message}</span>
            `;
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Format date for display in European format (DD/MM/YYYY)
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return '';
            
            // If already in DD/MM/YYYY format, return as is
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                return dateStr;
            }
            
            // If in server format (YYYY-MM-DD), convert to European
            if (/^\d{4}-\d{2}-\d{2}/.test(dateStr)) {
                const parts = dateStr.split(/[-T]/);
                const year = parts[0];
                const month = parts[1];
                const day = parts[2];
                return `${day}/${month}/${year}`;
            }
            
            // Try to parse as date
            const date = new Date(dateStr);
            if (!isNaN(date)) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }
            
            return dateStr;
        }
        
        // Convert date from DD/MM/YYYY to YYYY-MM-DD for server
        function convertDateToServer(dateStr) {
            if (!dateStr) return '';
            
            let resultDate = '';
            
            // If already in YYYY-MM-DD format
            if (/^\d{4}-\d{2}-\d{2}/.test(dateStr)) {
                resultDate = dateStr;
            }
            // If in DD/MM/YYYY format, convert to server format
            else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                resultDate = `${year}-${month}-${day}`;
            }
            else {
                resultDate = dateStr;
            }
            
            // Limit date to maximum 31.12.2035
            const MAX_DATE = '2035-12-31';
            if (resultDate > MAX_DATE) {
                console.log(`Date ${resultDate} exceeds maximum, limiting to ${MAX_DATE}`);
                return MAX_DATE;
            }
            
            return resultDate;
        }

        // Export to Excel
        function exportToExcel() {
            // Export is always allowed - no permission check needed
            
            // Check if we have the UI integration
            if (window.parkingUIXML || window.parkingUI) {
                const uiIntegration = window.parkingUIXML || window.parkingUI;
                uiIntegration.exportToCSV();
                return;
            }
            
            // Get current filtered/sorted data
            const dataToExport = getFilteredSubscribers();
            
            if (!dataToExport || dataToExport.length === 0) {
                showToast('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×', 'warning');
                return;
            }
            
            // Create CSV content
            const headers = [
                '××¡×¤×¨ ×—×‘×¨×”',
                '×©× ×—×‘×¨×”', 
                '××¡×¤×¨ ×× ×•×™',
                '×©× ×¤×¨×˜×™',
                '×©× ××©×¤×—×”',
                '××¡×¤×¨ ×ª×’',
                '×¨×›×‘ 1',
                '×¨×›×‘ 2', 
                '×¨×›×‘ 3',
                '×ª×—×™×œ×ª ×ª×•×§×£',
                '×‘×ª×•×§×£ ×¢×“',
                '×¤×¨×•×¤×™×œ',
                '× ×•×›×—×•×ª'
            ];
            
            // Create CSV rows
            const rows = dataToExport.map(subscriber => [
                subscriber.companyNum || '',
                subscriber.companyName || '',
                subscriber.subscriberNum || '',
                subscriber.firstName || '',
                subscriber.lastName || '',
                subscriber.tagNum || '',
                subscriber.vehicle1 || subscriber.lpn1 || '',
                subscriber.vehicle2 || subscriber.lpn2 || '',
                subscriber.vehicle3 || subscriber.lpn3 || '',
                formatDate(subscriber.validFrom) || '',
                formatDate(subscriber.validUntil) || '' || '',
                translations[currentLang][subscriber.profile] || subscriber.profile || '',
                subscriber.presence ? '× ×•×›×—' : '×œ× × ×•×›×—'
            ]);
            
            // Combine headers and rows
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            
            // Add BOM for Hebrew support in Excel
            const BOM = '\uFEFF';
            const csvWithBOM = BOM + csvContent;
            
            // Create blob and download
            const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Generate filename with timestamp
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(':').slice(0,2).join('-');
            const companyName = currentCompany ? currentCompany.name : 'all';
            const filename = `parking_subscribers_${companyName}_${dateStr}_${timeStr}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast(`×”×§×•×‘×¥ ${filename} ×™×•×¦× ×‘×”×¦×œ×—×”`, 'success');
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            
            // Use formatDateForDisplay for consistency
            return formatDateForDisplay(dateString);
        }



        
        // Transactions Modal Functions
        let currentTransactionCompany = null;
        let currentTransactionSubscriber = null;
        let allTransactions = [];
        
        window.viewTransactions = function(companyNum, subscriberNum) {
            // Check permissions (for future implementation)
            // if (!checkUserPermission('view_transactions')) {
            //     showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×ª× ×•×¢×•×ª', 'error');
            //     return;
            // }
            
            currentTransactionCompany = companyNum;
            currentTransactionSubscriber = subscriberNum;
            
            // Set default dates
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            
            document.getElementById('transStartDate').value = lastMonth.toISOString().split('T')[0];
            document.getElementById('transEndDate').value = today.toISOString().split('T')[0];
            
            // Show modal
            document.getElementById('transactionsModal').style.display = 'block';
            
            // Auto load transactions
            loadTransactions();
        }
        
        window.closeTransactionsModal = function() {
            document.getElementById('transactionsModal').style.display = 'none';
            currentTransactionCompany = null;
            currentTransactionSubscriber = null;
            allTransactions = [];
        }
        
        window.loadTransactions = async function() {
            const startDate = document.getElementById('transStartDate').value;
            const endDate = document.getElementById('transEndDate').value;
            
            // Show loading
            document.getElementById('transactionsLoading').style.display = 'block';
            document.getElementById('transactionsSummary').style.display = 'none';
            document.getElementById('transactionsTableContainer').style.display = 'none';
            document.getElementById('noTransactions').style.display = 'none';
            
            try {
                const api = window.parkingAPIXML || new ParkingAPIXML();
                const url = `/consumers/${currentTransactionCompany},${currentTransactionSubscriber}/parktrans?minDate=${startDate}&maxDate=${endDate}`;
                
                const result = await api.makeRequest(url);
                
                if (result.success && result.data && result.data.parkTransaction) {
                    const transactions = Array.isArray(result.data.parkTransaction) 
                        ? result.data.parkTransaction 
                        : [result.data.parkTransaction];
                    
                    // Filter out code 42 and map data
                    allTransactions = transactions
                        .filter(t => parseInt(t.transactionType) !== 42)
                        .map(t => {
                            const typeNum = parseInt(t.transactionType);
                            const isEntry = (typeNum === 1 || typeNum === 2);
                            const isExit = (typeNum === 11 || typeNum === 12);
                            
                            return {
                                time: t.transactionTime,
                                typeNum: typeNum,
                                lpn: t.lpn || '-',
                                parkingLot: t.facilityin || t.facilityout || '×—× ×™×•×Ÿ ×¨××©×™',
                                device: t.device || '-',
                                direction: isEntry ? 'in' : (isExit ? 'out' : 'unknown')
                            };
                        });
                    
                    displayTransactions(allTransactions);
                } else {
                    // No transactions found
                    document.getElementById('noTransactions').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×ª× ×•×¢×•×ª', 'error');
            } finally {
                document.getElementById('transactionsLoading').style.display = 'none';
            }
        }
        
        function displayTransactions(transactions) {
            // Update summary
            const entries = transactions.filter(t => t.direction === 'in').length;
            const exits = transactions.filter(t => t.direction === 'out').length;
            
            document.getElementById('totalTrans').textContent = transactions.length;
            document.getElementById('totalEntries').textContent = entries;
            document.getElementById('totalExits').textContent = exits;
            document.getElementById('transactionsSummary').style.display = 'block';
            
            // Display table
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = '';
            
            transactions.forEach(t => {
                const row = document.createElement('tr');
                const time = new Date(t.time);
                const formattedTime = `${time.toLocaleDateString('he-IL')} ${time.toLocaleTimeString('he-IL')}`;
                
                let directionIcon = '';
                if (t.direction === 'in') {
                    directionIcon = 'ğŸŸ¢ ×›× ×™×¡×”';
                } else if (t.direction === 'out') {
                    directionIcon = 'ğŸ”´ ×™×¦×™××”';
                } else {
                    directionIcon = 'âšª ××—×¨';
                }
                
                // Device description
                let deviceDesc = '';
                const deviceNum = parseInt(t.device);
                if (deviceNum >= 100 && deviceNum < 200) {
                    deviceDesc = `×™×—×™×“×ª ×›× ×™×¡×” ${t.device}`;
                } else if (deviceNum >= 200 && deviceNum < 300) {
                    deviceDesc = `×™×—×™×“×ª ×™×¦×™××” ${t.device}`;
                } else if (deviceNum >= 300 && deviceNum < 400) {
                    deviceDesc = `×™×—×™×“×ª ××¢×‘×¨ ${t.device}`;
                } else {
                    deviceDesc = `×™×—×™×“×” ${t.device}`;
                }
                
                row.innerHTML = `
                    <td>${formattedTime}</td>
                    <td>${directionIcon}</td>
                    <td>${t.lpn}</td>
                    <td>${t.parkingLot}</td>
                    <td>${deviceDesc}</td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('transactionsTableContainer').style.display = 'block';
        }
        
        window.exportTransactions = function() {
            if (!allTransactions || allTransactions.length === 0) {
                showToast('××™×Ÿ ×ª× ×•×¢×•×ª ×œ×™×™×¦×•×', 'error');
                return;
            }
            
            // Create CSV content
            const headers = ['×ª××¨×™×š ×•×©×¢×”', '×¡×•×’ ×ª× ×•×¢×”', '××¡×¤×¨ ×¨×›×‘', '×—× ×™×•×Ÿ', '×™×—×™×“×”'];
            const rows = allTransactions.map(t => {
                const time = new Date(t.time);
                let directionText = t.direction === 'in' ? '×›× ×™×¡×”' : (t.direction === 'out' ? '×™×¦×™××”' : '××—×¨');
                
                return [
                    `${time.toLocaleDateString('he-IL')} ${time.toLocaleTimeString('he-IL')}`,
                    directionText,
                    t.lpn,
                    t.parkingLot,
                    t.device
                ];
            });
            
            // Add BOM for Hebrew
            const BOM = '\uFEFF';
            const csvContent = BOM + headers.join(',') + '\n' + 
                rows.map(row => row.join(',')).join('\n');
            
            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const filename = `transactions_${currentTransactionSubscriber}_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('×”×“×•×— ×™×•×¦× ×‘×”×¦×œ×—×”', 'success');
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
    
    <!-- Load Configuration and API Integration -->
    <!-- Pass user data to JavaScript -->
    <script>
        // Pass company_list from Flask to JavaScript
        window.userCompanyList = "{{ company_list }}";
        window.userPermissions = "{{ permissions }}";
        console.log('[Init] User company_list:', window.userCompanyList);
        console.log('[Init] User permissions:', window.userPermissions);
    </script>
    
    <script src="/static/js/config.js?v=20251216_fixed21"></script>
    <script src="/static/js/parking-api-live.js?v=20251216_fixed21"></script>
    <script src="/static/js/parking-ui-live.js?v=20251216_fixed21"></script>
    
        <script>
        // Override init function to use XML API
        const originalInit = init;
        init = async function() {
            originalInit();

            // Use XML API integration
            if (window.parkingUIXML) {
                console.log('XML API Integration available, connecting to parking server');
                // The parkingUIXML will handle loading companies and subscribers
            }
        };

        // Load current user info
        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/get-current-user');
                const data = await response.json();
                
                if (data.success && data.user) {
                    const usernameElement = document.getElementById('currentUsername');
                    if (usernameElement) {
                        usernameElement.textContent = data.user.username || data.user.email;
                    }
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                const usernameElement = document.getElementById('currentUsername');
                if (usernameElement) {
                    usernameElement.textContent = '××©×ª××©';
                }
            }
        }

        // Logout function
        function logout() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?')) {
                window.location.href = '/logout';
            }
        }

        // Load user info on page load
        // Font size adjustment
        let currentFontSize = 0; // 0 = normal, -1 = small, 1 = large
        function adjustFontSize(size) {
            const body = document.body;
            if (size === 0) {
                // Reset to normal
                body.style.fontSize = '13px';
                currentFontSize = 0;
            } else if (size === -1 && currentFontSize > -2) {
                // Decrease
                currentFontSize--;
                const newSize = 13 + (currentFontSize * 1);
                body.style.fontSize = newSize + 'px';
            } else if (size === 1 && currentFontSize < 3) {
                // Increase
                currentFontSize++;
                const newSize = 13 + (currentFontSize * 1);
                body.style.fontSize = newSize + 'px';
            }
            // Save preference
            localStorage.setItem('preferredFontSize', currentFontSize);
        }

        // Update UI buttons based on permissions
        function updateUIPermissions() {
            const permissions = getUserPermissions();
            console.log('[updateUIPermissions] User permissions:', permissions);
            
            // Add New Subscriber button
            const addNewBtn = document.querySelector('button[onclick="addNewSubscriber()"]');
            if (addNewBtn) {
                if (!permissions.includes('N')) {
                    addNewBtn.disabled = true;
                    addNewBtn.title = '××™×Ÿ ×”×¨×©××” ×œ×”×•×¡×™×£ ×× ×•×™×™× (×“×¨×•×©×” ×”×¨×©××ª N)';
                    addNewBtn.style.opacity = '0.5';
                }
            }
            
            // Add Guest button
            const addGuestBtn = document.querySelector('button[onclick="addGuestSubscriber()"]');
            if (addGuestBtn) {
                if (!permissions.includes('G')) {
                    addGuestBtn.disabled = true;
                    addGuestBtn.title = '××™×Ÿ ×”×¨×©××” ×œ×”×•×¡×™×£ ××•×¨×—×™× (×“×¨×•×©×” ×”×¨×©××ª G)';
                    addGuestBtn.style.opacity = '0.5';
                }
            }
            
            // Reports button
            const reportsBtn = document.querySelector('button[onclick="openReportsModal()"]');
            if (reportsBtn) {
                if (!permissions.includes('R')) {
                    reportsBtn.disabled = true;
                    reportsBtn.title = '××™×Ÿ ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×“×•×—×•×ª (×“×¨×•×©×” ×”×¨×©××ª R)';
                    reportsBtn.style.opacity = '0.5';
                }
            }
            
            // Export button
            const exportBtn = document.querySelector('button[onclick="exportToExcel()"]');
            if (exportBtn) {
                if (!permissions.includes('R')) {
                    exportBtn.disabled = true;
                    exportBtn.title = '××™×Ÿ ×”×¨×©××” ×œ×™×™×¦× × ×ª×•× ×™× (×“×¨×•×©×” ×”×¨×©××ª R)';
                    exportBtn.style.opacity = '0.5';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Load saved font size preference
            const savedFontSize = localStorage.getItem('preferredFontSize');
            if (savedFontSize) {
                currentFontSize = parseInt(savedFontSize);
                const newSize = 13 + (currentFontSize * 1);
                document.body.style.fontSize = newSize + 'px';
            }
            
            // Update button states based on permissions
            updateButtonPermissions();
            
            loadCurrentUser();
            
            // Update UI based on permissions
            setTimeout(updateUIPermissions, 100); // Small delay to ensure DOM is ready
        });
    </script>
</body>
</html>
