<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×“×™×§×ª ×›×œ ×”×©×“×•×ª - ×× ×•×™×™× ×•×—×‘×¨×•×ª</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .buttons {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0052a3;
        }
        button.success {
            background: #28a745;
        }
        button.warning {
            background: #ffc107;
            color: #333;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 600px;
            overflow-y: auto;
        }
        .field {
            padding: 5px;
            margin: 2px 0;
            border-left: 3px solid #0066cc;
            background: white;
        }
        .field-name {
            font-weight: bold;
            color: #0066cc;
            display: inline-block;
            min-width: 200px;
        }
        .field-value {
            color: #333;
        }
        .section-title {
            background: #0066cc;
            color: white;
            padding: 10px;
            margin: 20px 0 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .xml-preview {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ×‘×“×™×§×ª ×›×œ ×”×©×“×•×ª - ×× ×•×™×™× ×•×—×‘×¨×•×ª</h1>
        
        <div class="buttons">
            <button onclick="getFullConsumerDetails()" class="success">ğŸ“‹ ×¤×¨×˜×™ ×× ×•×™ ××œ××™×</button>
            <button onclick="getContractDetails()" class="warning">ğŸ¢ ×¤×¨×˜×™ ×—×‘×¨×”</button>
            <button onclick="getAllFieldsStructure()">ğŸ” ××‘× ×” ×›×œ ×”×©×“×•×ª</button>
            <button onclick="testUpdateFields()">âœï¸ ×‘×“×•×§ ×¢×“×›×•×Ÿ ×©×“×•×ª</button>
            <button onclick="checkNameFields()">ğŸ‘¤ ×‘×“×•×§ ×©×“×•×ª ×©×</button>
            <button onclick="clearResults()">ğŸ§¹ × ×§×”</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:8080';
        const AUTH = btoa('2022:2022');
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString('he-IL');
            results.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
        }
        
        function displayField(name, value, section = '') {
            const results = document.getElementById('results');
            results.innerHTML += `
                <div class="field">
                    <span class="field-name">${section}${name}:</span>
                    <span class="field-value">${value || '×¨×™×§'}</span>
                </div>
            `;
        }
        
        async function getFullConsumerDetails() {
            log('ğŸ“‹ ××‘×§×© ×¤×¨×˜×™ ×× ×•×™ ××œ××™×...', 'info');
            
            try {
                // Get consumer 2,10 full details
                const response = await fetch(`${API_URL}/consumers/2,10/detail`, {
                    headers: {
                        'Authorization': `Basic ${AUTH}`,
                        'Accept': 'application/xml'
                    }
                });
                
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                document.getElementById('results').innerHTML += '<div class="section-title">ğŸ“‹ ×¤×¨×˜×™ ×× ×•×™ 2,10</div>';
                
                // Parse all fields recursively
                function parseNode(node, path = '') {
                    if (node.nodeType === 1) { // Element node
                        const currentPath = path ? `${path}.` : '';
                        
                        if (node.children.length === 0) {
                            // Leaf node with value
                            if (node.textContent && node.textContent.trim()) {
                                displayField(node.nodeName, node.textContent, currentPath);
                            }
                        } else {
                            // Has children
                            for (let child of node.children) {
                                parseNode(child, currentPath + node.nodeName);
                            }
                        }
                    }
                }
                
                parseNode(xmlDoc.documentElement);
                
                // Show XML preview
                document.getElementById('results').innerHTML += `
                    <div class="section-title">ğŸ“„ XML Preview</div>
                    <div class="xml-preview">${formatXml(xmlText.substring(0, 1500))}...</div>
                `;
                
            } catch (error) {
                log(`âŒ ×©×’×™××”: ${error.message}`, 'error');
            }
        }
        
        async function getContractDetails() {
            log('ğŸ¢ ××‘×§×© ×¤×¨×˜×™ ×—×‘×¨×”...', 'info');
            
            try {
                // Get contract/company details
                const response = await fetch(`${API_URL}/contracts/2`, {
                    headers: {
                        'Authorization': `Basic ${AUTH}`,
                        'Accept': 'application/xml'
                    }
                });
                
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                document.getElementById('results').innerHTML += '<div class="section-title">ğŸ¢ ×¤×¨×˜×™ ×—×‘×¨×” 2</div>';
                
                // Parse contract fields
                function parseNode(node, path = '') {
                    if (node.nodeType === 1) {
                        const currentPath = path ? `${path}.` : '';
                        
                        if (node.children.length === 0) {
                            if (node.textContent && node.textContent.trim()) {
                                displayField(node.nodeName, node.textContent, currentPath);
                            }
                        } else {
                            for (let child of node.children) {
                                parseNode(child, currentPath + node.nodeName);
                            }
                        }
                    }
                }
                
                parseNode(xmlDoc.documentElement);
                
                // Show XML preview
                document.getElementById('results').innerHTML += `
                    <div class="section-title">ğŸ“„ XML Preview</div>
                    <div class="xml-preview">${formatXml(xmlText)}...</div>
                `;
                
            } catch (error) {
                log(`âŒ ×©×’×™××”: ${error.message}`, 'error');
            }
        }
        
        async function getAllFieldsStructure() {
            log('ğŸ” ×‘×•×“×§ ××‘× ×” ×›×œ ×”×©×“×•×ª...', 'info');
            
            document.getElementById('results').innerHTML = '';
            
            // Get both consumer and contract
            await getFullConsumerDetails();
            await getContractDetails();
            
            log('âœ… ×¡×™×•× ×‘×“×™×§×ª ××‘× ×”', 'success');
        }
        
        async function checkNameFields() {
            log('ğŸ‘¤ ×‘×•×“×§ ×©×“×•×ª ×©×...', 'info');
            
            try {
                const response = await fetch(`${API_URL}/consumers/2,10/detail`, {
                    headers: {
                        'Authorization': `Basic ${AUTH}`,
                        'Accept': 'application/xml'
                    }
                });
                
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                document.getElementById('results').innerHTML += '<div class="section-title">ğŸ‘¤ ×©×“×•×ª ×©× ×©× ××¦××•</div>';
                
                // Look for all possible name fields
                const nameFields = [
                    'firstName', 'surname', 'lastName', 'givenName', 'familyName',
                    'name', 'consumerName', 'fullName', 'personName'
                ];
                
                nameFields.forEach(field => {
                    const elements = xmlDoc.getElementsByTagName(field);
                    if (elements.length > 0) {
                        for (let elem of elements) {
                            displayField(field, elem.textContent, getPath(elem));
                        }
                    }
                });
                
                // Check inside consumer element specifically
                const consumer = xmlDoc.querySelector('consumer');
                if (consumer) {
                    log('ğŸ“¦ ×©×“×•×ª ×‘×ª×•×š consumer:', 'info');
                    for (let child of consumer.children) {
                        if (child.nodeName.toLowerCase().includes('name') || 
                            child.nodeName === 'firstName' || 
                            child.nodeName === 'surname') {
                            displayField(child.nodeName, child.textContent, 'consumer.');
                        }
                    }
                }
                
            } catch (error) {
                log(`âŒ ×©×’×™××”: ${error.message}`, 'error');
            }
        }
        
        async function testUpdateFields() {
            log('âœï¸ ×× ×¡×” ×œ×¢×“×›×Ÿ ×©×“×•×ª...', 'info');
            
            const xmlData = `<?xml version="1.0" encoding="UTF-8"?>
<consumerDetail xmlns="http://gsph.sub.com/cust/types">
    <consumer>
        <id>10</id>
        <contractid>2</contractid>
        <filialId>2240</filialId>
        <firstName>×“×•×“</firstName>
        <surname>×›×”×Ÿ</surname>
        <name>×“×•×“ ×›×”×Ÿ</name>
    </consumer>
    <firstName>×“×•×“</firstName>
    <surname>×›×”×Ÿ</surname>
    <lpn1>12-345-67</lpn1>
    <lpn2>98-765-43</lpn2>
    <lpn3>11-222-33</lpn3>
    <identification>
        <cardno>TAG123</cardno>
        <validFrom>2024-01-01</validFrom>
        <validUntil>2025-12-31</validUntil>
        <usageProfile>
            <id>1</id>
            <name>×¨×’×™×œ</name>
        </usageProfile>
        <present>false</present>
    </identification>
</consumerDetail>`;
            
            try {
                log('ğŸ“¤ ×©×•×œ×— ×¢×“×›×•×Ÿ...', 'info');
                document.getElementById('results').innerHTML += `
                    <div class="section-title">ğŸ“¤ XML × ×©×œ×—</div>
                    <div class="xml-preview">${formatXml(xmlData)}</div>
                `;
                
                const response = await fetch(`${API_URL}/consumers/2,10/detail`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Basic ${AUTH}`,
                        'Content-Type': 'application/xml',
                        'Accept': 'application/xml'
                    },
                    body: xmlData
                });
                
                const responseText = await response.text();
                
                document.getElementById('results').innerHTML += `
                    <div class="section-title">ğŸ“¥ ×ª×©×•×‘×” ××”×©×¨×ª</div>
                    <div class="xml-preview">${formatXml(responseText)}</div>
                `;
                
                // Get updated data
                log('ğŸ”„ ×‘×•×“×§ ××” × ×©××¨...', 'info');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const checkResponse = await fetch(`${API_URL}/consumers/2,10/detail`, {
                    headers: {
                        'Authorization': `Basic ${AUTH}`,
                        'Accept': 'application/xml'
                    }
                });
                
                const updatedXml = await checkResponse.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(updatedXml, 'text/xml');
                
                document.getElementById('results').innerHTML += '<div class="section-title">âœ… ××” × ×©××¨ ×‘×¤×•×¢×œ</div>';
                
                // Check specific fields
                const fieldsToCheck = ['firstName', 'surname', 'lpn1', 'lpn2', 'lpn3'];
                fieldsToCheck.forEach(field => {
                    const elem = xmlDoc.querySelector(field);
                    if (elem) {
                        displayField(field, elem.textContent);
                    }
                });
                
            } catch (error) {
                log(`âŒ ×©×’×™××”: ${error.message}`, 'error');
            }
        }
        
        function getPath(element) {
            let path = '';
            let current = element.parentNode;
            while (current && current.nodeName !== '#document') {
                if (current.nodeName !== 'consumerDetail') {
                    path = current.nodeName + (path ? '.' : '') + path;
                }
                current = current.parentNode;
            }
            return path;
        }
        
        function formatXml(xml) {
            const PADDING = '  ';
            const reg = /(>)(<)(\/*)/g;
            let pad = 0;
            
            xml = xml.replace(reg, '$1\r\n$2$3');
            
            return xml.split('\r\n').map(node => {
                let indent = 0;
                if (node.match(/.+<\/\w[^>]*>$/)) {
                    indent = 0;
                } else if (node.match(/^<\/\w/) && pad > 0) {
                    pad -= 1;
                } else if (node.match(/^<\w[^>]*[^\/]>.*$/)) {
                    indent = 1;
                } else {
                    indent = 0;
                }
                
                pad += indent;
                
                return PADDING.repeat(pad - indent) + node;
            }).join('\r\n');
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
    </script>
</body>
</html>
