<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>×œ×•×— ×‘×§×¨×” - ×—× ×™×•× ×™×</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #007AFF;
            --primary-light: #5AC8FA;
            --primary-dark: #0051D5;
            --success: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            --purple: #AF52DE;
            --background: #F2F2F7;
            --surface: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #6C6C70;
            --text-tertiary: #8E8E93;
            --border: #E5E5EA;
            --shadow: 0 2px 15px rgba(0,0,0,0.08);
            --shadow-hover: 0 8px 30px rgba(0,0,0,0.12);
            --radius: 16px;
            --radius-small: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Heebo', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            font-weight: 400;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Styles */
        .header {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: var(--shadow);
            animation: fadeInDown 0.8s ease;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            letter-spacing: -1px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .user-name {
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .logout-btn {
            padding: 10px 20px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: var(--radius-small);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3);
        }
        
        /* Control Panel */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        
        .control-group {
            flex: 1;
            min-width: 250px;
        }
        
        .control-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }
        
        .control-input, .control-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-small);
            font-size: 16px;
            font-family: inherit;
            background: var(--surface);
            transition: all 0.3s ease;
        }
        
        .control-input:focus, .control-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        /* Date picker icon positioning fix */
        input[type="date"] {
            position: relative;
            padding-left: 40px !important;
            direction: ltr;
            text-align: right;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: var(--surface);
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            right: auto;
            left: 10px;
            opacity: 1;
            cursor: pointer;
            z-index: 1;
            width: 24px;
            height: 24px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007AFF'%3E%3Cpath d='M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z'/%3E%3C/svg%3E") center no-repeat;
            background-size: 20px 20px;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator:hover {
            opacity: 0.8;
        }
        
        /* Firefox date picker icon fix */
        input[type="date"]::-moz-calendar-picker-indicator {
            position: absolute;
            right: auto;
            left: 10px;
            opacity: 1;
            cursor: pointer;
            width: 24px;
            height: 24px;
        }
        
        .load-btn {
            padding: 12px 32px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 20%);
            color: white;
            border: none;
            border-radius: var(--radius-small);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .load-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
        }
        
        .load-btn:active {
            transform: translateY(0);
        }
        
        /* Quick Range Buttons */
        .quick-ranges {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        .quick-btn {
            padding: 8px 16px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: var(--radius-small);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quick-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
        }
        
        /* View Mode Switcher */
        .view-mode-switcher {
            display: flex;
            background: var(--background);
            border-radius: var(--radius-small);
            padding: 4px;
            gap: 4px;
        }
        
        .view-mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: calc(var(--radius-small) - 4px);
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        .view-mode-btn.active {
            background: var(--surface);
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .view-mode-btn:hover:not(.active) {
            color: var(--primary);
        }
        
        /* Date Navigation Buttons */
        .date-nav-btn {
            padding: 12px 16px;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: var(--radius-small);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
        }
        
        .date-nav-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
        }
        
        /* Quick Action Buttons */
        .quick-action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-small);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }
        
        .quick-action-btn.yesterday {
            background: var(--success);
            color: white;
        }
        
        .quick-action-btn.yesterday:hover {
            background: #2DB553;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3);
        }
        
        .quick-action-btn.week {
            background: var(--primary);
            color: white;
        }
        
        .quick-action-btn.week:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
        }
        
        .quick-action-btn.lastweek {
            background: var(--primary-light);
            color: white;
        }
        
        .quick-action-btn.lastweek:hover {
            background: #4AB5E8;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(90, 200, 250, 0.3);
        }
        
        .quick-action-btn.month {
            background: var(--purple);
            color: white;
        }
        
        .quick-action-btn.month:hover {
            background: #9B42CA;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(175, 82, 222, 0.3);
        }
        
        .quick-action-btn.lastmonth {
            background: var(--warning);
            color: white;
        }
        
        .quick-action-btn.lastmonth:hover {
            background: #E88300;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 149, 0, 0.3);
        }
        
        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        /* Logo SB 300dpi.tif */
        
        .loading-text {
            font-size: 18px;
            color: var(--text-secondary);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            animation: fadeIn 0.8s ease;
        }
        
        .stat-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 28px;
            box-shadow: var(--shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .stat-card:hover::before {
            opacity: 1;
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, transparent 40%, rgba(0, 122, 255, 0.05) 100%);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }
        
        .stat-card .icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 16px;
        }
        
        .stat-card h3 {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .stat-card .change {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .stat-card .change.positive {
            color: var(--success);
        }
        
        .stat-card .change.negative {
            color: var(--danger);
        }
        
        .stat-card .change.neutral {
            color: var(--text-secondary);
        }
        
        .stat-card .subtext {
            color: var(--text-tertiary);
            font-size: 13px;
            margin-top: 4px;
        }
        
        .stat-card .exit-line {
            color: var(--text-tertiary);
            font-size: 12px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }
        
        .stat-card .tsper3-line {
            color: var(--danger);
            font-size: 12px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            font-weight: 500;
        }
        
        /* Chart Sections */
        .chart-section {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            animation: fadeIn 0.8s ease;
        }
        
        .chart-section:hover {
            box-shadow: var(--shadow-hover);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .chart-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chart-options {
            display: flex;
            gap: 10px;
        }
        
        .chart-option-btn {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: var(--surface);
            border-radius: var(--radius-small);
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
        }
        
        .chart-option-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.1);
        }
        
        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }
        
        /* Alerts Section */
        .alerts-section {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            display: none;
        }
        
        .alert-item {
            padding: 20px;
            border-radius: var(--radius-small);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
        }
        
        .alert-item:hover {
            transform: translateX(-4px);
        }
        
        .alert-item.positive {
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.1) 0%, rgba(52, 199, 89, 0.05) 100%);
            border-right: 4px solid var(--success);
        }
        
        .alert-item.negative {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.1) 0%, rgba(255, 59, 48, 0.05) 100%);
            border-right: 4px solid var(--danger);
        }
        
        .alert-icon {
            font-size: 24px;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .alert-description {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* Error State */
        .error-message {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.1) 0%, rgba(255, 59, 48, 0.05) 100%);
            border: 2px solid var(--danger);
            color: var(--danger);
            padding: 24px;
            border-radius: var(--radius);
            margin: 24px 0;
            text-align: center;
            display: none;
        }
        
        /* Single Parking Mode */
        .single-parking-mode .multi-parking-only {
            display: none !important;
        }
        
        /* Animations */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 36px; }
            .charts-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .stat-card { padding: 20px; }
            .stat-card .value { font-size: 24px; }
            .control-panel { flex-direction: column; }
            .control-group { width: 100%; }
        }
        
        /* Stay Duration Cards */
        .stay-duration-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 40px;
        }
        
        .stay-duration-item {
            background: var(--background);
            padding: 20px;
            border-radius: var(--radius-small);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stay-duration-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .stay-duration-item:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.2);
        }
        
        .stay-duration-item:hover::before {
            opacity: 1;
        }
        
        .stay-duration-item:hover * {
            color: white !important;
            position: relative;
        }
        
        .stay-duration-time {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .stay-duration-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stay-duration-percent {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }
        
        .stay-duration-total {
            grid-column: span 2;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        }
        
        .stay-duration-total * {
            color: white !important;
        }
        
        .stay-060:hover {
            border-color: var(--primary-dark) !important;
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.1), rgba(0, 122, 255, 0.05)) !important;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--background);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
                    <div class="header-top">
            <div style="display: flex; align-items: center; gap: 20px;">
                <h1>×œ×•×— ×‘×§×¨×” - <span id="dashboardTitle">×˜×•×¢×Ÿ...</span></h1>
                <img src="https://raw.githubusercontent.com/DrorSBIsrael/S-B-Parking-reports/refs/heads/master/templates/Logo%20SB%20300dpi.jpg" 
                     alt="Logo" 
                     style="height: 60px; width: auto; object-fit: contain;">
            </div>
        </div>
            
            <!-- Control Panel -->
            <div class="control-panel">
                <!-- First Row -->
                <div style="display: flex; gap: 20px; width: 100%; align-items: flex-end; flex-wrap: wrap;">
                    <!-- View Mode Switcher -->
                    <div class="view-mode-switcher">
                        <button class="view-mode-btn active" data-mode="daily" onclick="setViewMode('daily')">×™×•××™</button>
                        <button class="view-mode-btn" data-mode="weekly" onclick="setViewMode('weekly')">×©×‘×•×¢×™</button>
                        <button class="view-mode-btn" data-mode="monthly" onclick="setViewMode('monthly')">×—×•×“×©×™</button>
                    </div>
                    
                    <!-- Date Navigation -->
                    <button class="date-nav-btn" onclick="navigateDate(-1)">â—€</button>
                    
                    <!-- Date Range -->
                    <div class="control-group">
                        <label class="control-label">××ª××¨×™×š</label>
                        <input type="date" id="startDate" class="control-input">
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">×¢×“ ×ª××¨×™×š</label>
                        <input type="date" id="endDate" class="control-input">
                    </div>
                    
                    <button class="date-nav-btn" onclick="navigateDate(1)">â–¶</button>
                    
                    <!-- Load Button -->
                    <button class="load-btn" onclick="loadData()">
                        <span>ğŸ“Š</span>
                        <span>×˜×¢×Ÿ × ×ª×•× ×™×</span>
                    </button>
                </div>
                
                <!-- Second Row - Quick Actions -->
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; align-items: center;">
                    <button class="quick-action-btn yesterday" onclick="setQuickRange('yesterday')">
                        <span>ğŸ“†</span>
                        <span>××ª××•×œ</span>
                    </button>
                    
                    <button class="quick-action-btn week" onclick="setQuickRange('currentWeek')">
                        <span>ğŸ“…</span>
                        <span>×”×©×‘×•×¢</span>
                    </button>
                    
                    <button class="quick-action-btn lastweek" onclick="setQuickRange('lastWeek')">
                        <span>ğŸ“†</span>
                        <span>×©×‘×•×¢ ×©×¢×‘×¨</span>
                    </button>
                    
                    <button class="quick-action-btn month" onclick="setQuickRange('currentMonth')">
                        <span>ğŸ“…</span>
                        <span>×”×—×•×“×©</span>
                    </button>
                    
                    <button class="quick-action-btn lastmonth" onclick="setQuickRange('lastMonth')">
                        <span>ğŸ“†</span>
                        <span>×—×•×“×© ×©×¢×‘×¨</span>
                    </button>
                    
                    <!-- Parking Selector -->
                    <div id="parkingSelectorGroup" style="display: none; margin-right: 20px;">
                        <select id="parkingSelector" class="control-input" style="text-align: center; font-weight: 500; min-width: 200px;">
                            <option value="">×›×œ ×”×—× ×™×•× ×™×</option>
                        </select>
                    </div>
                    
                    <!-- Logout Button moved here -->
                    <button class="logout-btn" onclick="logout()" style="background: #000; margin-right: auto;">
                        ×”×ª× ×ª×§
                    </button>
                </div>
            </div>
            
            <!-- User Info -->
            <div style="margin-top: 15px; padding: 10px 0; color: var(--text-secondary); font-size: 14px;">
                <span>××©×ª××© ××—×•×‘×¨: </span>
                <span id="userName" style="font-weight: 600;">×˜×•×¢×Ÿ...</span>
            </div>
            

        </div>
        
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <div class="loading-text">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
            </div>
        </div>
        
        <!-- Error Message -->
        <div class="error-message" id="errorMessage">
            <h3>×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</h3>
            <p id="errorText"></p>
        </div>
        
        <!-- Dashboard Content -->
        <div id="dashboardContent">
            <!-- Stats Grid -->
            <div class="stats-grid" id="statsGrid">
                <!-- Dynamic content -->
            </div>
            
            <!-- Alerts Section -->
            <div class="alerts-section" id="alertsSection">
                <div class="chart-header">
                    <h2 class="chart-title">
                        <span>âš¡</span>
                        <span>×”×ª×¨××•×ª ×•××’××•×ª</span>
                    </h2>
                </div>
                <div id="alertsContainer">
                    <!-- Dynamic alerts -->
                </div>
            </div>
            
            <!-- Charts Grid -->
            <div class="charts-grid">
                <!-- Revenue Trends Chart -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>ğŸ“ˆ</span>
                            <span>××’××ª ×”×›× ×¡×•×ª</span>
                        </h2>
                        <div class="chart-options">
                            <button class="chart-option-btn" onclick="toggleChartType('revenue')">
                                <span>ğŸ”„</span>
                                <span>×”×—×œ×£ ×¡×•×’</span>
                            </button>
                        </div>
                    </div>
                    <canvas id="revenueChart"></canvas>
                </div>
                
                <!-- Payment Methods Chart -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>ğŸ’³</span>
                            <span>×××¦×¢×™ ×ª×©×œ×•×</span>
                        </h2>
                    </div>
                    <canvas id="paymentChart"></canvas>
                </div>
                
                <!-- Entries Chart -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>ğŸš—</span>
                            <span>×¡×•×’×™ ×›× ×™×¡×•×ª</span>
                        </h2>
                    </div>
                    <canvas id="entriesChart"></canvas>
                </div>
                
                <!-- Period Comparison Chart -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>ğŸ“…</span>
                            <span id="comparisonTitle">×”×©×•×•××” ×™×•××™×ª</span>
                        </h2>
                    </div>
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
            
            <!-- Multi-Parking Charts -->
            <div class="charts-grid multi-parking-only">
                <!-- Parking Comparison Chart -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>ğŸ¢</span>
                            <span>×”×©×•×•××ª ×—× ×™×•× ×™×</span>
                        </h2>
                        <p style="margin: 0; font-size: 14px; color: var(--text-secondary); font-weight: 400;">×œ×—×¥ ×¢×œ ×—× ×™×•×Ÿ ×œ×¤×™×¨×•×˜ ××œ×</p>
                    </div>
                    <canvas id="parkingComparisonChart"></canvas>
                    
                    <!-- Parking Details Section (for group users) -->
                    <div id="parkingDetailsSection" style="display: none; margin-top: 20px; padding: 20px; background: var(--background); border-radius: 12px;">
                        <div id="parkingDetailsHeader" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 id="parkingDetailsTitle" style="font-size: 20px; font-weight: 600;"></h3>
                            <button onclick="closeParkingDetails()" style="
                                background: none;
                                border: none;
                                font-size: 24px;
                                cursor: pointer;
                                color: var(--text-secondary);
                                padding: 5px;
                            ">Ã—</button>
                        </div>
                        <div id="parkingDetailsContent">
                            <!-- Details will be filled here -->
                        </div>
                    </div>
                </div>
                
                <!-- Parking Ranking -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>ğŸ†</span>
                            <span>×“×™×¨×•×’ ×—× ×™×•× ×™×</span>
                        </h2>
                    </div>
                    <div id="parkingRanking"></div>
                </div>
            </div>
            
            <!-- Stay Duration Section -->
            <div class="chart-section">
                <div class="chart-header">
                    <h2 class="chart-title">
                        <span>â±ï¸</span>
                        <span>×–×× ×™ ×©×”×™×™×”</span>
                    </h2>
                    <div class="chart-options">
                        <button class="chart-option-btn active" onclick="toggleStayDurationView('cards')">
                            <span>ğŸ¯</span>
                            <span>×›×¨×˜×™×¡×™×</span>
                        </button>
                        <button class="chart-option-btn" onclick="toggleStayDurationView('bar')">
                            <span>ğŸ“Š</span>
                            <span>×¢××•×“×•×ª</span>
                        </button>
                        <button class="chart-option-btn" onclick="toggleStayDurationView('pie')">
                            <span>ğŸ¥§</span>
                            <span>×¢×•×’×”</span>
                        </button>
                    </div>
                </div>
                <div class="stay-duration-grid" id="stayDurationGrid">
                    <!-- Stay duration cards will be populated here -->
                </div>
                <canvas id="stayDurationChart" style="display: none; max-height: 350px;"></canvas>
            </div>
            
            <!-- Barrier & Encoders Section -->
            <div class="charts-grid">
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>ğŸš§</span>
                            <span>×¤×ª×™×—×•×ª ××—×¡×•×</span>
                        </h2>
                    </div>
                    <canvas id="barrierChart"></canvas>
                </div>
                
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>ğŸ”¢</span>
                            <span>× ×ª×•× ×™ ××§×•×“×“×™×</span>
                        </h2>
                    </div>
                    <div id="encodersInfo"></div>
                </div>
            </div>
        </div>
    </div>

<script>
// Global variables
let currentData = [];
let charts = {};
let isSingleParkingMode = false;
let isGroup = false;
let groupName = '';
let userParkings = [];
let currentViewMode = 'daily'; // Track current view mode
let chartTypes = { revenue: 'line', entries: 'bar', daily: 'bar' }; // Track chart types
let stayDurationViewMode = 'cards'; // Track stay duration view mode

// Chart.js default configuration
Chart.defaults.font.family = "'Heebo', -apple-system, BlinkMacSystemFont, sans-serif";
Chart.defaults.color = '#6C6C70';
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.padding = 20;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
});

// Fix date picker format
function fixDatePickerFormat() {
    const dateInputs = document.querySelectorAll('input[type="date"]');
    
    dateInputs.forEach(input => {
        // Skip if already processed
        if (input.dataset.processed === 'true') {
            return;
        }
        
        // Mark as processed
        input.dataset.processed = 'true';
        
        // Create wrapper
        const wrapper = document.createElement('div');
        wrapper.style.position = 'relative';
        wrapper.style.display = 'inline-block';
        wrapper.style.width = '100%';
        
        // Move input into wrapper
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);
        
        // Create text input for display
        const textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.className = input.className;
        textInput.placeholder = 'DD/MM/YYYY';
        textInput.style.position = 'absolute';
        textInput.style.top = '0';
        textInput.style.left = '0';
        textInput.style.width = '100%';
        textInput.style.height = '100%';
        textInput.style.background = 'white';
        textInput.style.cursor = 'pointer';
        
        // Insert text input
        wrapper.appendChild(textInput);
        
        // Make date input mostly transparent but keep calendar icon visible
        input.style.position = 'relative';
        input.style.zIndex = '2';
        input.style.opacity = '0.01'; // Almost invisible but still functional
        input.style.cursor = 'pointer';
        
        // Update text input when date changes
        const updateDisplay = () => {
            if (input.value) {
                textInput.value = formatDateForDisplay(input.value);
            } else {
                textInput.value = '';
            }
        };
        
        // Initial display
        updateDisplay();
        
        // Handle date picker changes
        input.addEventListener('change', updateDisplay);
        input.addEventListener('input', updateDisplay);
        
        // Handle text input
        textInput.addEventListener('focus', () => {
            // Click the hidden date input when text input is focused
            input.click();
        });
        
        // Allow manual typing
        textInput.addEventListener('keydown', (e) => {
            // Prevent triggering date picker on typing
            e.stopPropagation();
        });
        
        // Handle manual input
        textInput.addEventListener('input', (e) => {
            const value = e.target.value;
            
            // Auto-format as user types
            let formatted = value.replace(/[^\d]/g, ''); // Remove non-digits
            
            if (formatted.length >= 2) {
                formatted = formatted.slice(0, 2) + '/' + formatted.slice(2);
            }
            if (formatted.length >= 5) {
                formatted = formatted.slice(0, 5) + '/' + formatted.slice(5, 9);
            }
            
            textInput.value = formatted;
            
            // Try to parse and set date when complete
            if (formatted.length === 10) {
                const parts = formatted.split('/');
                if (parts.length === 3) {
                    const day = parts[0];
                    const month = parts[1];
                    const year = parts[2];
                    
                    // Create date string in YYYY-MM-DD format
                    const dateStr = `${year}-${month}-${day}`;
                    const testDate = new Date(dateStr);
                    
                    // Validate date
                    if (!isNaN(testDate.getTime()) && 
                        testDate.getDate() == parseInt(day) && 
                        testDate.getMonth() + 1 == parseInt(month)) {
                        input.value = dateStr;
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            }
        });
        
        // Prevent default behavior on text input click to allow typing
        textInput.addEventListener('click', (e) => {
            e.stopPropagation();
            
            // If empty, open date picker
            if (!textInput.value) {
                input.click();
            }
        });
    });
}

// Initialize dashboard
async function initializeDashboard() {
    try {
        // Debug: Clear any cached elements
        console.log('=== INITIALIZING DASHBOARD ===');
        console.log('Checking for duplicate parking selectors...');
        const allSelectors = document.querySelectorAll('#parkingSelector, #bottomParkingSelect');
        console.log('Found selectors:', allSelectors.length);
        allSelectors.forEach((sel, idx) => {
            console.log(`Selector ${idx + 1}:`, sel.id, sel.parentElement.id);
        });
        
        // Set default dates (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        document.getElementById('endDate').value = formatDateForInput(today);
        document.getElementById('startDate').value = formatDateForInput(thirtyDaysAgo);
        
        // Load user info
        await loadUserInfo();
        
        // Load parking list
        await loadParkingList();
        
        // Load initial data
        await loadData();
        
        // Fix date picker display after everything is loaded
        setTimeout(() => {
            fixDatePickerFormat();
        }, 500);
        
        // Show special message for group users
        if (isGroup) {
            console.log('Group user detected. Special handling may be needed.');
            // CSV upload option removed per user request
        }
    } catch (error) {
        console.error('Initialization error:', error);
        showError('×©×’×™××” ×‘××ª×—×•×œ ×”××¢×¨×›×ª');
    }
}

// Format date for input field
function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Format date for API
function formatDateForAPI(date) {
    return date.toISOString().split('T')[0];
}

// Format date for display (DD/MM/YYYY)
function formatDateForDisplay(dateString) {
    if (!dateString) return '';
    
    // Check if already in DD/MM/YYYY format
    if (dateString.includes('/')) {
        return dateString;
    }
    
    // Convert from YYYY-MM-DD to DD/MM/YYYY
    const parts = dateString.split('-');
    if (parts.length === 3) {
        const [year, month, day] = parts;
        return `${day}/${month}/${year}`;
    }
    
    // If date is in any other format, try to parse it
    const date = new Date(dateString);
    if (!isNaN(date)) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }
    
    return dateString; // Return as is if cannot parse
}

// Load user info
async function loadUserInfo() {
    try {
        const response = await fetch('/api/user-info');
        const result = await response.json();
        
        if (result.success && result.user) {
            document.getElementById('userName').textContent = result.user.username || '××©×ª××©';
            
            // Check if this is a group (project_number = 0 or role = group_manager)
            if (result.user.project_number === 0 || result.user.role === 'group_manager') {
                isGroup = true;
                groupName = result.user.parking_name || '×§×‘×•×¦×”';
                document.getElementById('dashboardTitle').textContent = `×§×‘×•×¦×ª ${groupName}`;
                
                // Log user details for debugging
                console.log('Group user detected:', {
                    username: result.user.username,
                    role: result.user.role,
                    access_level: result.user.access_level,
                    project_number: result.user.project_number,
                    parking_name: result.user.parking_name
                });
            } else {
                isGroup = false;
                document.getElementById('dashboardTitle').textContent = result.user.parking_name || '×—× ×™×•× ×™×';
            }
        }
    } catch (error) {
        console.error('Error loading user info:', error);
    }
}

// Load parking list
async function loadParkingList() {
    try {
        const response = await fetch('/api/user-parkings');
        const result = await response.json();
        
        if (!result.success) {
            // Handle authentication or permission errors
            if (result.message && result.message.includes('×”×¨×©××”')) {
                showError('×©×’×™××ª ×”×¨×©××”: ' + result.message);
                return;
            }
        }
        
        if (result.success && result.parkings) {
            const selector = document.getElementById('parkingSelector');
            selector.innerHTML = '';
            
            console.log('Raw parkings from API:', result.parkings);
            console.log('isGroup:', isGroup, 'groupName:', groupName);
            
            // For groups, filter parkings by group name
            let parkings = result.parkings;
            // ×”×¡×¨× ×• ××ª ×”×¡×™× ×•×Ÿ ×›×™ ×”×©×¨×ª ×›×‘×¨ ××—×–×™×¨ ×¨×§ ××ª ×”×—× ×™×•× ×™× ×©×œ ×”×§×‘×•×¦×”
            /*
            if (isGroup && groupName) {
                // Filter parkings that belong to this group
                parkings = result.parkings.filter(p => 
                    p.name && p.name.toLowerCase().includes(groupName.toLowerCase())
                );
            }
            */
            
            console.log('Parkings from API:', parkings);
            console.log('Parkings count:', parkings.length);
            
            // Save parkings list
            userParkings = parkings;
            
            // Check if user has multiple parkings
            if (parkings.length > 1 || (isGroup && parkings.length >= 1)) {
                console.log('Multiple parkings detected:', parkings.length);
                document.getElementById('parkingSelectorGroup').style.display = 'block';
                console.log('Showing parking selector');
                
                // Add "all parkings" option
                const allOption = document.createElement('option');
                allOption.value = '';
                allOption.textContent = isGroup ? `×›×œ ×—× ×™×•× ×™ ${groupName}` : '×›×œ ×”×—× ×™×•× ×™×';
                selector.appendChild(allOption);
                
                // Add individual parkings
                parkings.forEach(parking => {
                    const option = document.createElement('option');
                    option.value = parking.project_number;  // ×©×™× ×•×™ ×-id ×œ-project_number
                    option.textContent = parking.parking_name;  // ×©×™× ×•×™ ×-name ×œ-parking_name
                    selector.appendChild(option);
                });
            } else if (parkings.length === 1) {
                // Single parking mode or group with one parking
                if (isGroup) {
                    // For group users - show selector even with one parking
                    document.getElementById('parkingSelectorGroup').style.display = 'block';
                    
                    // Add the single parking to selector
                    const allOption = document.createElement('option');
                    allOption.value = '';
                    allOption.textContent = `×›×œ ×—× ×™×•× ×™ ${groupName}`;
                    selector.appendChild(allOption);
                    
                    const option = document.createElement('option');
                    option.value = parkings[0].project_number;
                    option.textContent = parkings[0].parking_name;
                    selector.appendChild(option);
                } else {
                    // Regular single parking mode
                    isSingleParkingMode = true;
                    document.body.classList.add('single-parking-mode');
                }
                
                // Update title with single parking name
                document.getElementById('dashboardTitle').textContent = parkings[0].parking_name;
            } else {
                // No parkings found
                showError('×œ× × ××¦××• ×—× ×™×•× ×™× ×¢×‘×•×¨ ××©×ª××© ×–×”');
            }
        }
    } catch (error) {
        console.error('Error loading parkings:', error);
        showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×”×—× ×™×•× ×™×');
    }
}

// Load data from API
async function loadData() {
    try {
        showLoading(true);
        hideError();
        
        // Get date range
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            throw new Error('× × ×œ×‘×—×•×¨ ×˜×•×•×— ×ª××¨×™×›×™×');
        }
        
        // For groups, try multiple approaches
        if (isGroup) {
            await loadDataForGroup(startDate, endDate);
        } else {
            await loadDataStandard(startDate, endDate);
        }
        
    } catch (error) {
        console.error('Error loading data:', error);
        showError(error.message || '×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
    } finally {
        showLoading(false);
    }
}

// Standard data loading for non-group users
async function loadDataStandard(startDate, endDate) {
    // Build API params
    const params = new URLSearchParams({
        start_date: startDate,
        end_date: endDate
    });
    
    // Add parking filter if selected
    const selectedParking = document.getElementById('parkingSelector').value;
    console.log('Selected parking value:', selectedParking);
    if (selectedParking) {
        params.append('parking_id', selectedParking);
        console.log('Filtering by parking_id:', selectedParking);
    } else {
        console.log('No parking selected - loading all parkings');
    }
    
    // Debug: Log request details
    console.log('Standard API Request:', {
        url: `/api/parking-data?${params}`,
        params: Object.fromEntries(params)
    });
    
    // Fetch data from API
    const response = await fetch(`/api/parking-data?${params}`);
    const result = await response.json();
    
            // Debug: Log response
        console.log('API Response:', {
            status: response.status,
            statusText: response.statusText,
            success: result.success,
            message: result.message,
            dataLength: result.data ? result.data.length : 0,
            fullResult: result
        });
        
        if (!result.success) {
            console.error('API Error Details:', {
                message: result.message,
                error: result.error,
                details: result.details
            });
            throw new Error(result.message || '×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
        }
    
    // Process and display data
    currentData = result.data || [];
    console.log('Loaded data:', currentData.length, 'records');
    
    // Debug: show unique parkings in the data
    if (currentData.length > 0) {
        const uniqueParkings = [...new Set(currentData.map(d => d.parking_name))];
        console.log('Unique parkings in data:', uniqueParkings);
        console.log('First few records:', currentData.slice(0, 3));
    }
    
    updateDashboard();
}

// Special data loading for group users
async function loadDataForGroup(startDate, endDate) {
    console.log('Loading data for group:', groupName);
    
    // Try approach 1: Load without special group parameters
    try {
        // For groups, try loading data without special parameters first
        const params = new URLSearchParams({
            start_date: startDate,
            end_date: endDate
        });
        
        // Add parking filter if selected
        const selectedParking = document.getElementById('parkingSelector').value;
        console.log('Group mode - Selected parking value:', selectedParking);
        if (selectedParking) {
            params.append('parking_id', selectedParking);
            console.log('Group mode - Filtering by parking_id:', selectedParking);
        } else {
            console.log('Group mode - No parking selected - loading all group parkings');
        }
        
        console.log('Group API Request (Approach 1 - Standard):', {
            url: `/api/parking-data?${params}`,
            params: Object.fromEntries(params)
        });
        
        const response = await fetch(`/api/parking-data?${params}`, {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        const result = await response.json();
        
        console.log('Group API Response:', {
            status: response.status,
            success: result.success,
            message: result.message,
            dataLength: result.data ? result.data.length : 0
        });
        
        // Check if we got an error about permissions
        if (!result.success && result.message && result.message.includes('×¨××ª ×”×¨×©××”')) {
            console.log('Permission error detected, will try alternative approaches');
        } else if (result.success && result.data) {
            // ×”×©×¨×ª ×›×‘×¨ ××¡× ×Ÿ ××ª ×”× ×ª×•× ×™× ×œ×¤×™ ×”×§×‘×•×¦×”, ××– ×¤×©×•×˜ × ×©×ª××© ×‘× ×ª×•× ×™×
            currentData = result.data;
            console.log('Loaded data:', currentData.length, 'records');
            
            if (currentData.length > 0) {
                // Debug: show unique parkings in the data
                const uniqueParkings = [...new Set(currentData.map(d => d.parking_name))];
                console.log('Group data - Unique parkings:', uniqueParkings);
                console.log('Group data - First few records:', currentData.slice(0, 3));
                
                updateDashboard();
                return;
            }
        }
    } catch (error) {
        console.error('Group approach 1 failed:', error);
    }
    
    // Try approach 2: Load without any filters
    try {
        console.log('Trying minimal parameters approach...');
        
        // Try with minimal parameters - maybe the server doesn't like certain combinations
        const response = await fetch(`/api/parking-data?start_date=${startDate}&end_date=${endDate}`, {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        const result = await response.json();
        
        console.log('Minimal params response:', result);
        
        if (result.success && result.data && result.data.length > 0) {
            // ×”×©×¨×ª ×›×‘×¨ ××¡× ×Ÿ ×œ×¤×™ ×”×§×‘×•×¦×”
            currentData = result.data;
            console.log('Loaded data:', currentData.length, 'records');
            updateDashboard();
            return;
        }
    } catch (error) {
        console.error('Group approach 2 failed:', error);
    }
    
    // Try approach 3: Load data for each parking individually
    if (userParkings && userParkings.length > 0) {
        try {
            console.log('Trying to load data for each parking individually...');
            
            let allData = [];
            
            for (const parking of userParkings) {
                try {
                    const params = new URLSearchParams({
                        start_date: startDate,
                        end_date: endDate,
                        parking_id: parking.project_number  // ×©×™× ×•×™ ×-id ×œ-project_number
                    });
                    
                    console.log(`Loading data for parking: ${parking.parking_name} (${parking.project_number})`);
                    
                    const response = await fetch(`/api/parking-data?${params}`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        allData = allData.concat(result.data);
                    }
                } catch (error) {
                    console.error(`Failed to load data for parking ${parking.parking_name}:`, error);
                }
            }
            
            if (allData.length > 0) {
                currentData = allData;
                console.log('Loaded combined data for all parkings:', currentData.length, 'records');
                updateDashboard();
                return;
            }
        } catch (error) {
            console.error('Group approach 3 failed:', error);
        }
    }
    
    // If all approaches fail, show detailed error with alternative options
    const errorMessage = `
        <div style="text-align: center; padding: 20px;">
            <h3>×‘×¢×™×” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×§×‘×•×¦×ª ${groupName}</h3>
            <p>×”××¢×¨×›×ª ×–×™×”×ª×” ×©××ª×” ××©×ª××© ×§×‘×•×¦×”, ××š ×™×© ×‘×¢×™×” ×–×× ×™×ª ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™× ××”×©×¨×ª.</p>
            
            <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: right;">
                <h4 style="margin-bottom: 10px;">××¤×©×¨×•×™×•×ª ×–××™× ×•×ª:</h4>
                <ol style="margin: 10px 20px;">
                    <li style="margin: 5px 0;">× ×¡×” ×œ×‘×—×•×¨ ×—× ×™×•×Ÿ ×¡×¤×¦×™×¤×™ ××”×¨×©×™××” ×œ××¢×œ×”</li>
                    <li style="margin: 5px 0;">×”×©×ª××© ×‘×›×¤×ª×•×¨ "×˜×¢×Ÿ ××§×•×‘×¥ CSV" ×œ×˜×¢×™× ×ª × ×ª×•× ×™× ××§×•×‘×¥</li>
                    <li style="margin: 5px 0;">× ×¡×” ×œ×”×ª×—×‘×¨ ××—×“×© ×œ××¢×¨×›×ª</li>
                </ol>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="location.reload()" style="
                    margin: 5px;
                    padding: 10px 20px;
                    background: var(--primary);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                ">×¨×¢× ×Ÿ ×“×£</button>
                
                <button onclick="window.location.href='/logout'" style="
                    margin: 5px;
                    padding: 10px 20px;
                    background: #6C6C70;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                ">×”×ª×—×‘×¨ ××—×“×©</button>
                
                <button onclick="tryLoadWithoutGroup()" style="
                    margin: 5px;
                    padding: 10px 20px;
                    background: #34C759;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                ">× ×¡×” ×œ×œ× ×¡×™× ×•×Ÿ ×§×‘×•×¦×”</button>
            </div>
            
            <p style="margin-top: 20px; font-size: 12px; color: #999;">
                ×§×•×“ ×©×’×™××”: GROUP_ACCESS_ERROR | ×ª××¨×™×š: ${new Date().toLocaleString('he-IL')}
            </p>
        </div>
    `;
    throw new Error(errorMessage);
}

// Update dashboard with current data
function updateDashboard() {
    if (currentData.length === 0) {
        showError('×œ× × ××¦××• × ×ª×•× ×™× ×œ×ª×§×•×¤×” ×”××‘×•×§×©×ª');
        return;
    }
    
    // Debug: log first data item to see field names
    console.log('Sample data item:', currentData[0]);
    console.log('Available fields:', Object.keys(currentData[0]));
    
    // Check if single parking mode
    const uniqueParkings = [...new Set(currentData.map(d => d.parking_name))];
    isSingleParkingMode = uniqueParkings.length === 1;
    
    if (isSingleParkingMode) {
        document.body.classList.add('single-parking-mode');
    } else {
        document.body.classList.remove('single-parking-mode');
    }
    
    // Update all components
    updateStats();
    updateCharts();
    updateAlerts();
    
    // Show dashboard content
    document.getElementById('dashboardContent').style.display = 'block';
}

// Update statistics cards
function updateStats() {
    const stats = calculateStats();
    const changes = calculateStatChanges(); // Calculate percentage changes
    
    const statsHTML = `
        <div class="stat-card" data-stat-type="revenue">
            <div class="icon" style="background: linear-gradient(135deg, #007AFF, #5AC8FA);">ğŸ’°</div>
            <h3>×¡×”"×› ×”×›× ×¡×•×ª</h3>
            <div class="value">â‚ª${stats.totalRevenue.toLocaleString()}</div>
            ${changes.revenue !== null ? `
            <div class="change ${changes.revenue >= 0 ? 'positive' : 'negative'}">
                <span>${changes.revenue >= 0 ? 'â–²' : 'â–¼'}</span>
                <span>${Math.abs(changes.revenue).toFixed(1)}%</span>
            </div>
            ` : '<div class="change neutral">×œ×œ× × ×ª×•× ×™ ×”×©×•×•××”</div>'}
            <div class="subtext">××›×œ ×××¦×¢×™ ×”×ª×©×œ×•×</div>
            ${stats.totalTsper3 > 0 ? `<div class="tsper3-line">â‚ª${stats.totalTsper3.toLocaleString()}</div>` : ''}
        </div>
        
        <div class="stat-card" data-stat-type="entries">
            <div class="icon" style="background: linear-gradient(135deg, #34C759, #30D158);">ğŸš—</div>
            <h3>×¡×”"×› ×›× ×™×¡×•×ª</h3>
            <div class="value">${stats.totalEntries.toLocaleString()}</div>
            ${changes.entries !== null ? `
            <div class="change ${changes.entries >= 0 ? 'positive' : 'negative'}">
                <span>${changes.entries >= 0 ? 'â–²' : 'â–¼'}</span>
                <span>${Math.abs(changes.entries).toFixed(1)}%</span>
            </div>
            ` : '<div class="change neutral">×œ×œ× × ×ª×•× ×™ ×”×©×•×•××”</div>'}
            <div class="subtext">${stats.dailyAvgEntries.toLocaleString()} ×‘×××•×¦×¢ ×œ×™×•×</div>
            ${stats.totalExits > 0 ? `<div class="exit-line">×™×¦×™××•×ª: ${stats.totalExits.toLocaleString()}</div>` : ''}
        </div>
        
        <div class="stat-card" data-stat-type="casual">
            <div class="icon" style="background: linear-gradient(135deg, #5856D6, #6E6CE3);">ğŸ‘¤</div>
            <h3>××–×“×× ×™×</h3>
            <div class="value">${stats.totalCasual.toLocaleString()}</div>
            <div class="change neutral">${stats.casualPercent.toFixed(1)}% ××”×›× ×™×¡×•×ª</div>
            <div class="subtext">×›× ×™×¡×•×ª ×œ×œ× ×× ×•×™</div>
            ${stats.totalExitsCasual > 0 ? `<div class="exit-line">×™×¦×™××•×ª: ${stats.totalExitsCasual.toLocaleString()}</div>` : ''}
        </div>
        
        <div class="stat-card" data-stat-type="members">
            <div class="icon" style="background: linear-gradient(135deg, #FF9500, #FF9F0A);">â­</div>
            <h3>×× ×•×™×™×</h3>
            <div class="value">${stats.totalMembers.toLocaleString()}</div>
            <div class="change neutral">${stats.memberPercent.toFixed(1)}% ××”×›× ×™×¡×•×ª</div>
            <div class="subtext">×›× ×™×¡×•×ª ×¢× ×× ×•×™</div>
            ${stats.totalExitsMembers > 0 ? `<div class="exit-line">×™×¦×™××•×ª: ${stats.totalExitsMembers.toLocaleString()}</div>` : ''}
        </div>
        
        ${stats.totalApp > 0 ? `
        <div class="stat-card" data-stat-type="app">
            <div class="icon" style="background: linear-gradient(135deg, #AF52DE, #C969FF);">ğŸ“±</div>
            <h3>××¤×œ×™×§×¦×™×”</h3>
            <div class="value">${stats.totalApp.toLocaleString()}</div>
            <div class="change neutral">${stats.appPercent.toFixed(1)}% ××”×›× ×™×¡×•×ª</div>
            <div class="subtext">×›× ×™×¡×•×ª ×“×¨×š ××¤×œ×™×§×¦×™×”</div>
        </div>
        ` : ''}
        
        <div class="stat-card" data-stat-type="barriers" ${isGroup && !isSingleParkingMode ? 'style="cursor: pointer;"' : ''}>
            <div class="icon" style="background: linear-gradient(135deg, #FF3B30, #FF6961);">ğŸš§</div>
            <h3>×¤×ª×™×—×•×ª ××—×¡×•×</h3>
            <div class="value">${stats.totalBarrier.toLocaleString()}</div>
            <div class="change ${stats.barrierPercent > 5 ? 'negative' : 'positive'}">
                ${stats.barrierPercent.toFixed(1)}% ××”×›× ×™×¡×•×ª
            </div>
            <div class="subtext">${stats.barrierPerEntry.toFixed(2)} ×œ×›×œ ×›× ×™×¡×”</div>
        </div>
        
        <div class="stat-card" data-stat-type="cash">
            <div class="icon" style="background: linear-gradient(135deg, #30D158, #34C759);">ğŸ’µ</div>
            <h3>××–×•××Ÿ</h3>
            <div class="value">â‚ª${stats.totalCash.toLocaleString()}</div>
            <div class="change neutral">${stats.cashPercent.toFixed(1)}%</div>
            <div class="subtext">××¡×š ×”×”×›× ×¡×•×ª</div>
        </div>
        
        <div class="stat-card" data-stat-type="credit">
            <div class="icon" style="background: linear-gradient(135deg, #007AFF, #0051D5);">ğŸ’³</div>
            <h3>××©×¨××™</h3>
            <div class="value">â‚ª${stats.totalCredit.toLocaleString()}</div>
            <div class="change neutral">${stats.creditPercent.toFixed(1)}%</div>
            <div class="subtext">××¡×š ×”×”×›× ×¡×•×ª</div>
        </div>
        
        <div class="stat-card" data-stat-type="pango">
            <div class="icon" style="background: linear-gradient(135deg, #5856D6, #AF52DE);">ğŸ“²</div>
            <h3>×¤× ×’×•</h3>
            <div class="value">â‚ª${stats.totalPango.toLocaleString()}</div>
            <div class="change neutral">${stats.pangoPercent.toFixed(1)}%</div>
            <div class="subtext">××¡×š ×”×”×›× ×¡×•×ª</div>
        </div>
        
        <div class="stat-card" data-stat-type="cello">
            <div class="icon" style="background: linear-gradient(135deg, #FF9500, #FF3B30);">ğŸ“</div>
            <h3>×¡×œ×•</h3>
            <div class="value">â‚ª${stats.totalCello.toLocaleString()}</div>
            <div class="change neutral">${stats.celloPercent.toFixed(1)}%</div>
            <div class="subtext">××¡×š ×”×”×›× ×¡×•×ª</div>
        </div>
        
        <div class="stat-card" data-stat-type="avg-revenue">
            <div class="icon" style="background: linear-gradient(135deg, #00C7BE, #30D158);">ğŸ“Š</div>
            <h3>×××•×¦×¢ ×™×•××™</h3>
            <div class="value">â‚ª${stats.dailyAvgRevenue.toLocaleString()}</div>
            <div class="change neutral">${stats.uniqueDays} ×™××™×</div>
            <div class="subtext">×”×›× ×¡×” ×™×•××™×ª ×××•×¦×¢×ª</div>
        </div>
        
        ${!isSingleParkingMode ? `
        <div class="stat-card multi-parking-only" data-stat-type="parkings">
            <div class="icon" style="background: linear-gradient(135deg, #FF3B30, #FF9500);">ğŸ¢</div>
            <h3>×—× ×™×•× ×™× ×¤×¢×™×œ×™×</h3>
            <div class="value">${stats.uniqueParkings}</div>
            <div class="change neutral">××ª×•×š ${userParkings.length}</div>
            <div class="subtext">×—× ×™×•× ×™× ×‘×¨×©×ª</div>
        </div>
        ` : ''}
    `;
    
    document.getElementById('statsGrid').innerHTML = statsHTML;
    
    // Add hover functionality for group users
    if (isGroup && !isSingleParkingMode) {
        setupStatCardHovers();
    }
}

// Calculate statistics
function calculateStats() {
    console.log('Calculating stats for', currentData.length, 'records');
    
    const totalRevenue = currentData.reduce((sum, d) => sum + (d.total_revenue_shekels || 0), 0);
    const totalCash = currentData.reduce((sum, d) => sum + (d.s_cash_shekels || 0), 0);
    const totalCredit = currentData.reduce((sum, d) => sum + (d.s_credit_shekels || 0), 0);
    const totalPango = currentData.reduce((sum, d) => sum + (d.s_pango_shekels || 0), 0);
    const totalCello = currentData.reduce((sum, d) => sum + (d.s_celo_shekels || 0), 0);
    
    const totalEntries = currentData.reduce((sum, d) => sum + (d.t_entry_tot || 0), 0);
    const totalCasual = currentData.reduce((sum, d) => sum + (d.t_entry_s || 0), 0);
    const totalMembers = currentData.reduce((sum, d) => sum + (d.t_entry_p || 0), 0);
    const totalApp = currentData.reduce((sum, d) => sum + (d.t_entry_ap || 0), 0);
    
    // Add exits data
    const totalExits = currentData.reduce((sum, d) => sum + (d.t_exit_tot || 0), 0);
    const totalExitsCasual = currentData.reduce((sum, d) => sum + (d.t_exit_s || 0), 0);
    const totalExitsMembers = currentData.reduce((sum, d) => sum + (d.t_exit_p || 0), 0);
    
    // Add tsper3 data
    const totalTsper3 = currentData.reduce((sum, d) => sum + (d.tsper3 || 0), 0);
    
    const totalBarrier = currentData.reduce((sum, d) => sum + (d.t_open_b || 0), 0);
    
    const uniqueDays = [...new Set(currentData.map(d => d.report_date))].length;
    const uniqueParkings = [...new Set(currentData.map(d => d.parking_name))].length;
    
    console.log('Stats calculated:', {
        totalRevenue,
        totalEntries,
        uniqueDays,
        uniqueParkings,
        parkingNames: [...new Set(currentData.map(d => d.parking_name))]
    });
    
    return {
        totalRevenue,
        totalCash,
        totalCredit,
        totalPango,
        totalCello,
        totalEntries,
        totalCasual,
        totalMembers,
        totalApp,
        totalExits,
        totalExitsCasual,
        totalExitsMembers,
        totalTsper3,
        totalBarrier,
        uniqueDays,
        uniqueParkings,
        
        // Percentages
        cashPercent: totalRevenue > 0 ? (totalCash / totalRevenue) * 100 : 0,
        creditPercent: totalRevenue > 0 ? (totalCredit / totalRevenue) * 100 : 0,
        pangoPercent: totalRevenue > 0 ? (totalPango / totalRevenue) * 100 : 0,
        celloPercent: totalRevenue > 0 ? (totalCello / totalRevenue) * 100 : 0,
        
        casualPercent: totalEntries > 0 ? (totalCasual / totalEntries) * 100 : 0,
        memberPercent: totalEntries > 0 ? (totalMembers / totalEntries) * 100 : 0,
        appPercent: totalEntries > 0 ? (totalApp / totalEntries) * 100 : 0,
        
        barrierPercent: totalEntries > 0 ? (totalBarrier / totalEntries) * 100 : 0,
        barrierPerEntry: totalEntries > 0 ? totalBarrier / totalEntries : 0,
        
        // Averages
        dailyAvgRevenue: uniqueDays > 0 ? Math.round(totalRevenue / uniqueDays) : 0,
        dailyAvgEntries: uniqueDays > 0 ? Math.round(totalEntries / uniqueDays) : 0,
    };
}

// Helper function to get week key (format: YYYY-WW)
function getWeekKey(dateString) {
    const date = new Date(dateString);
    const year = date.getFullYear();
    
    // ×—×™×©×•×‘ ××¡×¤×¨ ×”×©×‘×•×¢ ×‘×©× ×”
    const firstDayOfYear = new Date(year, 0, 1);
    const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
    const weekNumber = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
    
    return `${year}-W${weekNumber.toString().padStart(2, '0')}`;
}

// Helper function to get month key (format: YYYY-MM)
function getMonthKey(dateString) {
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    return `${year}-${month}`;
}

// Group data by period (day/week/month)
function groupDataByPeriod(data, mode) {
    const grouped = {};
    
    data.forEach(d => {
        let key;
        switch(mode) {
            case 'daily':
                key = d.report_date;
                break;
            case 'weekly':
                key = getWeekKey(d.report_date);
                break;
            case 'monthly':
                key = getMonthKey(d.report_date);
                break;
            default:
                key = d.report_date;
        }
        
        if (!grouped[key]) {
            grouped[key] = {
                revenue: 0,
                entries: 0,
                exits: 0,
                barriers: 0,
                cash: 0,
                credit: 0,
                pango: 0,
                cello: 0,
                dates: []
            };
        }
        
        grouped[key].revenue += d.total_revenue_shekels || 0;
        grouped[key].entries += d.t_entry_tot || 0;
        grouped[key].exits += d.t_exit_tot || 0;
        grouped[key].barriers += d.t_open_b || 0;
        grouped[key].cash += d.s_cash_shekels || 0;
        grouped[key].credit += d.s_credit_shekels || 0;
        grouped[key].pango += d.s_pango_shekels || 0;
        grouped[key].cello += d.s_celo_shekels || 0;
        grouped[key].dates.push(d.report_date);
    });
    
    return grouped;
}

// Format period label for display
function formatPeriodLabel(key, mode) {
    switch(mode) {
        case 'daily':
            return formatDateForDisplay(key);
        case 'weekly':
            // Format: W45-2024
            const [year, week] = key.split('-W');
            return `×©×‘×•×¢ ${week}`;
        case 'monthly':
            // Format: 2024-11
            const [yearM, month] = key.split('-');
            const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', 
                              '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
            return monthNames[parseInt(month) - 1];
        default:
            return key;
    }
}

// Calculate percentage changes for statistics
function calculateStatChanges() {
    // This would compare with previous period data
    // For now, return placeholder values
    // In production, this would fetch and compare with historical data
    
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    // Calculate if we have enough data for comparison
    const dates = [...new Set(currentData.map(d => d.report_date))].sort();
    if (dates.length < 2) {
        return {
            revenue: null,
            entries: null,
            barriers: null
        };
    }
    
    // Compare last date with previous date (simplified for demo)
    const lastDate = dates[dates.length - 1];
    const prevDate = dates[dates.length - 2];
    
    const lastData = currentData.filter(d => d.report_date === lastDate);
    const prevData = currentData.filter(d => d.report_date === prevDate);
    
    const lastRevenue = lastData.reduce((sum, d) => sum + (d.total_revenue_shekels || 0), 0);
    const prevRevenue = prevData.reduce((sum, d) => sum + (d.total_revenue_shekels || 0), 0);
    
    const lastEntries = lastData.reduce((sum, d) => sum + (d.t_entry_tot || 0), 0);
    const prevEntries = prevData.reduce((sum, d) => sum + (d.t_entry_tot || 0), 0);
    
    return {
        revenue: prevRevenue > 0 ? ((lastRevenue - prevRevenue) / prevRevenue) * 100 : null,
        entries: prevEntries > 0 ? ((lastEntries - prevEntries) / prevEntries) * 100 : null,
        barriers: null // Can be calculated similarly if needed
    };
}

// Update all charts
function updateCharts() {
    createRevenueChart();
    createPaymentChart();
    createEntriesChart();
    createDailyChart();
    updateStayDuration();
    createBarrierChart();
    updateEncodersInfo();
    
    if (!isSingleParkingMode) {
        createParkingComparisonChart();
        updateParkingRanking();
    }
}

// Create revenue trends chart
function createRevenueChart() {
    const ctx = document.getElementById('revenueChart').getContext('2d');
    
    // Group data by selected period
    const groupedData = groupDataByPeriod(currentData, currentViewMode);
    
    const periods = Object.keys(groupedData).sort();
    const revenues = periods.map(period => groupedData[period].revenue);
    const entries = periods.map(period => groupedData[period].entries);
    
    // Format labels for display
    const formattedLabels = periods.map(period => formatPeriodLabel(period, currentViewMode));
    
    if (charts.revenue) charts.revenue.destroy();
    
    charts.revenue = new Chart(ctx, {
        type: chartTypes.revenue || 'line',
        data: {
            labels: formattedLabels,
            datasets: [{
                label: '×”×›× ×¡×•×ª',
                data: revenues,
                borderColor: '#007AFF',
                backgroundColor: chartTypes.revenue === 'bar' ? 'rgba(0, 122, 255, 0.8)' : 'rgba(0, 122, 255, 0.1)',
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderRadius: chartTypes.revenue === 'bar' ? 8 : 0,
                yAxisID: 'y'
            }, {
                label: '×›× ×™×¡×•×ª',
                data: entries,
                borderColor: '#5AC8FA',
                backgroundColor: chartTypes.revenue === 'bar' ? 'rgba(90, 200, 250, 0.8)' : 'rgba(90, 200, 250, 0.1)',
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderRadius: chartTypes.revenue === 'bar' ? 8 : 0,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                    displayColors: true,
                    callbacks: {
                        title: function(tooltipItems) {
                            // Ensure date is shown in DD/MM/YYYY format
                            return tooltipItems[0].label;
                        },
                        label: function(context) {
                            if (context.datasetIndex === 0) {
                                return `×”×›× ×¡×•×ª: â‚ª${context.parsed.y.toLocaleString()}`;
                            } else {
                                return `×›× ×™×¡×•×ª: ${context.parsed.y.toLocaleString()}`;
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return 'â‚ª' + value.toLocaleString();
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: {
                        display: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Create payment methods chart
function createPaymentChart() {
    const ctx = document.getElementById('paymentChart').getContext('2d');
    
    const totalCash = currentData.reduce((sum, d) => sum + (d.s_cash_shekels || 0), 0);
    const totalCredit = currentData.reduce((sum, d) => sum + (d.s_credit_shekels || 0), 0);
    const totalPango = currentData.reduce((sum, d) => sum + (d.s_pango_shekels || 0), 0);
    const totalCello = currentData.reduce((sum, d) => sum + (d.s_celo_shekels || 0), 0);
    
    if (charts.payment) charts.payment.destroy();
    
    charts.payment = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['××–×•××Ÿ', '××©×¨××™', '×¤× ×’×•', '×¡×œ×•'],
            datasets: [{
                data: [totalCash, totalCredit, totalPango, totalCello],
                backgroundColor: [
                    '#007AFF',
                    '#5AC8FA',
                    '#AF52DE',
                    '#FF9500'
                ],
                borderWidth: 3,
                borderColor: '#FFFFFF'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return {
                                        text: `${label}: â‚ª${Math.round(value).toLocaleString()} (${percentage}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: '#fff',
                                        lineWidth: 2,
                                        hidden: isNaN(value),
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : '0';
                            return `${context.label}: â‚ª${Math.round(context.parsed).toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Create entries chart
function createEntriesChart() {
    const ctx = document.getElementById('entriesChart').getContext('2d');
    
    const totalCasual = currentData.reduce((sum, d) => sum + (d.t_entry_s || 0), 0);
    const totalMembers = currentData.reduce((sum, d) => sum + (d.t_entry_p || 0), 0);
    const totalApp = currentData.reduce((sum, d) => sum + (d.t_entry_ap || 0), 0);
    
    const chartData = {
        labels: ['××–×“×× ×™×', '×× ×•×™×™×'],
        datasets: [{
            data: [totalCasual, totalMembers],
            backgroundColor: ['#34C759', '#007AFF'],
            borderWidth: 3,
            borderColor: '#FFFFFF'
        }]
    };
    
    if (totalApp > 0) {
        chartData.labels.push('××¤×œ×™×§×¦×™×”');
        chartData.datasets[0].data.push(totalApp);
        chartData.datasets[0].backgroundColor.push('#AF52DE');
    }
    
    if (charts.entries) charts.entries.destroy();
    
    charts.entries = new Chart(ctx, {
        type: 'pie',
        data: chartData,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return {
                                        text: `${label}: ${value.toLocaleString()} (${percentage}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: '#fff',
                                        lineWidth: 2,
                                        hidden: isNaN(value),
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                }
            }
        }
    });
}

// Create daily/weekly/monthly comparison chart
function createDailyChart() {
    const ctx = document.getElementById('dailyChart').getContext('2d');
    
    // Update title based on view mode
    const titleElement = document.getElementById('comparisonTitle');
    let labels, avgRevenues, avgEntries;
    
    if (currentViewMode === 'daily') {
        // Daily view - show days of week
        titleElement.textContent = '×”×©×•×•××” ×™×•××™×ª';
        
        const weekdays = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
        const weeklyData = {};
        
        weekdays.forEach(day => {
            weeklyData[day] = { revenue: 0, entries: 0, count: 0 };
        });
        
        currentData.forEach(d => {
            const date = new Date(d.report_date);
            const dayName = weekdays[date.getDay()];
            if (weeklyData[dayName]) {
                weeklyData[dayName].revenue += d.total_revenue_shekels || 0;
                weeklyData[dayName].entries += d.t_entry_tot || 0;
                weeklyData[dayName].count++;
            }
        });
        
        labels = weekdays;
        avgRevenues = weekdays.map(day => 
            weeklyData[day].count > 0 ? weeklyData[day].revenue / weeklyData[day].count : 0
        );
        avgEntries = weekdays.map(day => 
            weeklyData[day].count > 0 ? weeklyData[day].entries / weeklyData[day].count : 0
        );
        
    } else if (currentViewMode === 'weekly') {
        // Weekly view - show week numbers
        titleElement.textContent = '×”×©×•×•××” ×©×‘×•×¢×™×ª';
        
        const groupedData = groupDataByPeriod(currentData, 'weekly');
        const weeks = Object.keys(groupedData).sort();
        
        labels = weeks.map(week => formatPeriodLabel(week, 'weekly'));
        avgRevenues = weeks.map(week => groupedData[week].revenue);
        avgEntries = weeks.map(week => groupedData[week].entries);
        
    } else {
        // Monthly view - show months
        titleElement.textContent = '×”×©×•×•××” ×—×•×“×©×™×ª';
        
        const groupedData = groupDataByPeriod(currentData, 'monthly');
        const months = Object.keys(groupedData).sort();
        
        labels = months.map(month => formatPeriodLabel(month, 'monthly'));
        avgRevenues = months.map(month => groupedData[month].revenue);
        avgEntries = months.map(month => groupedData[month].entries);
    }
    
    if (charts.daily) charts.daily.destroy();
    
    charts.daily = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: currentViewMode === 'daily' ? '×××•×¦×¢ ×”×›× ×¡×•×ª' : '×¡×š ×”×›× ×¡×•×ª',
                data: avgRevenues,
                backgroundColor: '#007AFF',
                borderRadius: 8,
                yAxisID: 'y'
            }, {
                label: currentViewMode === 'daily' ? '×××•×¦×¢ ×›× ×™×¡×•×ª' : '×¡×š ×›× ×™×¡×•×ª',
                data: avgEntries,
                backgroundColor: '#5AC8FA',
                borderRadius: 8,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                    callbacks: {
                        title: function(tooltipItems) {
                            // Show the label as is (day name, week number, or month name)
                            return tooltipItems[0].label;
                        },
                        label: function(context) {
                            if (context.datasetIndex === 0) {
                                return `×”×›× ×¡×•×ª: â‚ª${Math.round(context.parsed.y).toLocaleString()}`;
                            } else {
                                return `×›× ×™×¡×•×ª: ${Math.round(context.parsed.y).toLocaleString()}`;
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return 'â‚ª' + value.toLocaleString();
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: {
                        display: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Update stay duration display
function updateStayDuration() {
    // Calculate individual totals
    const stay015 = currentData.reduce((sum, d) => sum + (d.stay_015 || 0), 0);
    const stay030 = currentData.reduce((sum, d) => sum + (d.stay_030 || 0), 0);
    const stay045 = currentData.reduce((sum, d) => sum + (d.stay_045 || 0), 0);
    const stay060 = currentData.reduce((sum, d) => sum + (d.stay_060 || 0), 0);
    
    // Combined 0-60 minutes
    const stay0to60 = stay015 + stay030 + stay045 + stay060;
    
    // Prepare durations for display (combining 0-60)
    const durations = {
        '0-60 ×“×§×•×ª': stay0to60,
        '×¢×“ 2 ×©×¢×•×ª': currentData.reduce((sum, d) => sum + (d.stay_2 || 0), 0),
        '×¢×“ 3 ×©×¢×•×ª': currentData.reduce((sum, d) => sum + (d.stay_3 || 0), 0),
        '×¢×“ 4 ×©×¢×•×ª': currentData.reduce((sum, d) => sum + (d.stay_4 || 0), 0),
        '×¢×“ 5 ×©×¢×•×ª': currentData.reduce((sum, d) => sum + (d.stay_5 || 0), 0),
        '×¢×“ 6 ×©×¢×•×ª': currentData.reduce((sum, d) => sum + (d.stay_6 || 0), 0),
        '7-24 ×©×¢×•×ª': currentData.reduce((sum, d) => sum + (d.stay_724 || 0), 0),
    };
    
    if (stayDurationViewMode === 'cards') {
        // Show cards view
        document.getElementById('stayDurationGrid').style.display = 'grid';
        document.getElementById('stayDurationChart').style.display = 'none';
        
        // Calculate total for percentages
        const total = Object.values(durations).reduce((sum, val) => sum + val, 0) + stay015; // Include stay015 in total to avoid double counting
        const actualTotal = Object.values(durations).reduce((sum, val) => sum + val, 0);
        
        // Generate HTML for duration cards
        let html = '';
        
        // Add 0-60 minutes card with 0-15 highlight
        const percentage060 = actualTotal > 0 ? ((stay0to60 / actualTotal) * 100).toFixed(1) : '0';
        const percentage015 = actualTotal > 0 ? ((stay015 / actualTotal) * 100).toFixed(1) : '0';
        const percentage015of60 = stay0to60 > 0 ? ((stay015 / stay0to60) * 100).toFixed(1) : '0';
        
        html += `
            <div class="stay-duration-item stay-060" style="position: relative; overflow: visible; border: 2px solid var(--primary); background: linear-gradient(135deg, rgba(0, 122, 255, 0.05), rgba(0, 122, 255, 0.02));">
                <div class="stay-duration-time" style="font-weight: 700; color: var(--primary);">0-60 ×“×§×•×ª</div>
                <div class="stay-duration-value" style="color: var(--primary);">${stay0to60.toLocaleString()}</div>
                <div class="stay-duration-percent">${percentage060}%</div>
                <div style="
                    position: absolute;
                    bottom: -38px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(255, 255, 255, 0.95);
                    padding: 10px 16px;
                    border-radius: 10px;
                    font-size: 13px;
                    color: var(--primary);
                    white-space: nowrap;
                    border: 2px solid rgba(0, 122, 255, 0.3);
                    box-shadow: 0 4px 12px rgba(0, 122, 255, 0.15);
                    z-index: 10;
                ">
                    <strong style="font-size: 14px;">0-15 ×“×§×•×ª:</strong> ${stay015.toLocaleString()} 
                    <span style="color: var(--text-secondary);">(${percentage015of60}% ××ª×•×š 0-60)</span>
                </div>
            </div>
        `;
        
        // Add other duration cards
        Object.entries(durations).forEach(([time, value]) => {
            if (time !== '0-60 ×“×§×•×ª' && value > 0) {
                const percentage = actualTotal > 0 ? ((value / actualTotal) * 100).toFixed(1) : '0';
                html += `
                    <div class="stay-duration-item">
                        <div class="stay-duration-time">${time}</div>
                        <div class="stay-duration-value">${value.toLocaleString()}</div>
                        <div class="stay-duration-percent">${percentage}%</div>
                    </div>
                `;
            }
        });
        
        document.getElementById('stayDurationGrid').innerHTML = html;
        
    } else {
        // Show chart view
        document.getElementById('stayDurationGrid').style.display = 'none';
        document.getElementById('stayDurationChart').style.display = 'block';
        
        createStayDurationChart(durations, stayDurationViewMode, stay015, stay0to60);
    }
}

// Create stay duration chart
function createStayDurationChart(durations, chartType, stay015, stay0to60) {
    const ctx = document.getElementById('stayDurationChart').getContext('2d');
    
    // Filter out empty values for cleaner display
    const filteredData = Object.entries(durations).filter(([_, value]) => value > 0);
    let labels = filteredData.map(([label, _]) => label);
    let values = filteredData.map(([_, value]) => value);
    
    // For bar chart, add special handling for 0-15 minutes
    if (chartType === 'bar') {
        // Find the index of 0-60 minutes
        const index060 = labels.indexOf('0-60 ×“×§×•×ª');
        if (index060 !== -1) {
            // Insert 0-15 minutes after 0-60 minutes
            labels.splice(index060 + 1, 0, '0-15 ×“×§×•×ª (×—×œ×§ ×-0-60)');
            values.splice(index060 + 1, 0, stay015);
        }
    }
    
    if (charts.stayDuration) charts.stayDuration.destroy();
    
    const chartConfig = {
        type: chartType === 'bar' ? 'bar' : 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: '××¡×¤×¨ ×¨×›×‘×™×',
                data: values,
                backgroundColor: chartType === 'bar' ? 
                    labels.map(label => label.includes('0-15') ? 'rgba(0, 122, 255, 0.4)' : 'rgba(0, 122, 255, 0.8)') :
                    [
                        '#007AFF', '#5AC8FA', '#34C759', '#FF9500', 
                        '#FF3B30', '#AF52DE', '#5856D6', '#FF2D55',
                        '#00C7BE', '#30D158', '#FFD60A', '#BF5AF2'
                    ],
                borderWidth: chartType === 'bar' ? 
                    labels.map(label => label.includes('0-15') ? 2 : 0) : 
                    chartType === 'pie' ? 2 : 0,
                borderColor: chartType === 'bar' ? 
                    labels.map(label => label.includes('0-15') ? '#007AFF' : '#fff') : 
                    '#fff',
                borderRadius: chartType === 'bar' ? 8 : 0,
                borderDash: chartType === 'bar' ? 
                    labels.map(label => label.includes('0-15') ? [5, 5] : []) : 
                    undefined
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: chartType === 'pie',
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0';
                                
                                // Special handling for 0-60 minutes in pie chart
                                let displayText = `${label}: ${value.toLocaleString()} (${percentage}%)`;
                                if (label === '0-60 ×“×§×•×ª' && stay015 && stay0to60) {
                                    const percentage015of60 = stay0to60 > 0 ? ((stay015 / stay0to60) * 100).toFixed(1) : '0';
                                    displayText += ` | 0-15: ${stay015.toLocaleString()} (${percentage015of60}%)`;
                                    }
                                    
                                    return {
                                        text: displayText,
                                        fillStyle: chartType === 'pie' ? 
                                            data.datasets[0].backgroundColor[i] : 
                                            data.datasets[0].backgroundColor,
                                        strokeStyle: '#fff',
                                        lineWidth: 2,
                                        hidden: isNaN(value),
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            // Get the actual value based on chart type
                            let value;
                            if (chartType === 'bar') {
                                value = context.parsed.y;
                            } else {
                                value = context.parsed;
                            }
                            
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 && value ? ((value / total) * 100).toFixed(1) : '0';
                            
                            // Special handling for 0-15 minutes
                            if (context.label && (context.label.includes('0-15') || context.label.includes('×—×œ×§'))) {
                                const actualTotal = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage015 = actualTotal > 0 ? ((stay015 / actualTotal) * 100).toFixed(1) : '0';
                                const of60Percent = stay0to60 > 0 ? ((stay015 / stay0to60) * 100).toFixed(1) : '0';
                                return `0-15 ×“×§×•×ª: ${value.toLocaleString()} ×¨×›×‘×™× (${percentage015}% ××”×¡×”"×›, ${of60Percent}% ××ª×•×š 0-60)`;
                            }
                            
                            if (chartType === 'bar') {
                                return `${value.toLocaleString()} ×¨×›×‘×™× (${percentage}%)`;
                            } else {
                                // Pie chart
                                if (context.label === '0-60 ×“×§×•×ª' && stay015 && stay0to60) {
                                    const percentage015of60 = stay0to60 > 0 ? ((stay015 / stay0to60) * 100).toFixed(1) : '0';
                                    return [
                                        `${context.label}: ${value.toLocaleString()} (${percentage}%)`,
                                        `××ª×•×›× 0-15 ×“×§×•×ª: ${stay015.toLocaleString()} (${percentage015of60}%)`
                                    ];
                                }
                                return `${context.label}: ${value.toLocaleString()} (${percentage}%)`;
                            }
                        }
                    }
                }
            },
            scales: chartType === 'bar' ? {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            } : {}
        }
    };
    
    charts.stayDuration = new Chart(ctx, chartConfig);
}

// Toggle stay duration view
function toggleStayDurationView(viewType) {
    stayDurationViewMode = viewType;
    
    // Update button states
    document.querySelectorAll('.chart-section:has(#stayDurationGrid) .chart-option-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Set active button
    const activeBtn = Array.from(document.querySelectorAll('.chart-section:has(#stayDurationGrid) .chart-option-btn'))
        .find(btn => {
            if (viewType === 'cards' && btn.textContent.includes('×›×¨×˜×™×¡×™×')) return true;
            if (viewType === 'bar' && btn.textContent.includes('×¢××•×“×•×ª')) return true;
            if (viewType === 'pie' && btn.textContent.includes('×¢×•×’×”')) return true;
            return false;
        });
    
    if (activeBtn) activeBtn.classList.add('active');
    
    // Update display
    updateStayDuration();
}

// Create barrier chart
function createBarrierChart() {
    const ctx = document.getElementById('barrierChart').getContext('2d');
    
    // Group data by selected period
    const groupedData = groupDataByPeriod(currentData, currentViewMode);
    
    const periods = Object.keys(groupedData).sort();
    const barriers = periods.map(period => groupedData[period].barriers);
    
    // Format labels for display
    const formattedLabels = periods.map(period => formatPeriodLabel(period, currentViewMode));
    
    if (charts.barrier) charts.barrier.destroy();
    
    charts.barrier = new Chart(ctx, {
        type: 'line',
        data: {
            labels: formattedLabels,
            datasets: [{
                label: '×¤×ª×™×—×•×ª ××—×¡×•×',
                data: barriers,
                borderColor: '#FF3B30',
                backgroundColor: 'rgba(255, 59, 48, 0.1)',
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                    callbacks: {
                        title: function(tooltipItems) {
                            // Ensure date is shown in DD/MM/YYYY format
                            return tooltipItems[0].label;
                        },
                        label: function(context) {
                            return `×¤×ª×™×—×•×ª ××—×¡×•×: ${context.parsed.y.toLocaleString()}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Create parking comparison chart
function createParkingComparisonChart() {
    const ctx = document.getElementById('parkingComparisonChart').getContext('2d');
    
    // Aggregate data by parking
    const parkingData = {};
    currentData.forEach(d => {
        if (!parkingData[d.parking_name]) {
            parkingData[d.parking_name] = { 
                revenue: 0, 
                entries: 0,
                cash: 0,
                credit: 0,
                pango: 0,
                cello: 0,
                barriers: 0,
                casual: 0,
                members: 0,
                app: 0,
                // Add stay duration totals
                stay015: 0,
                stay030: 0,
                stay045: 0,
                stay060: 0,
                stay2: 0,
                stay3: 0,
                stay4: 0,
                stay5: 0,
                stay6: 0,
                stay724: 0,
                totalStays: 0,
                days: new Set()  // ×”×•×¡×¤×ª days
            };
        }
        parkingData[d.parking_name].revenue += d.total_revenue_shekels || 0;
        parkingData[d.parking_name].entries += d.t_entry_tot || 0;
        parkingData[d.parking_name].cash += d.s_cash_shekels || 0;
        parkingData[d.parking_name].credit += d.s_credit_shekels || 0;
        parkingData[d.parking_name].pango += d.s_pango_shekels || 0;
        parkingData[d.parking_name].cello += d.s_celo_shekels || 0;
        parkingData[d.parking_name].barriers += d.t_open_b || 0;
        parkingData[d.parking_name].casual += d.t_entry_s || 0;
        parkingData[d.parking_name].members += d.t_entry_p || 0;
        parkingData[d.parking_name].app += d.t_entry_ap || 0;
        // Add stay duration data
        parkingData[d.parking_name].stay015 += d.stay_015 || 0;
        parkingData[d.parking_name].stay030 += d.stay_030 || 0;
        parkingData[d.parking_name].stay045 += d.stay_045 || 0;
        parkingData[d.parking_name].stay060 += d.stay_060 || 0;
        parkingData[d.parking_name].stay2 += d.stay_2 || 0;
        parkingData[d.parking_name].stay3 += d.stay_3 || 0;
        parkingData[d.parking_name].stay4 += d.stay_4 || 0;
        parkingData[d.parking_name].stay5 += d.stay_5 || 0;
        parkingData[d.parking_name].stay6 += d.stay_6 || 0;
        parkingData[d.parking_name].stay724 += d.stay_724 || 0;
        // Calculate total stays - accumulate correctly
        parkingData[d.parking_name].totalStays += (d.stay_015 || 0) + (d.stay_030 || 0) + (d.stay_045 || 0) + 
            (d.stay_060 || 0) + (d.stay_2 || 0) + (d.stay_3 || 0) + (d.stay_4 || 0) + 
            (d.stay_5 || 0) + (d.stay_6 || 0) + (d.stay_724 || 0);
        // ×”×•×¡×¤×ª ×”×ª××¨×™×š ×œ-days
        parkingData[d.parking_name].days.add(d.report_date);
    });
    
    // Sort by revenue
    const sortedParkings = Object.entries(parkingData)
        .sort((a, b) => b[1].revenue - a[1].revenue)
        .slice(0, 10); // Top 10
    
    const labels = sortedParkings.map(([name]) => name);
    const revenues = sortedParkings.map(([, data]) => data.revenue);
    const entries = sortedParkings.map(([, data]) => data.entries);
    
    if (charts.parkingComparison) charts.parkingComparison.destroy();
    
    charts.parkingComparison = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '×”×›× ×¡×•×ª',
                data: revenues,
                backgroundColor: '#007AFF',
                borderRadius: 8,
                yAxisID: 'y'
            }, {
                label: '×›× ×™×¡×•×ª',
                data: entries,
                backgroundColor: '#5AC8FA',
                borderRadius: 8,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            onClick: (event, elements) => {
                // Handle click only for group users
                console.log('Click detected. isGroup:', isGroup, 'elements:', elements.length);
                if (isGroup && elements.length > 0) {
                    const index = elements[0].index;
                    const parkingName = labels[index];
                    const data = sortedParkings[index][1];
                    console.log('Showing details for:', parkingName, data);
                    showParkingDetails(parkingName, data);
                }
            },
            onHover: (event, elements) => {
                // Change cursor on hover for group users
                if (isGroup) {
                    ctx.canvas.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            if (context.datasetIndex === 0) {
                                return `×”×›× ×¡×•×ª: â‚ª${context.parsed.y.toLocaleString()}`;
                            } else {
                                return `×›× ×™×¡×•×ª: ${context.parsed.y.toLocaleString()}`;
                            }
                        },
                        afterLabel: function(context) {
                            if (isGroup) {
                                return '×œ×—×¥ ×œ×¤×™×¨×•×˜ ××œ×';
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return 'â‚ª' + value.toLocaleString();
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: {
                        display: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
}

// Update parking ranking
function updateParkingRanking() {
    // Calculate metrics for each parking
    const parkingMetrics = {};
    
    currentData.forEach(d => {
        if (!parkingMetrics[d.parking_name]) {
            parkingMetrics[d.parking_name] = {
                name: d.parking_name,
                revenue: 0,
                entries: 0,
                days: new Set()
            };
        }
        parkingMetrics[d.parking_name].revenue += d.total_revenue_shekels || 0;
        parkingMetrics[d.parking_name].entries += d.t_entry_tot || 0;
        parkingMetrics[d.parking_name].days.add(d.report_date);
    });
    
    // Calculate averages and sort
    const rankings = Object.values(parkingMetrics).map(parking => ({
        name: parking.name,
        totalRevenue: parking.revenue,
        totalEntries: parking.entries,
        avgDailyRevenue: parking.revenue / parking.days.size,
        avgDailyEntries: parking.entries / parking.days.size,
        activeDays: parking.days.size
    })).sort((a, b) => b.totalRevenue - a.totalRevenue);
    
    // Create ranking HTML
    let rankingHTML = '';
    rankings.forEach((parking, index) => {
        const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`;
        
        rankingHTML += `
            <div class="ranking-item" style="
                display: flex;
                align-items: center;
                padding: 20px;
                margin-bottom: 12px;
                background: ${index < 3 ? 'linear-gradient(135deg, rgba(0, 122, 255, 0.05) 0%, rgba(90, 200, 250, 0.05) 100%)' : 'var(--background)'};
                border-radius: 12px;
                transition: all 0.3s ease;
            ">
                <div style="
                    font-size: 24px;
                    font-weight: 700;
                    margin-left: 20px;
                    min-width: 40px;
                ">
                    ${medal}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 18px; margin-bottom: 8px;">
                        ${parking.name}
                    </div>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; color: var(--text-secondary); font-size: 14px;">
                        <span>×”×›× ×¡×•×ª: â‚ª${parking.totalRevenue.toLocaleString()}</span>
                        <span>×›× ×™×¡×•×ª: ${parking.totalEntries.toLocaleString()}</span>
                        <span>×××•×¦×¢ ×™×•××™: â‚ª${Math.round(parking.avgDailyRevenue).toLocaleString()}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('parkingRanking').innerHTML = rankingHTML;
}

// Update encoders info
function updateEncodersInfo() {
    const totalEncoder1 = currentData.reduce((sum, d) => sum + (d.s_encoder1 || 0), 0);
    const totalEncoder2 = currentData.reduce((sum, d) => sum + (d.s_encoder2 || 0), 0);
    const totalEncoder3 = currentData.reduce((sum, d) => sum + (d.s_encoder3 || 0), 0);
    const totalEncoders = currentData.reduce((sum, d) => sum + (d.sencodertot || 0), 0);
    
    const encodersHTML = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            <div style="
                background: var(--background);
                padding: 24px;
                border-radius: 12px;
                text-align: center;
            ">
                <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">
                    ××§×•×“×“ 1
                </div>
                <div style="font-size: 28px; font-weight: 700; color: var(--primary);">
                    ${totalEncoder1.toLocaleString()}
                </div>
            </div>
            
            <div style="
                background: var(--background);
                padding: 24px;
                border-radius: 12px;
                text-align: center;
            ">
                <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">
                    ××§×•×“×“ 2
                </div>
                <div style="font-size: 28px; font-weight: 700; color: var(--primary);">
                    ${totalEncoder2.toLocaleString()}
                </div>
            </div>
            
            <div style="
                background: var(--background);
                padding: 24px;
                border-radius: 12px;
                text-align: center;
            ">
                <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">
                    ××§×•×“×“ 3
                </div>
                <div style="font-size: 28px; font-weight: 700; color: var(--primary);">
                    ${totalEncoder3.toLocaleString()}
                </div>
            </div>
            
            <div style="
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
                padding: 24px;
                border-radius: 12px;
                text-align: center;
            ">
                <div style="color: white; font-size: 14px; margin-bottom: 8px;">
                    ×¡×”"×› ××§×•×“×“×™×
                </div>
                <div style="font-size: 28px; font-weight: 700; color: white;">
                    ${totalEncoders.toLocaleString()}
                </div>
            </div>
        </div>
        
        <div style="
            margin-top: 20px;
            padding: 16px;
            background: rgba(255, 159, 64, 0.1);
            border-radius: 12px;
            color: var(--warning);
            font-size: 14px;
            text-align: center;
        ">
            <strong>×©×™× ×œ×‘:</strong> × ×ª×•× ×™ ×”××§×•×“×“×™× ××•×¦×’×™× ×œ×¦×¤×™×™×” ×‘×œ×‘×“ ×•××™× × × ×›×œ×œ×™× ×‘×¡×™×›×•××™×
        </div>
    `;
    
    document.getElementById('encodersInfo').innerHTML = encodersHTML;
}

// Update alerts
function updateAlerts() {
    const alerts = [];
    
    // Find significant changes
    const recentDays = 7;
    const dates = [...new Set(currentData.map(d => d.report_date))].sort().slice(-recentDays);
    
    if (dates.length >= 2) {
        const lastDate = dates[dates.length - 1];
        const prevDate = dates[dates.length - 2];
        
        const lastData = currentData.filter(d => d.report_date === lastDate);
        const prevData = currentData.filter(d => d.report_date === prevDate);
        
        const lastRevenue = lastData.reduce((sum, d) => sum + (d.total_revenue_shekels || 0), 0);
        const prevRevenue = prevData.reduce((sum, d) => sum + (d.total_revenue_shekels || 0), 0);
        
        const revenueChange = prevRevenue > 0 ? ((lastRevenue - prevRevenue) / prevRevenue) * 100 : 0;
        
        if (Math.abs(revenueChange) > 10) {
            alerts.push({
                type: revenueChange > 0 ? 'positive' : 'negative',
                icon: revenueChange > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰',
                title: `×©×™× ×•×™ ×©×œ ${Math.abs(revenueChange).toFixed(1)}% ×‘×”×›× ×¡×•×ª`,
                description: `×‘×™×•× ${formatDateForDisplay(lastDate)} ×œ×¢×•××ª ${formatDateForDisplay(prevDate)}`
            });
        }
    }
    
    // Check weekend performance
    const weekendData = currentData.filter(d => {
        const date = new Date(d.report_date);
        const day = date.getDay();
        return day === 5 || day === 6; // Friday or Saturday
    });
    
    const weekdayData = currentData.filter(d => {
        const date = new Date(d.report_date);
        const day = date.getDay();
        return day !== 5 && day !== 6;
    });
    
    if (weekendData.length > 0 && weekdayData.length > 0) {
        const avgWeekendRevenue = weekendData.reduce((sum, d) => sum + (d.total_revenue_shekels || 0), 0) / weekendData.length;
        const avgWeekdayRevenue = weekdayData.reduce((sum, d) => sum + (d.total_revenue_shekels || 0), 0) / weekdayData.length;
        
        const weekendDiff = avgWeekdayRevenue > 0 ? ((avgWeekendRevenue - avgWeekdayRevenue) / avgWeekdayRevenue) * 100 : 0;
        
        if (Math.abs(weekendDiff) > 20) {
            alerts.push({
                type: weekendDiff > 0 ? 'positive' : 'negative',
                icon: 'ğŸ“…',
                title: `×¡×•×¤×™ ×©×‘×•×¢ ${weekendDiff > 0 ? '×—×–×§×™×' : '×—×œ×©×™×'} ×‘-${Math.abs(weekendDiff).toFixed(1)}%`,
                description: '×‘×”×©×•×•××” ×œ×™××™ ×—×•×œ'
            });
        }
    }
    
    // Show alerts
    if (alerts.length > 0) {
        document.getElementById('alertsSection').style.display = 'block';
        
        const alertsHTML = alerts.map(alert => `
            <div class="alert-item ${alert.type}">
                <div class="alert-icon">${alert.icon}</div>
                <div class="alert-content">
                    <div class="alert-title">${alert.title}</div>
                    <div class="alert-description">${alert.description}</div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('alertsContainer').innerHTML = alertsHTML;
    } else {
        document.getElementById('alertsSection').style.display = 'none';
    }
}

// Set quick date range
function setQuickRange(range) {
    const today = new Date();
    let startDate, endDate;
    
    switch(range) {
        case 'yesterday':
            startDate = endDate = new Date(today);
            startDate.setDate(startDate.getDate() - 1);
            break;
        case 'currentWeek':
            // ×”×©×‘×•×¢ ×”× ×•×›×—×™ - ××™×•× ×¨××©×•×Ÿ ×¢×“ ×”×™×•× (××• ×¢×“ ×©×‘×ª ×× ×”×™×•× ×©×‘×ª)
            endDate = today;
            startDate = new Date(today);
            // ×—×–×•×¨ ×œ×™×•× ×¨××©×•×Ÿ (0 = ×¨××©×•×Ÿ ×‘×™×©×¨××œ)
            startDate.setDate(startDate.getDate() - today.getDay());
            break;
        case 'lastWeek':
            // ×©×‘×•×¢ ×©×¢×‘×¨ - ××¨××©×•×Ÿ ×¢×“ ×©×‘×ª
            const lastSaturday = new Date(today);
            lastSaturday.setDate(lastSaturday.getDate() - today.getDay() - 1);
            endDate = lastSaturday;
            startDate = new Date(lastSaturday);
            startDate.setDate(startDate.getDate() - 6);
            break;
        case 'currentMonth':
            // ×”×—×•×“×© ×”× ×•×›×—×™ - ××”-1 ×¢×“ ×”×™×•×
            endDate = today;
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            break;
        case 'lastMonth':
            // ×—×•×“×© ×©×¢×‘×¨ - ××”-1 ×¢×“ ×¡×•×£ ×”×—×•×“×©
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            break;
        case 'year':
            endDate = today;
            startDate = new Date(today.getFullYear(), 0, 1);
            break;
    }
    
    document.getElementById('startDate').value = formatDateForInput(startDate);
    document.getElementById('endDate').value = formatDateForInput(endDate);
    
    // Fix date picker display
    fixDatePickerFormat();
    
    // Auto load data
    loadData();
}

// Set view mode (daily/weekly/monthly)
function setViewMode(mode) {
    currentViewMode = mode;
    
    // Update button states
    document.querySelectorAll('.view-mode-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.mode === mode) {
            btn.classList.add('active');
        }
    });
    
    // Update date range based on mode
    updateDateRangeForMode();
    
    // If we have data, update the charts to reflect the new view mode
    if (currentData.length > 0) {
        updateCharts();
    }
}

// Update date range based on current view mode
function updateDateRangeForMode() {
    const startDate = new Date(document.getElementById('startDate').value);
    let endDate = new Date(startDate);
    
    switch(currentViewMode) {
        case 'daily':
            // Keep same date
            break;
        case 'weekly':
            // Set to end of week (6 days later)
            endDate.setDate(endDate.getDate() + 6);
            break;
        case 'monthly':
            // Set to end of month
            endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
            break;
    }
    
    document.getElementById('endDate').value = formatDateForInput(endDate);
    
    // Fix date picker display
    fixDatePickerFormat();
    
    loadData();
}

// Navigate dates forward or backward
function navigateDate(direction) {
    const startDate = new Date(document.getElementById('startDate').value);
    const endDate = new Date(document.getElementById('endDate').value);
    
    switch(currentViewMode) {
        case 'daily':
            startDate.setDate(startDate.getDate() + direction);
            endDate.setDate(endDate.getDate() + direction);
            break;
        case 'weekly':
            startDate.setDate(startDate.getDate() + (direction * 7));
            endDate.setDate(endDate.getDate() + (direction * 7));
            break;
        case 'monthly':
            startDate.setMonth(startDate.getMonth() + direction);
            endDate.setMonth(endDate.getMonth() + direction);
            // Adjust for month end
            endDate = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0);
            break;
    }
    
    document.getElementById('startDate').value = formatDateForInput(startDate);
    document.getElementById('endDate').value = formatDateForInput(endDate);
    
    // Fix date picker display
    fixDatePickerFormat();
    
    loadData();
}

// Show loading state
function showLoading(show) {
    document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

// Show error message
function showError(message) {
    const errorTextElement = document.getElementById('errorText');
    
    // Check if message contains HTML
    if (message.includes('<') && message.includes('>')) {
        errorTextElement.innerHTML = message;
    } else {
        errorTextElement.textContent = message;
    }
    
    document.getElementById('errorMessage').style.display = 'block';
}

// Hide error message
function hideError() {
    document.getElementById('errorMessage').style.display = 'none';
}

// Logout function
function logout() {
    if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¦××ª?')) {
        window.location.href = '/logout';
    }
}

// Try to load data without group filtering
async function tryLoadWithoutGroup() {
    try {
        showLoading(true);
        hideError();
        
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            throw new Error('× × ×œ×‘×—×•×¨ ×˜×•×•×— ×ª××¨×™×›×™×');
        }
        
        console.log('Trying to load without group filtering...');
        
        // Temporarily disable group mode
        const originalIsGroup = isGroup;
        isGroup = false;
        
        await loadDataStandard(startDate, endDate);
        
        // Restore group mode
        isGroup = originalIsGroup;
        
    } catch (error) {
        console.error('Error loading data without group:', error);
        showError(error.message || '×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
    } finally {
        showLoading(false);
    }
}

// Show parking details (for group users)
function showParkingDetails(parkingName, data) {
    console.log('showParkingDetails called with:', { parkingName, data });
    
    // ×‘×“×™×§×” ×©×™×© ××ª ×›×œ ×”× ×ª×•× ×™× ×”× ×“×¨×©×™×
    if (!data.days || data.days.size === 0) {
        console.error('Missing days data!');
        data.days = new Set(['2024-01-01']); // ×¢×¨×š ×‘×¨×™×¨×ª ××—×“×œ ×œ×× ×™×¢×ª ×©×’×™××”
    }
    
    // Update title
    document.getElementById('parkingDetailsTitle').textContent = `×¤×™×¨×•×˜ × ×ª×•× ×™× - ${parkingName}`;
    
    // Create payment chart
    const paymentCanvas = document.createElement('canvas');
    paymentCanvas.id = 'parkingPaymentChart';
    paymentCanvas.style.maxHeight = '300px';
    
    // Create entries chart
    const entriesCanvas = document.createElement('canvas');
    entriesCanvas.id = 'parkingEntriesChart';
    entriesCanvas.style.maxHeight = '300px';
    
    // Build content HTML
    const contentHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <!-- Revenue Card -->
            <div style="
                background: linear-gradient(135deg, #007AFF 0%, #5AC8FA 100%);
                padding: 24px;
                border-radius: 12px;
                color: white;
            ">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">×¡×”"×› ×”×›× ×¡×•×ª</div>
                <div style="font-size: 32px; font-weight: 700;">â‚ª${data.revenue.toLocaleString()}</div>
            </div>
            
            <!-- Entries Card -->
            <div style="
                background: linear-gradient(135deg, #34C759 0%, #30D158 100%);
                padding: 24px;
                border-radius: 12px;
                color: white;
            ">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">×¡×”"×› ×›× ×™×¡×•×ª</div>
                <div style="font-size: 32px; font-weight: 700;">${data.entries.toLocaleString()}</div>
            </div>
            
            <!-- Barriers Card -->
            <div style="
                background: linear-gradient(135deg, #FF3B30 0%, #FF6961 100%);
                padding: 24px;
                border-radius: 12px;
                color: white;
            ">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">×¤×ª×™×—×•×ª ××—×¡×•×</div>
                <div style="font-size: 32px; font-weight: 700;">${data.barriers.toLocaleString()}</div>
            </div>
            
            <!-- Average Revenue Card -->
            <div style="
                background: linear-gradient(135deg, #AF52DE 0%, #C969FF 100%);
                padding: 24px;
                border-radius: 12px;
                color: white;
            ">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">×”×›× ×¡×” ×™×•××™×ª ×××•×¦×¢×ª</div>
                <div style="font-size: 32px; font-weight: 700;">â‚ª${Math.round(data.revenue / data.days.size).toLocaleString()}</div>
            </div>
        </div>
        
        <!-- Charts Section -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
            <!-- Payment Breakdown -->
            <div>
                <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">×”×ª×¤×œ×’×•×ª ×ª×©×œ×•××™×</h4>
                <div id="paymentChartContainer"></div>
                
                <!-- Payment Details -->
                <div style="margin-top: 20px; padding: 20px; background: var(--background); border-radius: 12px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 14px;">××–×•××Ÿ</div>
                            <div style="font-weight: 600; font-size: 18px;">â‚ª${data.cash.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 14px;">××©×¨××™</div>
                            <div style="font-weight: 600; font-size: 18px;">â‚ª${data.credit.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 14px;">×¤× ×’×•</div>
                            <div style="font-weight: 600; font-size: 18px;">â‚ª${data.pango.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 14px;">×¡×œ×•</div>
                            <div style="font-weight: 600; font-size: 18px;">â‚ª${data.cello.toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Entries Breakdown -->
            <div>
                <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">×”×ª×¤×œ×’×•×ª ×›× ×™×¡×•×ª</h4>
                <div id="entriesChartContainer"></div>
                
                <!-- Entries Details -->
                <div style="margin-top: 20px; padding: 20px; background: var(--background); border-radius: 12px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 14px;">××–×“×× ×™×</div>
                            <div style="font-weight: 600; font-size: 18px;">${data.casual.toLocaleString()}</div>
                            <div style="color: var(--text-secondary); font-size: 12px;">${data.entries > 0 ? ((data.casual/data.entries)*100).toFixed(1) : 0}%</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 14px;">×× ×•×™×™×</div>
                            <div style="font-weight: 600; font-size: 18px;">${data.members.toLocaleString()}</div>
                            <div style="color: var(--text-secondary); font-size: 12px;">${data.entries > 0 ? ((data.members/data.entries)*100).toFixed(1) : 0}%</div>
                        </div>
                        ${data.app > 0 ? `
                        <div>
                            <div style="color: var(--text-secondary); font-size: 14px;">××¤×œ×™×§×¦×™×”</div>
                            <div style="font-weight: 600; font-size: 18px;">${data.app.toLocaleString()}</div>
                            <div style="color: var(--text-secondary); font-size: 12px;">${data.entries > 0 ? ((data.app/data.entries)*100).toFixed(1) : 0}%</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Daily Trend -->
        <div style="margin-top: 30px;">
            <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">××’××ª ×”×›× ×¡×•×ª ×™×•××™×•×ª - ${parkingName}</h4>
            <canvas id="parkingTrendChart" style="max-height: 250px;"></canvas>
        </div>
        
                    <!-- Stay Duration Details -->
            <div style="margin-top: 30px;">
                <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">×”×ª×¤×œ×’×•×ª ×–×× ×™ ×©×”×™×™×” - ${parkingName}</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    ${(data.stay015 + data.stay030 + data.stay045 + data.stay060) > 0 ? `<div style="padding: 15px; background: linear-gradient(135deg, rgba(0, 122, 255, 0.1), rgba(0, 122, 255, 0.05)); border-radius: 8px; text-align: center; border: 2px solid var(--primary); position: relative;">
                        <div style="color: var(--primary); font-size: 14px; margin-bottom: 5px; font-weight: 600;">0-60 ×“×§×•×ª</div>
                        <div style="font-weight: 700; font-size: 24px; color: var(--primary);">${(data.stay015 + data.stay030 + data.stay045 + data.stay060).toLocaleString()}</div>
                        <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? (((data.stay015 + data.stay030 + data.stay045 + data.stay060)/data.totalStays)*100).toFixed(1) : 0}%</div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0, 122, 255, 0.2); font-size: 12px; color: var(--primary);">
                            <strong>0-15 ×“×§×•×ª:</strong> ${data.stay015.toLocaleString()} (${(data.stay015 + data.stay030 + data.stay045 + data.stay060) > 0 ? ((data.stay015/(data.stay015 + data.stay030 + data.stay045 + data.stay060))*100).toFixed(1) : 0}%)
                        </div>
                    </div>` : ''}
                ${data.stay2 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">×¢×“ 2 ×©×¢×•×ª</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay2.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay2/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
                ${data.stay3 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">×¢×“ 3 ×©×¢×•×ª</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay3.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay3/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
                ${data.stay4 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">×¢×“ 4 ×©×¢×•×ª</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay4.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay4/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
                ${data.stay5 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">×¢×“ 5 ×©×¢×•×ª</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay5.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay5/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
                ${data.stay6 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">×¢×“ 6 ×©×¢×•×ª</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay6.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay6/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
                ${data.stay724 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">7-24 ×©×¢×•×ª</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay724.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay724/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
            </div>
            <div style="margin-top: 15px; padding: 15px; background: rgba(0, 122, 255, 0.1); border-radius: 8px; text-align: center;">
                <div style="color: var(--primary); font-size: 14px;">×¡×”"×› ×¨×›×‘×™× ×©×—× ×•</div>
                <div style="font-weight: 700; font-size: 24px; color: var(--primary);">${data.totalStays.toLocaleString()}</div>
            </div>
        </div>
    `;
    
    // Update content
    document.getElementById('parkingDetailsContent').innerHTML = contentHTML;
    
    // Add charts to containers
    document.getElementById('paymentChartContainer').appendChild(paymentCanvas);
    document.getElementById('entriesChartContainer').appendChild(entriesCanvas);
    
    // Show section
    document.getElementById('parkingDetailsSection').style.display = 'block';
    
    // Scroll to details
    document.getElementById('parkingDetailsSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    // Create charts
    createParkingPaymentChart(data);
    createParkingEntriesChart(data);
    createParkingTrendChart(parkingName);
}

// Create parking payment chart
function createParkingPaymentChart(data) {
    const ctx = document.getElementById('parkingPaymentChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['××–×•××Ÿ', '××©×¨××™', '×¤× ×’×•', '×¡×œ×•'],
            datasets: [{
                data: [data.cash, data.credit, data.pango, data.cello],
                backgroundColor: [
                    '#007AFF',
                    '#FF9500',
                    '#5AC8FA',
                    '#AF52DE'
                ],
                borderWidth: 3,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return {
                                        text: `${label}: ${percentage}%`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: '#fff',
                                        lineWidth: 3,
                                        hidden: isNaN(value) || chart.getDatasetMeta(0).data[i].hidden,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                }
            }
        }
    });
}

// Create parking entries chart
function createParkingEntriesChart(data) {
    const ctx = document.getElementById('parkingEntriesChart').getContext('2d');
    
    const labels = ['××–×“×× ×™×', '×× ×•×™×™×'];
    const values = [data.casual, data.members];
    const colors = ['#34C759', '#007AFF'];
    
    if (data.app > 0) {
        labels.push('××¤×œ×™×§×¦×™×”');
        values.push(data.app);
        colors.push('#FF9500');
    }
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors,
                borderWidth: 3,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return {
                                        text: `${label}: ${percentage}%`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: '#fff',
                                        lineWidth: 3,
                                        hidden: isNaN(value) || chart.getDatasetMeta(0).data[i].hidden,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                }
            }
        }
    });
}

// Create parking trend chart
function createParkingTrendChart(parkingName) {
    const ctx = document.getElementById('parkingTrendChart').getContext('2d');
    
    // Filter data for this parking
    const parkingData = currentData.filter(d => d.parking_name === parkingName);
    
    // Aggregate by date
    const dailyData = {};
    parkingData.forEach(d => {
        if (!dailyData[d.report_date]) {
            dailyData[d.report_date] = 0;
        }
        dailyData[d.report_date] += d.total_revenue_shekels || 0;
    });
    
    const dates = Object.keys(dailyData).sort();
    const revenues = dates.map(date => dailyData[date]);
    
    // Format dates for display
    const formattedDates = dates.map(date => formatDateForDisplay(date));
    
    // Create gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, 200);
    gradient.addColorStop(0, 'rgba(0, 122, 255, 0.5)');
    gradient.addColorStop(1, 'rgba(0, 122, 255, 0)');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: formattedDates,
            datasets: [{
                label: '×”×›× ×¡×•×ª ×™×•××™×•×ª',
                data: revenues,
                borderColor: '#007AFF',
                backgroundColor: gradient,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                    callbacks: {
                        title: function(tooltipItems) {
                            // Ensure date is shown in DD/MM/YYYY format
                            return tooltipItems[0].label;
                        },
                        label: function(context) {
                            return `×”×›× ×¡×•×ª: â‚ª${context.parsed.y.toLocaleString()}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return 'â‚ª' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Close parking details
function closeParkingDetails() {
    document.getElementById('parkingDetailsSection').style.display = 'none';
}

// Setup stat card hover functionality
function setupStatCardHovers() {
    // Create tooltip element if it doesn't exist
    let tooltip = document.getElementById('statTooltip');
    if (!tooltip) {
        tooltip = document.createElement('div');
        tooltip.id = 'statTooltip';
        tooltip.style.cssText = `
            position: fixed;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid #E5E5EA;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: none;
            max-width: 380px;
            max-height: 60vh;
            overflow-y: auto;
            transition: opacity 0.2s ease, transform 0.2s ease;
            opacity: 0;
            transform: translateY(5px);
            pointer-events: none;
        `;
        document.body.appendChild(tooltip);
    }
    
    // Keep track of hover timeout
    let hoverTimeout = null;
    let isTooltipHovered = false;
    
    // Allow hovering over the tooltip itself
    tooltip.addEventListener('mouseenter', () => {
        isTooltipHovered = true;
        clearTimeout(hoverTimeout);
    });
    
    tooltip.addEventListener('mouseleave', () => {
        isTooltipHovered = false;
        if (tooltip.getAttribute('data-clicked') !== 'true') {
            hideStatTooltip();
        }
    });
    
    // Add hover handlers to all stat cards
    const statCards = document.querySelectorAll('.stat-card[data-stat-type]');
    statCards.forEach(card => {
        const statType = card.getAttribute('data-stat-type');
        
        // Make all cards interactive for group users (except parkings)
        if (isGroup && !isSingleParkingMode && statType !== 'parkings') {
            card.style.cursor = 'pointer';
            
            card.addEventListener('mouseenter', (e) => {
                clearTimeout(hoverTimeout);
                if (!document.getElementById('statTooltip').getAttribute('data-clicked')) {
                    showStatTooltip(e, statType);
                }
            });
            
            card.addEventListener('mouseleave', () => {
                hoverTimeout = setTimeout(() => {
                    if (!isTooltipHovered) {
                        hideStatTooltip();
                    }
                }, 300);
            });
            
            card.addEventListener('click', (e) => {
                e.stopPropagation();
                showStatTooltip(e, statType, true);
            });
        }
    });
    
    // Hide tooltip when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.stat-card') && !e.target.closest('#statTooltip')) {
            const tooltip = document.getElementById('statTooltip');
            if (tooltip) {
                tooltip.setAttribute('data-clicked', 'false');
                hideStatTooltip();
            }
        }
    });
    
    // Hide tooltip on scroll
    window.addEventListener('scroll', () => {
        if (!document.getElementById('statTooltip').getAttribute('data-clicked')) {
            hideStatTooltip();
        }
    }, { passive: true });
    
    // Hide tooltip on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const tooltip = document.getElementById('statTooltip');
            if (tooltip) {
                tooltip.setAttribute('data-clicked', 'false');
                hideStatTooltip();
            }
        }
    });
}

// Show stat tooltip with parking details
function showStatTooltip(event, statType, isClick = false) {
    const tooltip = document.getElementById('statTooltip');
    const card = event.currentTarget;
    
    // Calculate parking data
    const parkingStats = {};
    currentData.forEach(d => {
        if (!parkingStats[d.parking_name]) {
            parkingStats[d.parking_name] = {
                revenue: 0,
                entries: 0,
                barriers: 0,
                casual: 0,
                members: 0,
                app: 0,
                cash: 0,
                credit: 0,
                pango: 0,
                cello: 0,
                days: new Set()
            };
        }
        parkingStats[d.parking_name].revenue += d.total_revenue_shekels || 0;
        parkingStats[d.parking_name].entries += d.t_entry_tot || 0;
        parkingStats[d.parking_name].barriers += d.t_open_b || 0;
        parkingStats[d.parking_name].casual += d.t_entry_s || 0;
        parkingStats[d.parking_name].members += d.t_entry_p || 0;
        parkingStats[d.parking_name].app += d.t_entry_ap || 0;
        parkingStats[d.parking_name].cash += d.s_cash_shekels || 0;
        parkingStats[d.parking_name].credit += d.s_credit_shekels || 0;
        parkingStats[d.parking_name].pango += d.s_pango_shekels || 0;
        parkingStats[d.parking_name].cello += d.s_celo_shekels || 0;
        parkingStats[d.parking_name].days.add(d.report_date);
    });
    
    // Calculate average daily revenue for each parking
    Object.keys(parkingStats).forEach(parking => {
        parkingStats[parking].avgRevenue = parkingStats[parking].revenue / parkingStats[parking].days.size;
    });
    
    // Sort parkings by the relevant metric
    let sortedParkings;
    switch(statType) {
        case 'revenue':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].revenue - a[1].revenue);
            break;
        case 'entries':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].entries - a[1].entries);
            break;
        case 'barriers':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].barriers - a[1].barriers);
            break;
        case 'casual':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].casual - a[1].casual);
            break;
        case 'members':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].members - a[1].members);
            break;
        case 'app':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].app - a[1].app);
            break;
        case 'cash':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].cash - a[1].cash);
            break;
        case 'credit':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].credit - a[1].credit);
            break;
        case 'pango':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].pango - a[1].pango);
            break;
        case 'cello':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].cello - a[1].cello);
            break;
        case 'avg-revenue':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].avgRevenue - a[1].avgRevenue);
            break;
        default:
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].revenue - a[1].revenue);
    }
    
    // Build tooltip content
    let content = '<div style="font-weight: 600; font-size: 16px; margin-bottom: 12px; color: #1C1C1E;">';
    switch(statType) {
        case 'revenue':
            content += '×”×›× ×¡×•×ª ×œ×¤×™ ×—× ×™×•×Ÿ';
            break;
        case 'entries':
            content += '×›× ×™×¡×•×ª ×œ×¤×™ ×—× ×™×•×Ÿ';
            break;
        case 'barriers':
            content += '×¤×ª×™×—×•×ª ××—×¡×•× ×œ×¤×™ ×—× ×™×•×Ÿ';
            break;
        case 'casual':
            content += '××–×“×× ×™× ×œ×¤×™ ×—× ×™×•×Ÿ';
            break;
        case 'members':
            content += '×× ×•×™×™× ×œ×¤×™ ×—× ×™×•×Ÿ';
            break;
        case 'app':
            content += '××¤×œ×™×§×¦×™×” ×œ×¤×™ ×—× ×™×•×Ÿ';
            break;
        case 'cash':
            content += '××–×•××Ÿ ×œ×¤×™ ×—× ×™×•×Ÿ';
            break;
        case 'credit':
            content += '××©×¨××™ ×œ×¤×™ ×—× ×™×•×Ÿ';
            break;
        case 'pango':
            content += '×¤× ×’×• ×œ×¤×™ ×—× ×™×•×Ÿ';
            break;
        case 'cello':
            content += '×¡×œ×• ×œ×¤×™ ×—× ×™×•×Ÿ';
            break;
        case 'avg-revenue':
            content += '×××•×¦×¢ ×™×•××™ ×œ×¤×™ ×—× ×™×•×Ÿ';
            break;
        default:
            content += '×¤×™×¨×•×˜ ×œ×¤×™ ×—× ×™×•×Ÿ';
    }
    content += '</div>';
    
    // Limit number of items shown to prevent overflow
    const maxItems = 8;
    const itemsToShow = sortedParkings.slice(0, maxItems);
    const hasMore = sortedParkings.length > maxItems;
    
    content += '<div style="max-height: 280px; overflow-y: auto;">';
    itemsToShow.forEach(([parkingName, stats], index) => {
        let value;
        let percentage = 0;
        let total;
        
        switch(statType) {
            case 'revenue':
                value = `â‚ª${stats.revenue.toLocaleString()}`;
                total = sortedParkings.reduce((sum, [, s]) => sum + s.revenue, 0);
                percentage = total > 0 ? (stats.revenue / total * 100).toFixed(1) : 0;
                break;
            case 'entries':
                value = stats.entries.toLocaleString();
                total = sortedParkings.reduce((sum, [, s]) => sum + s.entries, 0);
                percentage = total > 0 ? (stats.entries / total * 100).toFixed(1) : 0;
                break;
            case 'barriers':
                value = stats.barriers.toLocaleString();
                total = sortedParkings.reduce((sum, [, s]) => sum + s.barriers, 0);
                percentage = total > 0 ? (stats.barriers / total * 100).toFixed(1) : 0;
                break;
            case 'casual':
                value = stats.casual.toLocaleString();
                total = sortedParkings.reduce((sum, [, s]) => sum + s.casual, 0);
                percentage = total > 0 ? (stats.casual / total * 100).toFixed(1) : 0;
                break;
            case 'members':
                value = stats.members.toLocaleString();
                total = sortedParkings.reduce((sum, [, s]) => sum + s.members, 0);
                percentage = total > 0 ? (stats.members / total * 100).toFixed(1) : 0;
                break;
            case 'app':
                value = stats.app.toLocaleString();
                total = sortedParkings.reduce((sum, [, s]) => sum + s.app, 0);
                percentage = total > 0 ? (stats.app / total * 100).toFixed(1) : 0;
                break;
            case 'cash':
                value = `â‚ª${stats.cash.toLocaleString()}`;
                total = sortedParkings.reduce((sum, [, s]) => sum + s.cash, 0);
                percentage = total > 0 ? (stats.cash / total * 100).toFixed(1) : 0;
                break;
            case 'credit':
                value = `â‚ª${stats.credit.toLocaleString()}`;
                total = sortedParkings.reduce((sum, [, s]) => sum + s.credit, 0);
                percentage = total > 0 ? (stats.credit / total * 100).toFixed(1) : 0;
                break;
            case 'pango':
                value = `â‚ª${stats.pango.toLocaleString()}`;
                total = sortedParkings.reduce((sum, [, s]) => sum + s.pango, 0);
                percentage = total > 0 ? (stats.pango / total * 100).toFixed(1) : 0;
                break;
            case 'cello':
                value = `â‚ª${stats.cello.toLocaleString()}`;
                total = sortedParkings.reduce((sum, [, s]) => sum + s.cello, 0);
                percentage = total > 0 ? (stats.cello / total * 100).toFixed(1) : 0;
                break;
            case 'avg-revenue':
                value = `â‚ª${Math.round(stats.avgRevenue).toLocaleString()}`;
                total = sortedParkings.reduce((sum, [, s]) => sum + s.avgRevenue, 0);
                percentage = total > 0 ? (stats.avgRevenue / total * 100).toFixed(1) : 0;
                break;
        }
        
        const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
        
        content += `
            <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 12px;
                margin: 4px 0;
                background: ${index < 3 ? 'rgba(0, 122, 255, 0.05)' : 'rgba(0, 0, 0, 0.02)'};
                border-radius: 8px;
                transition: background 0.2s;
            " onmouseover="this.style.background='rgba(0, 122, 255, 0.1)'" onmouseout="this.style.background='${index < 3 ? 'rgba(0, 122, 255, 0.05)' : 'rgba(0, 0, 0, 0.02)'}'">
                <div style="display: flex; align-items: center; gap: 8px;">
                    ${medal ? `<span style="font-size: 18px;">${medal}</span>` : `<span style="color: #8E8E93; font-size: 14px; min-width: 20px;">${index + 1}.</span>`}
                    <span style="font-weight: 500; color: #1C1C1E;">${parkingName}</span>
                </div>
                <div style="text-align: left;">
                    <div style="font-weight: 600; color: #007AFF;">${value}</div>
                    <div style="font-size: 12px; color: #8E8E93;">${percentage}%</div>
                </div>
            </div>
        `;
    });
    
    if (hasMore) {
        content += `
            <div style="
                padding: 12px;
                text-align: center;
                color: #8E8E93;
                font-size: 14px;
                border-top: 1px solid #E5E5EA;
                margin-top: 8px;
            ">
                ×•×¢×•×“ ${sortedParkings.length - maxItems} ×—× ×™×•× ×™×...
            </div>
        `;
    }
    
    content += '</div>';
    
    tooltip.innerHTML = content;
    
    // Position tooltip
    const rect = card.getBoundingClientRect();
    const tooltipWidth = 350;
    
    // Show tooltip first to get its actual height
    tooltip.style.display = 'block';
    tooltip.style.visibility = 'hidden';
    tooltip.style.width = tooltipWidth + 'px';
    
    // Get actual tooltip height after content is rendered
    const tooltipHeight = Math.min(tooltip.offsetHeight, window.innerHeight * 0.6);
    
    // Calculate position (fixed positioning uses viewport coordinates)
    let left = rect.left + (rect.width / 2) - (tooltipWidth / 2);
    let top = rect.bottom + 10;
    
    // Adjust horizontal position if goes off screen
    if (left < 10) left = 10;
    if (left + tooltipWidth > window.innerWidth - 10) left = window.innerWidth - tooltipWidth - 10;
    
    // Check vertical space
    const spaceBelow = window.innerHeight - rect.bottom - 20;
    const spaceAbove = rect.top - 20;
    
    // If not enough space below and more space above, show above
    if (tooltipHeight > spaceBelow && spaceAbove > spaceBelow && spaceAbove > 100) {
        top = rect.top - tooltipHeight - 10;
        // Make sure it doesn't go off the top
        if (top < 10) {
            top = 10;
            tooltip.style.maxHeight = `${rect.top - 20}px`;
        }
    } else {
        // Show below, but limit height if needed
        if (tooltipHeight > spaceBelow - 10) {
            tooltip.style.maxHeight = `${spaceBelow - 10}px`;
        }
    }
    
    // Apply position
    tooltip.style.left = `${left}px`;
    tooltip.style.top = `${top}px`;
    tooltip.style.visibility = 'visible';
    
    // Trigger animation
    requestAnimationFrame(() => {
        tooltip.style.opacity = '1';
        tooltip.style.transform = 'translateY(0)';
        tooltip.style.pointerEvents = 'auto';
    });
    
    // Store click state
    tooltip.setAttribute('data-clicked', isClick ? 'true' : 'false');
}

// Hide stat tooltip
function hideStatTooltip() {
    const tooltip = document.getElementById('statTooltip');
    if (tooltip && tooltip.getAttribute('data-clicked') !== 'true') {
        tooltip.style.opacity = '0';
        tooltip.style.transform = 'translateY(5px)';
        tooltip.style.pointerEvents = 'none';
        setTimeout(() => {
            if (tooltip.style.opacity === '0') {
                tooltip.style.display = 'none';
                tooltip.style.maxHeight = '60vh'; // Reset max height
            }
        }, 200);
    }
}

// Toggle chart type between line and bar
function toggleChartType(chartName) {
    // Toggle between line and bar
    if (chartTypes[chartName] === 'line') {
        chartTypes[chartName] = 'bar';
    } else {
        chartTypes[chartName] = 'line';
    }
    
    // Recreate the specific chart
    switch(chartName) {
        case 'revenue':
            createRevenueChart();
            break;
        case 'entries':
            createEntriesChart();
            break;
        case 'daily':
            createDailyChart();
            break;
    }
}

// Initialize
console.log('Apple Dashboard ready!');


</script>

</body>
</html> 
