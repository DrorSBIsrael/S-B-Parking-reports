<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S&B Parking Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #1d1d1f;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header ×‘×¡×’× ×•×Ÿ ××¤×œ */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            transition: all 0.3s ease;
        }
        
        .header:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .header-title h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #007AFF, #5856D6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        
        .header-subtitle {
            font-size: 16px;
            color: #6e6e73;
            font-weight: 500;
        }
        
        /* Controls */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .date-selector {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 16px 20px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 320px;
            transition: all 0.3s ease;
        }
        
        .date-selector:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .quick-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            color: white;
        }
        
        .btn-secondary {
            background: rgba(0, 122, 255, 0.1);
            color: #007AFF;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }
        
        .btn:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }
        
        .btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        .date-input {
            padding: 10px 14px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            width: 140px;
        }
        
        .date-input:focus {
            outline: none;
            border-color: #007AFF;
            background: white;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }
        
        .custom-date {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(0, 122, 255, 0.1);
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 14px;
            color: #007AFF;
            font-weight: 500;
        }
        
        .logout-btn {
            background: #FF3B30;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        /* Loading & Error States */
        .loading {
            text-align: center;
            padding: 60px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            margin: 20px 0;
            backdrop-filter: blur(20px);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: rgba(255, 69, 58, 0.1);
            color: #D70015;
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid rgba(255, 69, 58, 0.2);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 24px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #007AFF, #5856D6, #AF52DE);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
        }
        
        .stat-card:hover::before {
            opacity: 1;
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #8e8e93;
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #007AFF, #5856D6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-card .subtext {
            color: #8e8e93;
            font-size: 13px;
            font-weight: 500;
        }
        
        .stat-card .trend {
            margin-top: 8px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .trend.positive {
            color: #30D158;
        }
        
        .trend.negative {
            color: #FF3B30;
        }
        
        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 28px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .chart-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .chart-title {
            font-size: 18px;
            color: #1d1d1f;
            margin-bottom: 24px;
            font-weight: 700;
            text-align: center;
        }
        
        .chart-subtitle {
            font-size: 13px;
            color: #8e8e93;
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* Parking Duration Chart Specific */
        .duration-chart {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.05), rgba(88, 86, 214, 0.05));
        }
        
        /* Alerts Section */
        .alerts-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 28px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 24px;
        }
        
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 12px 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }
        
        .alert:hover {
            transform: translateX(4px);
        }
        
        .alert.positive {
            background: linear-gradient(135deg, rgba(48, 209, 88, 0.1), rgba(52, 199, 89, 0.05));
            color: #30D158;
            border: 1px solid rgba(48, 209, 88, 0.2);
        }
        
        .alert.negative {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.1), rgba(255, 69, 58, 0.05));
            color: #FF3B30;
            border: 1px solid rgba(255, 59, 48, 0.2);
        }
        
        .alert-icon {
            font-size: 20px;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-size: 15px;
            margin-bottom: 4px;
        }
        
        .alert-details {
            font-size: 13px;
            opacity: 0.8;
            font-weight: 500;
        }
        
        /* Rankings */
        .rankings {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 28px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .rank-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            margin: 12px 0;
            background: rgba(247, 247, 247, 0.5);
            border-radius: 16px;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .rank-item:hover {
            background: rgba(0, 122, 255, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        
        .rank-number {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-left: 16px;
            font-size: 14px;
        }
        
        .rank-info {
            flex-grow: 1;
        }
        
        .rank-name {
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 16px;
            color: #1d1d1f;
        }
        
        .rank-details {
            font-size: 13px;
            color: #8e8e93;
            font-weight: 500;
        }
        
        .rank-value {
            font-weight: 700;
            color: #007AFF;
            font-size: 18px;
            text-align: left;
        }
        
        .rank-subvalue {
            font-size: 12px;
            color: #8e8e93;
            font-weight: 500;
        }
        
        /* Interactive Details */
        .details-panel {
            margin-top: 20px;
            padding: 20px;
            background: rgba(247, 247, 247, 0.5);
            border-radius: 16px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .details-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            justify-content: center;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header {
                flex-direction: column;
                gap: 20px;
                padding: 20px;
            }
            
            .date-selector {
                min-width: auto;
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .quick-buttons {
                justify-content: center;
            }
            
            .custom-date {
                justify-content: center;
            }
        }
        
        /* Data Summary Cards */
        .summary-section {
            margin-bottom: 32px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.1), rgba(88, 86, 214, 0.05));
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 122, 255, 0.1);
        }
        
        .summary-title {
            font-size: 20px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }
        
        .summary-item {
            text-align: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
        }
        
        .summary-item-value {
            font-size: 24px;
            font-weight: 700;
            color: #007AFF;
            margin-bottom: 4px;
        }
        
        .summary-item-label {
            font-size: 12px;
            color: #8e8e93;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Hidden state */
        .hidden {
            display: none !important;
        }
        
        /* Single parking specific styles */
        .single-parking .header-subtitle {
            color: #007AFF;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <h1>ğŸš— S&B Parking</h1>
                <div>
                    <div id="parkingTitle" class="header-subtitle">××¢×¨×›×ª ×“×•×—×•×ª ×—× ×™×•×ª</div>
                </div>
            </div>
            
            <div class="header-controls">
                <!-- Date Controls -->
                <div class="date-selector">
                    <div class="quick-buttons">
                        <button class="btn btn-secondary quick-range" data-range="yesterday">××ª××•×œ</button>
                        <button class="btn btn-secondary quick-range" data-range="month">×”×—×•×“×©</button>
                        <button class="btn btn-secondary quick-range" data-range="lastmonth">×—×•×“×© ×§×•×“×</button>
                        <button class="btn btn-primary" id="investigateBtn">ğŸ” ×—×™×¤×•×© ××ª×§×“×</button>
                    </div>
                    
                    <div class="custom-date">
                        <label style="font-weight: 600; color: #1d1d1f;">××ª××¨×™×š:</label>
                        <input type="text" id="startDate" class="date-input" placeholder="DD/MM/YYYY" maxlength="10">
                        <label style="font-weight: 600; color: #1d1d1f;">×¢×“:</label>
                        <input type="text" id="endDate" class="date-input" placeholder="DD/MM/YYYY" maxlength="10">
                        <button id="loadDataBtn" class="btn btn-primary">ğŸ“Š ×˜×¢×Ÿ</button>
                    </div>
                </div>
                
                <!-- User Info -->
                <div class="user-info">
                    <span id="userInfo">×˜×•×¢×Ÿ...</span>
                    <button id="logoutBtn" class="logout-btn">×™×¦×™××”</button>
                </div>
            </div>
        </div>
        
        <!-- Loading -->
        <div id="loadingSection" class="loading hidden">
            <div class="loading-spinner"></div>
            <h3>×˜×•×¢×Ÿ × ×ª×•× ×™×...</h3>
        </div>
        
        <!-- Error -->
        <div id="errorSection" class="error-message hidden">
            <h3>ğŸš¨ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</h3>
            <p id="errorMessage"></p>
        </div>
        
        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden">
            <!-- Summary Card -->
            <div class="summary-section">
                <div class="summary-card">
                    <div class="summary-title" id="summaryTitle">×¡×™×›×•× ×ª×§×•×¤×”</div>
                    <div class="summary-grid" id="summaryGrid">
                        <!-- ×™×ª××œ× ×‘×§×•×“ JS -->
                    </div>
                </div>
            </div>
            
            <!-- Statistics Cards -->
            <div class="stats-grid" id="statsGrid">
                <!-- ×™×ª××œ× ×‘×§×•×“ JS -->
            </div>
            
            <!-- Charts -->
            <div class="charts-section">
                <!-- Parking Duration Chart -->
                <div class="chart-card duration-chart">
                    <div class="chart-title">×–×× ×™ ×©×”×™×™×” ×‘×—× ×™×•×Ÿ</div>
                    <div class="chart-subtitle">×”×ª×¤×œ×’×•×ª ×–×× ×™ ×”×—× ×™×™×” ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª</div>
                    <canvas id="durationChart"></canvas>
                    <div id="durationDetails" class="details-panel">
                        <!-- ×¤×™×¨×•×˜ ×–×× ×™ ×©×”×™×™×” -->
                    </div>
                </div>
                
                <!-- Revenue Trends -->
                <div class="chart-card">
                    <div class="chart-title">××’××•×ª ×”×›× ×¡×•×ª</div>
                    <div class="chart-subtitle">×”×›× ×¡×•×ª ×™×•××™×•×ª ×œ××•×¨×š ×”×ª×§×•×¤×”</div>
                    <canvas id="revenueChart"></canvas>
                </div>
                
                <!-- Payment Methods -->
                <div class="chart-card">
                    <div class="chart-title">×××¦×¢×™ ×ª×©×œ×•×</div>
                    <div class="chart-subtitle">×”×ª×¤×œ×’×•×ª ×ª×©×œ×•××™×</div>
                    <canvas id="paymentChart"></canvas>
                    <div id="paymentDetails" class="details-panel">
                        <!-- ×¤×™×¨×•×˜ ×ª×©×œ×•××™× -->
                    </div>
                </div>
                
                <!-- Traffic Analysis -->
                <div class="chart-card">
                    <div class="chart-title">× ×™×ª×•×— ×ª× ×•×¢×”</div>
                    <div class="chart-subtitle">×›× ×™×¡×•×ª ×•×™×¦×™××•×ª ×™×•××™×•×ª</div>
                    <canvas id="trafficChart"></canvas>
                </div>
                
                <!-- Weekly Comparison -->
                <div class="chart-card">
                    <div class="chart-title">×”×©×•×•××” ×©×‘×•×¢×™×ª</div>
                    <div class="chart-subtitle">×××•×¦×¢ ×”×›× ×¡×•×ª ×œ×¤×™ ×™××™ ×”×©×‘×•×¢</div>
                    <canvas id="weeklyChart"></canvas>
                </div>
                
                <!-- Efficiency Metrics -->
                <div class="chart-card">
                    <div class="chart-title">××“×“×™ ×™×¢×™×œ×•×ª</div>
                    <div class="chart-subtitle">×™×—×¡ ×¤×ª×™×—×•×ª ××—×¡×•× ×œ×›× ×™×¡×•×ª</div>
                    <canvas id="efficiencyChart"></canvas>
                </div>
            </div>
            
            <!-- Alerts Section -->
            <div class="alerts-section">
                <div class="chart-title">ğŸš¨ ×”×ª×¨××•×ª ×•××’××•×ª</div>
                <div id="alertsContainer">
                    <!-- ×”×ª×¨××•×ª ×™×ª××œ××• ×›××Ÿ -->
                </div>
            </div>
            
            <!-- Rankings (for multi-parking users) -->
            <div id="rankingsSection" class="rankings hidden">
                <div class="chart-title">ğŸ† ×“×™×¨×•×’ ×—× ×™×•× ×™×</div>
                <div id="rankingsContainer">
                    <!-- ×“×™×¨×•×’ ×™×ª××œ× ×›××Ÿ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        let userData = null;
        let currentData = [];
        let charts = {};
        let isSingleParking = false;

        // ×˜×¢×™× ×” ×¨××©×•× ×™×ª
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            setupEventListeners();
            setDefaultDates();
        });

        // ×”×’×“×¨×ª ×ª××¨×™×›×™× ×‘×¨×™×¨×ª ××—×“×œ - ××ª××•×œ
        function setDefaultDates() {
            const today = new Date();
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            
            document.getElementById('endDate').value = formatDateForInput(yesterday);
            document.getElementById('startDate').value = formatDateForInput(yesterday);
        }

        // ×”××¨×ª ×ª××¨×™×š ×œ×¤×•×¨××˜ DD/MM/YYYY
        function formatDateForInput(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // ×”××¨×ª ×ª××¨×™×š ××¤×•×¨××˜ DD/MM/YYYY ×œ××•×‘×™×™×§×˜ Date
        function parseInputDate(dateString) {
            if (!dateString || !dateString.includes('/')) return null;
            
            const parts = dateString.split('/');
            if (parts.length !== 3) return null;
            
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const year = parseInt(parts[2]);
            
            if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
            
            const date = new Date(year, month, day);
            
            if (date.getDate() !== day || date.getMonth() !== month || date.getFullYear() !== year) {
                return null;
            }
            
            return date;
        }

        // ×”××¨×ª ×ª××¨×™×š ×œ×¤×•×¨××˜ ×œ××¡×“ ×”× ×ª×•× ×™× (YYYY-MM-DD)
        function formatDateForAPI(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ×˜×¢×™× ×ª × ×ª×•× ×™ ××©×ª××©
        async function loadUserData() {
            try {
                const response = await fetch('/api/user-info');
                const result = await response.json();
                
                if (result.success) {
                    userData = result.user;
                    updateUserInterface();
                    // ×˜×¢×Ÿ × ×ª×•× ×™× ×¨××©×•× ×™×™× ×¢×‘×•×¨ ××ª××•×œ
                    await loadParkingData();
                } else {
                    showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ××©×ª××©: ' + result.message);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showError('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª');
            }
        }

        // ×¢×“×›×•×Ÿ ×××©×§ ×”××©×ª××©
        function updateUserInterface() {
            if (!userData) return;
            
            // ×§×‘×™×¢×” ×× ×–×” ××©×ª××© ×—× ×™×•×Ÿ ×™×—×™×“
            isSingleParking = userData.access_level === 'single_parking' || userData.project_number !== '0';
            
            document.getElementById('userInfo').textContent = 
                `ğŸ‘¤ ${userData.username} | ğŸ¢ ${userData.parking_name}`;
            
            if (isSingleParking) {
                document.body.classList.add('single-parking');
                document.getElementById('parkingTitle').textContent = userData.parking_name;
                document.getElementById('rankingsSection').classList.add('hidden');
            } else {
                document.getElementById('parkingTitle').textContent = '××¢×¨×›×ª ×“×•×—×•×ª ×—× ×™×•×ª';
                document.getElementById('rankingsSection').classList.remove('hidden');
            }
        }

        // ×˜×¢×™× ×ª × ×ª×•× ×™ ×—× ×™×•×Ÿ
        async function loadParkingData() {
            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;
            
            if (!startDateInput || !endDateInput) {
                showError('×× × ×”×›× ×¡ ×˜×•×•×— ×ª××¨×™×›×™×');
                return;
            }
            
            const startDate = parseInputDate(startDateInput);
            const endDate = parseInputDate(endDateInput);
            
            if (!startDate || !endDate) {
                showError('×¤×•×¨××˜ ×ª××¨×™×š ×œ× ×ª×§×™×Ÿ. ×”×©×ª××© ×‘×¤×•×¨××˜ DD/MM/YYYY');
                return;
            }
            
            if (startDate > endDate) {
                showError('×ª××¨×™×š ×”×ª×—×œ×” ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤× ×™ ××• ×©×•×•×” ×œ×ª××¨×™×š ×”×¡×™×•×');
                return;
            }
            
            showLoading(true);
            hideError();
            
            try {
                const startDateAPI = formatDateForAPI(startDate);
                const endDateAPI = formatDateForAPI(endDate);
                
                const params = new URLSearchParams({
                    start_date: startDateAPI,
                    end_date: endDateAPI
                });
                
                console.log('Loading data for:', startDateAPI, 'to', endDateAPI);
                
                const response = await fetch(`/api/parking-data?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    currentData = result.data;
                    if (currentData.length === 0) {
                        showError(`××™×Ÿ × ×ª×•× ×™× ×–××™× ×™× ×œ×ª×§×•×¤×” ${startDateInput} - ${endDateInput}`);
                    } else {
                        console.log(`Loaded ${currentData.length} records`);
                        updateDashboard();
                    }
                } else {
                    showError(result.message || '×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
                }
            } catch (error) {
                console.error('Error loading parking data:', error);
                showError('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª. ×× × × ×¡×” ×©×•×‘.');
            } finally {
                showLoading(false);
            }
        }

        // ×¢×“×›×•×Ÿ ×”×“×©×‘×•×¨×“
        function updateDashboard() {
            if (!currentData || currentData.length === 0) {
                showError('×œ× × ××¦××• × ×ª×•× ×™× ×œ×˜×•×•×— ×”×ª××¨×™×›×™× ×©× ×‘×—×¨');
                return;
            }
            
            updateSummary();
            updateStatistics();
            updateCharts();
            updateAlerts();
            
            if (!isSingleParking) {
                updateRankings();
            }
            
            document.getElementById('dashboardContent').classList.remove('hidden');
        }

        // ×¢×“×›×•×Ÿ ×¡×™×›×•× ×ª×§×•×¤×”
        function updateSummary() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const uniqueDays = [...new Set(currentData.map(d => d.report_date))].length;
            
            let title = `×¡×™×›×•× ×ª×§×•×¤×”: ${startDate}`;
            if (startDate !== endDate) {
                title += ` - ${endDate}`;
            }
            title += ` (${uniqueDays} ×™××™×)`;
            
            if (isSingleParking) {
                title += ` â€¢ ${userData.parking_name}`;
            }
            
            document.getElementById('summaryTitle').textContent = title;
            
            const totalRevenue = currentData.reduce((sum, d) => sum + (d.total_revenue_shekels || 0), 0);
            const totalEntries = currentData.reduce((sum, d) => sum + (d.t_entry_tot || 0), 0);
            const totalBarriers = currentData.reduce((sum, d) => sum + (d.t_open_b || 0), 0);
            const avgDailyRevenue = uniqueDays > 0 ? totalRevenue / uniqueDays : 0;
            const avgDailyEntries = uniqueDays > 0 ? totalEntries / uniqueDays : 0;
            const efficiency = totalEntries > 0 ? ((totalBarriers / totalEntries) * 100) : 0;
            
            const summaryItems = [
                { label: '×¡×”"×› ×”×›× ×¡×•×ª', value: `â‚ª${totalRevenue.toLocaleString()}` },
                { label: '×¡×”"×› ×›× ×™×¡×•×ª', value: totalEntries.toLocaleString() },
                { label: '×××•×¦×¢ ×™×•××™', value: `â‚ª${Math.round(avgDailyRevenue).toLocaleString()}` },
                { label: '×›× ×™×¡×•×ª ×™×•××™×•×ª', value: Math.round(avgDailyEntries).toLocaleString() },
                { label: '×™×¢×™×œ×•×ª ××—×¡×•×', value: `${efficiency.toFixed(1)}%` },
                { label: '×™××™× ×¤×¢×™×œ×™×', value: uniqueDays.toString() }
            ];
            
            let html = '';
            summaryItems.forEach(item => {
                html += `
                    <div class="summary-item">
                        <div class="summary-item-value">${item.value}</div>
                        <div class="summary-item-label">${item.label}</div>
                    </div>
                `;
            });
            
            document.getElementById('summaryGrid').innerHTML = html;
        }

        // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
        function updateStatistics() {
            const totalRevenue = currentData.reduce((sum, d) => sum + (d.total_revenue_shekels || 0), 0);
            const totalEntries = currentData.reduce((sum, d) => sum + (d.t_entry_tot || 0), 0);
            const totalExits = currentData.reduce((sum, d) => sum + (d.t_exit_tot || 0), 0);
            const totalBarrierOpenings = currentData.reduce((sum, d) => sum + (d.t_open_b || 0), 0);
            const totalCash = currentData.reduce((sum, d) => sum + (d.s_cash_shekels || 0), 0);
            const totalCredit = currentData.reduce((sum, d) => sum + (d.s_credit_shekels || 0), 0);
            const totalPango = currentData.reduce((sum, d) => sum + (d.s_pango_shekels || 0), 0);
            const totalCelo = currentData.reduce((sum, d) => sum + (d.s_celo_shekels || 0), 0);
            const totalCasualEntries = currentData.reduce((sum, d) => sum + (d.t_entry_s || 0), 0);
            const totalMemberEntries = currentData.reduce((sum, d) => sum + (d.t_entry_p || 0), 0);
            const totalAppEntries = currentData.reduce((sum, d) => sum + (d.t_entry_ap || 0), 0);
            
            const uniqueDays = [...new Set(currentData.map(d => d.report_date))].length;
            const avgDailyRevenue = uniqueDays > 0 ? totalRevenue / uniqueDays : 0;
            const avgRevenuePerEntry = totalEntries > 0 ? totalRevenue / totalEntries : 0;
            
            const statsCards = [
                {
                    title: '×¡×”"×› ×”×›× ×¡×•×ª',
                    value: `â‚ª${totalRevenue.toLocaleString()}`,
                    subtext: `×××•×¦×¢ ×™×•××™: â‚ª${Math.round(avgDailyRevenue).toLocaleString()}`,
                    trend: null
                },
                {
                    title: '×¡×”"×› ×›× ×™×¡×•×ª',
                    value: totalEntries.toLocaleString(),
                    subtext: `×××•×¦×¢ â‚ª${avgRevenuePerEntry.toFixed(1)} ×œ×›× ×™×¡×”`,
                    trend: null
                },
                {
                    title: '××–×“×× ×™×',
                    value: totalCasualEntries.toLocaleString(),
                    subtext: `${totalEntries > 0 ? ((totalCasualEntries/totalEntries)*100).toFixed(1) : 0}% ××”×›×•×œ×œ`,
                    trend: null
                },
                {
                    title: '×× ×•×™×™×',
                    value: totalMemberEntries.toLocaleString(),
                    subtext: `${totalEntries > 0 ? ((totalMemberEntries/totalEntries)*100).toFixed(1) : 0}% ××”×›×•×œ×œ`,
                    trend: null
                },
                {
                    title: '×ª×©×œ×•××™ ××–×•××Ÿ',
                    value: `â‚ª${totalCash.toLocaleString()}`,
                    subtext: `${totalRevenue > 0 ? ((totalCash/totalRevenue)*100).toFixed(1) : 0}% ××”×”×›× ×¡×•×ª`,
                    trend: null
                },
                {
                    title: '×ª×©×œ×•××™ ××©×¨××™',
                    value: `â‚ª${totalCredit.toLocaleString()}`,
                    subtext: `${totalRevenue > 0 ? ((totalCredit/totalRevenue)*100).toFixed(1) : 0}% ××”×”×›× ×¡×•×ª`,
                    trend: null
                },
                {
                    title: '×¤× ×’×•',
                    value: `â‚ª${totalPango.toLocaleString()}`,
                    subtext: `${totalRevenue > 0 ? ((totalPango/totalRevenue)*100).toFixed(1) : 0}% ××”×”×›× ×¡×•×ª`,
                    trend: null
                },
                {
                    title: '×¡×œ×•',
                    value: `â‚ª${totalCelo.toLocaleString()}`,
                    subtext: `${totalRevenue > 0 ? ((totalCelo/totalRevenue)*100).toFixed(1) : 0}% ××”×”×›× ×¡×•×ª`,
                    trend: null
                },
                {
                    title: '×¤×ª×™×—×•×ª ××—×¡×•×',
                    value: totalBarrierOpenings.toLocaleString(),
                    subtext: `×™×¢×™×œ×•×ª: ${totalEntries > 0 ? ((totalBarrierOpenings/totalEntries)*100).toFixed(1) : 0}%`,
                    trend: totalEntries > 0 && (totalBarrierOpenings/totalEntries) > 1.1 ? 'negative' : 'positive'
                }
            ];
            
            if (totalAppEntries > 0) {
                statsCards.splice(4, 0, {
                    title: '×›× ×™×¡×•×ª ××¤×œ×™×§×¦×™×”',
                    value: totalAppEntries.toLocaleString(),
                    subtext: `${totalEntries > 0 ? ((totalAppEntries/totalEntries)*100).toFixed(1) : 0}% ××”×›×•×œ×œ`,
                    trend: null
                });
            }
            
            let html = '';
            statsCards.forEach(card => {
                let trendHtml = '';
                if (card.trend) {
                    const trendIcon = card.trend === 'positive' ? 'ğŸ“ˆ' : 'ğŸ“‰';
                    trendHtml = `<div class="trend ${card.trend}">${trendIcon}</div>`;
                }
                
                html += `
                    <div class="stat-card">
                        <h3>${card.title}</h3>
                        <div class="value">${card.value}</div>
                        <div class="subtext">${card.subtext}</div>
                        ${trendHtml}
                    </div>
                `;
            });
            
            document.getElementById('statsGrid').innerHTML = html;
        }

        // ×¢×“×›×•×Ÿ ×’×¨×¤×™×
        function updateCharts() {
            createDurationChart();
            createRevenueChart();
            createPaymentChart();
            createTrafficChart();
            createWeeklyChart();
            createEfficiencyChart();
        }

        // ×’×¨×£ ×–×× ×™ ×©×”×™×™×”
        function createDurationChart() {
            const ctx = document.getElementById('durationChart').getContext('2d');
            
            // ×—×™×©×•×‘ ×–×× ×™ ×©×”×™×™×” ××”× ×ª×•× ×™×
            const durationData = {
                '0-15 ×“×§': currentData.reduce((sum, d) => sum + (d.stay_015 || 0), 0),
                '15-30 ×“×§': currentData.reduce((sum, d) => sum + (d.stay_030 || 0), 0),
                '30-45 ×“×§': currentData.reduce((sum, d) => sum + (d.stay045 || 0), 0),
                '45-60 ×“×§': currentData.reduce((sum, d) => sum + (d.stay_060 || 0), 0),
                '1-2 ×©×¢×•×ª': currentData.reduce((sum, d) => sum + (d.stay_2 || 0), 0),
                '2-3 ×©×¢×•×ª': currentData.reduce((sum, d) => sum + (d.stay_3 || 0), 0),
                '3-4 ×©×¢×•×ª': currentData.reduce((sum, d) => sum + (d.stay4 || 0), 0),
                '4-5 ×©×¢×•×ª': currentData.reduce((sum, d) => sum + (d.stay5 || 0), 0),
                '5-6 ×©×¢×•×ª': currentData.reduce((sum, d) => sum + (d.stay6 || 0), 0),
                '6+ ×©×¢×•×ª': currentData.reduce((sum, d) => sum + (d.stay724 || 0), 0)
            };
            
            const labels = Object.keys(durationData);
            const values = Object.values(durationData);
            const total = values.reduce((sum, val) => sum + val, 0);
            
            if (charts.duration) charts.duration.destroy();
            
            charts.duration = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '×›××•×ª ×›× ×™×¡×•×ª',
                        data: values,
                        backgroundColor: [
                            'rgba(0, 122, 255, 0.8)',
                            'rgba(88, 86, 214, 0.8)',
                            'rgba(175, 82, 222, 0.8)',
                            'rgba(255, 45, 85, 0.8)',
                            'rgba(255, 159, 10, 0.8)',
                            'rgba(48, 209, 88, 0.8)',
                            'rgba(100, 210, 255, 0.8)',
                            'rgba(191, 90, 242, 0.8)',
                            'rgba(255, 214, 10, 0.8)',
                            'rgba(162, 132, 94, 0.8)'
                        ],
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${value.toLocaleString()} ×›× ×™×¡×•×ª (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            showDurationDetails(labels[elements[0].index], values[elements[0].index], total);
                        }
                    }
                }
            });
        }

        // ×”×¦×’×ª ×¤×™×¨×•×˜ ×–×× ×™ ×©×”×™×™×”
        function showDurationDetails(timeRange, count, total) {
            const percentage = ((count / total) * 100).toFixed(1);
            const avgDailyCount = count / [...new Set(currentData.map(d => d.report_date))].length;
            
            const detailsPanel = document.getElementById('durationDetails');
            detailsPanel.innerHTML = `
                <div style="text-align: center;">
                    <h4 style="color: #007AFF; margin-bottom: 12px;">${timeRange}</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div>
                            <div style="font-size: 18px; font-weight: bold; color: #1d1d1f;">${count.toLocaleString()}</div>
                            <div style="font-size: 12px; color: #8e8e93;">×¡×”"×› ×›× ×™×¡×•×ª</div>
                        </div>
                        <div>
                            <div style="font-size: 18px; font-weight: bold; color: #007AFF;">${percentage}%</div>
                            <div style="font-size: 12px; color: #8e8e93;">××›×œ×œ ×”×›× ×™×¡×•×ª</div>
                        </div>
                        <div>
                            <div style="font-size: 18px; font-weight: bold; color: #30D158;">${Math.round(avgDailyCount)}</div>
                            <div style="font-size: 12px; color: #8e8e93;">×××•×¦×¢ ×™×•××™</div>
                        </div>
                    </div>
                </div>
            `;
            detailsPanel.style.display = 'block';
        }

        // ×’×¨×£ ××’××•×ª ×”×›× ×¡×•×ª
        function createRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            const dailyData = {};
            currentData.forEach(d => {
                if (!dailyData[d.report_date]) {
                    dailyData[d.report_date] = { revenue: 0, isWeekend: false };
                }
                dailyData[d.report_date].revenue += d.total_revenue_shekels || 0;
                
                // ×‘×“×™×§×” ×× ×–×” ×¡×•×£ ×©×‘×•×¢
                const date = new Date(d.report_date);
                const dayOfWeek = date.getDay();
                dailyData[d.report_date].isWeekend = dayOfWeek === 5 || dayOfWeek === 6;
            });

            const dates = Object.keys(dailyData).sort();
            const revenues = dates.map(date => dailyData[date].revenue);
            const colors = dates.map(date => dailyData[date].isWeekend ? 'rgba(255, 59, 48, 0.8)' : 'rgba(0, 122, 255, 0.8)');

            if (charts.revenue) charts.revenue.destroy();

            charts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '×”×›× ×¡×•×ª ×™×•××™×•×ª',
                        data: revenues,
                        borderColor: 'rgba(0, 122, 255, 1)',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        pointBackgroundColor: colors,
                        pointBorderColor: colors,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            cornerRadius: 8,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    return `×”×›× ×¡×•×ª: â‚ª${context.raw.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'â‚ª' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ×’×¨×£ ×××¦×¢×™ ×ª×©×œ×•×
        function createPaymentChart() {
            const ctx = document.getElementById('paymentChart').getContext('2d');
            
            const totalCash = currentData.reduce((sum, d) => sum + (d.s_cash_shekels || 0), 0);
            const totalCredit = currentData.reduce((sum, d) => sum + (d.s_credit_shekels || 0), 0);
            const totalPango = currentData.reduce((sum, d) => sum + (d.s_pango_shekels || 0), 0);
            const totalCelo = currentData.reduce((sum, d) => sum + (d.s_celo_shekels || 0), 0);

            if (charts.payment) charts.payment.destroy();

            charts.payment = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['××–×•××Ÿ', '××©×¨××™', '×¤× ×’×•', '×¡×œ×•'],
                    datasets: [{
                        data: [totalCash, totalCredit, totalPango, totalCelo],
                        backgroundColor: [
                            'rgba(0, 122, 255, 0.8)',
                            'rgba(88, 86, 214, 0.8)', 
                            'rgba(48, 209, 88, 0.8)',
                            'rgba(175, 82, 222, 0.8)'
                        ],
                        borderWidth: 0,
                        cutout: '60%'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return {
                                                text: `${label}: â‚ª${value.toLocaleString()} (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            cornerRadius: 8
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const paymentTypes = ['××–×•××Ÿ', '××©×¨××™', '×¤× ×’×•', '×¡×œ×•'];
                            const values = [totalCash, totalCredit, totalPango, totalCelo];
                            showPaymentDetails(paymentTypes[elementIndex], values[elementIndex]);
                        }
                    }
                }
            });
        }

        // ×”×¦×’×ª ×¤×™×¨×•×˜ ×ª×©×œ×•××™×
        function showPaymentDetails(paymentType, amount) {
            const total = [totalCash, totalCredit, totalPango, totalCelo].reduce((a, b) => a + b, 0);
            const percentage = ((amount / total) * 100).toFixed(1);
            const avgDaily = amount / [...new Set(currentData.map(d => d.report_date))].length;
            
            const detailsPanel = document.getElementById('paymentDetails');
            detailsPanel.innerHTML = `
                <div style="text-align: center;">
                    <h4 style="color: #007AFF; margin-bottom: 12px;">×ª×©×œ×•××™ ${paymentType}</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div>
                            <div style="font-size: 18px; font-weight: bold; color: #1d1d1f;">â‚ª${amount.toLocaleString()}</div>
                            <div style="font-size: 12px; color: #8e8e93;">×¡×”"×› ×¡×›×•×</div>
                        </div>
                        <div>
                            <div style="font-size: 18px; font-weight: bold; color: #007AFF;">${percentage}%</div>
                            <div style="font-size: 12px; color: #8e8e93;">××›×œ×œ ×”×”×›× ×¡×•×ª</div>
                        </div>
                        <div>
                            <div style="font-size: 18px; font-weight: bold; color: #30D158;">â‚ª${Math.round(avgDaily).toLocaleString()}</div>
                            <div style="font-size: 12px; color: #8e8e93;">×××•×¦×¢ ×™×•××™</div>
                        </div>
                    </div>
                </div>
            `;
            detailsPanel.style.display = 'block';
        }

        // ×’×¨×£ × ×™×ª×•×— ×ª× ×•×¢×”
        function createTrafficChart() {
            const ctx = document.getElementById('trafficChart').getContext('2d');
            
            const dailyTraffic = {};
            currentData.forEach(d => {
                if (!dailyTraffic[d.report_date]) {
                    dailyTraffic[d.report_date] = { entries: 0, exits: 0 };
                }
                dailyTraffic[d.report_date].entries += d.t_entry_tot || 0;
                dailyTraffic[d.report_date].exits += d.t_exit_tot || 0;
            });

            const dates = Object.keys(dailyTraffic).sort();
            const entries = dates.map(date => dailyTraffic[date].entries);
            const exits = dates.map(date => dailyTraffic[date].exits);

            if (charts.traffic) charts.traffic.destroy();

            charts.traffic = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: '×›× ×™×¡×•×ª',
                            data: entries,
                            backgroundColor: 'rgba(0, 122, 255, 0.8)',
                            borderRadius: 4,
                            borderSkipped: false,
                        },
                        {
                            label: '×™×¦×™××•×ª', 
                            data: exits,
                            backgroundColor: 'rgba(88, 86, 214, 0.8)',
                            borderRadius: 4,
                            borderSkipped: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { 
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ×’×¨×£ ×”×©×•×•××” ×©×‘×•×¢×™×ª
        function createWeeklyChart() {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            
            const weekdays = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
            const weeklyData = {};
            
            weekdays.forEach(day => {
                weeklyData[day] = { revenue: 0, count: 0, isWeekend: day === '×©×™×©×™' || day === '×©×‘×ª' };
            });

            currentData.forEach(d => {
                const date = new Date(d.report_date);
                const dayName = weekdays[date.getDay()];
                if (weeklyData[dayName]) {
                    weeklyData[dayName].revenue += d.total_revenue_shekels || 0;
                    weeklyData[dayName].count++;
                }
            });

            const avgRevenues = weekdays.map(day => 
                weeklyData[day].count > 0 ? weeklyData[day].revenue / weeklyData[day].count : 0
            );
            
            const colors = weekdays.map(day => 
                weeklyData[day].isWeekend ? 'rgba(255, 59, 48, 0.8)' : 'rgba(0, 122, 255, 0.8)'
            );

            if (charts.weekly) charts.weekly.destroy();

            charts.weekly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weekdays,
                    datasets: [{
                        label: '×××•×¦×¢ ×”×›× ×¡×•×ª',
                        data: avgRevenues,
                        backgroundColor: colors,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'â‚ª' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ×’×¨×£ ×™×¢×™×œ×•×ª ××—×¡×•××™×
        function createEfficiencyChart() {
            const ctx = document.getElementById('efficiencyChart').getContext('2d');
            
            const dailyEfficiency = {};
            currentData.forEach(d => {
                if (!dailyEfficiency[d.report_date]) {
                    dailyEfficiency[d.report_date] = { barriers: 0, entries: 0 };
                }
                dailyEfficiency[d.report_date].barriers += d.t_open_b || 0;
                dailyEfficiency[d.report_date].entries += d.t_entry_tot || 0;
            });

            const dates = Object.keys(dailyEfficiency).sort();
            const efficiencyRates = dates.map(date => {
                const data = dailyEfficiency[date];
                return data.entries > 0 ? ((data.barriers / data.entries) * 100) : 0;
            });

            // ×¦×‘×¢ ×¢×œ ×¤×™ ×™×¢×™×œ×•×ª - ×™×¨×•×§ ×¢×“ 110%, ×›×ª×•× ×¢×“ 130%, ××“×•× ××¢×œ
            const colors = efficiencyRates.map(rate => {
                if (rate <= 110) return 'rgba(48, 209, 88, 0.8)';
                if (rate <= 130) return 'rgba(255, 214, 10, 0.8)';
                return 'rgba(255, 59, 48, 0.8)';
            });

            if (charts.efficiency) charts.efficiency.destroy();

            charts.efficiency = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '×™×¢×™×œ×•×ª ××—×¡×•× (%)',
                        data: efficiencyRates,
                        borderColor: 'rgba(0, 122, 255, 1)',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        pointBackgroundColor: colors,
                        pointBorderColor: colors,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        tension: 0.3,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    const efficiency = context.raw.toFixed(1);
                                    let status = 'âœ… ××¦×•×™×Ÿ';
                                    if (efficiency > 110) status = 'âš ï¸ ×’×‘×•×”';
                                    if (efficiency > 130) status = 'ğŸš¨ ×—×¨×™×’';
                                    return `×™×¢×™×œ×•×ª: ${efficiency}% ${status}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ×¢×“×›×•×Ÿ ×”×ª×¨××•×ª
        function updateAlerts() {
            const alerts = findTrends();
            let html = '';
            
            if (alerts.length === 0) {
                html = `
                    <div class="alert positive">
                        <div class="alert-icon">âœ…</div>
                        <div class="alert-content">
                            <div class="alert-title">×”××¢×¨×›×ª ×¤×•×¢×œ×ª ×‘×¦×•×¨×” ×ª×§×™× ×”</div>
                            <div class="alert-details">×œ× ×–×•×”×• ×©×™× ×•×™×™× ××©××¢×•×ª×™×™× ××• ×—×¨×™×’×•×ª ×‘× ×ª×•× ×™×</div>
                        </div>
                    </div>
                `;
            } else {
                alerts.slice(0, 5).forEach(alert => {
                    const isPositive = alert.change > 0;
                    const alertClass = isPositive ? 'positive' : 'negative';
                    const icon = isPositive ? 'ğŸ“ˆ' : 'ğŸ“‰';
                    
                    html += `
                        <div class="alert ${alertClass}">
                            <div class="alert-icon">${icon}</div>
                            <div class="alert-content">
                                <div class="alert-title">×©×™× ×•×™ ×‘${alert.type}${isSingleParking ? '' : ' - ' + alert.parking}</div>
                                <div class="alert-details">
                                    ${alert.previousDate}: ${alert.previous.toLocaleString()} â†’ 
                                    ${alert.currentDate}: ${alert.current.toLocaleString()} 
                                    (${alert.change > 0 ? '+' : ''}${alert.change.toFixed(1)}%)
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('alertsContainer').innerHTML = html;
        }

        // ×¤×•× ×§×¦×™×” ×œ×–×™×”×•×™ ××’××•×ª
        function findTrends() {
            const alerts = [];
            const weeklyData = {};
            
            // ×§×™×‘×•×¥ ×œ×¤×™ ×—× ×™×•×Ÿ ×•×©×‘×•×¢
            currentData.forEach(d => {
                const date = new Date(d.report_date);
                const weekNumber = Math.floor(date.getTime() / (7 * 24 * 60 * 60 * 1000));
                const parkingName = d.parking_name || '×—× ×™×•×Ÿ';
                
                if (!weeklyData[parkingName]) weeklyData[parkingName] = {};
                if (!weeklyData[parkingName][weekNumber]) {
                    weeklyData[parkingName][weekNumber] = {
                        revenue: 0,
                        barriers: 0,
                        entries: 0,
                        dates: []
                    };
                }
                
                weeklyData[parkingName][weekNumber].revenue += d.total_revenue_shekels || 0;
                weeklyData[parkingName][weekNumber].barriers += d.t_open_b || 0;
                weeklyData[parkingName][weekNumber].entries += d.t_entry_tot || 0;
                weeklyData[parkingName][weekNumber].dates.push(d.report_date);
            });
            
            // ×—×™×¤×•×© ××’××•×ª
            Object.keys(weeklyData).forEach(parkingName => {
                const weeks = Object.keys(weeklyData[parkingName]).sort((a, b) => b - a);
                
                if (weeks.length >= 2) {
                    const currentWeek = weeklyData[parkingName][weeks[0]];
                    const previousWeek = weeklyData[parkingName][weeks[1]];
                    
                    // ×‘×“×™×§×ª ×©×™× ×•×™ ×‘×”×›× ×¡×•×ª
                    if (previousWeek.revenue > 0) {
                        const revenueChange = ((currentWeek.revenue - previousWeek.revenue) / previousWeek.revenue) * 100;
                        if (Math.abs(revenueChange) >= 10) {
                            alerts.push({
                                type: '×”×›× ×¡×•×ª',
                                parking: parkingName,
                                change: revenueChange,
                                current: currentWeek.revenue,
                                previous: previousWeek.revenue,
                                currentDate: `×©×‘×•×¢ × ×•×›×—×™`,
                                previousDate: `×©×‘×•×¢ ×§×•×“×`
                            });
                        }
                    }
                    
                    // ×‘×“×™×§×ª ×©×™× ×•×™ ×‘×›× ×™×¡×•×ª
                    if (previousWeek.entries > 0) {
                        const entriesChange = ((currentWeek.entries - previousWeek.entries) / previousWeek.entries) * 100;
                        if (Math.abs(entriesChange) >= 10) {
                            alerts.push({
                                type: '×›× ×™×¡×•×ª',
                                parking: parkingName,
                                change: entriesChange,
                                current: currentWeek.entries,
                                previous: previousWeek.entries,
                                currentDate: `×©×‘×•×¢ × ×•×›×—×™`,
                                previousDate: `×©×‘×•×¢ ×§×•×“×`
                            });
                        }
                    }
                    
                    // ×‘×“×™×§×ª ×™×¢×™×œ×•×ª ××—×¡×•× ×—×¨×™×’×”
                    if (currentWeek.entries > 0) {
                        const efficiency = (currentWeek.barriers / currentWeek.entries) * 100;
                        if (efficiency > 130) {
                            alerts.push({
                                type: '×™×¢×™×œ×•×ª ××—×¡×•×',
                                parking: parkingName,
                                change: efficiency - 100,
                                current: efficiency,
                                previous: 100,
                                currentDate: `×™×¢×™×œ×•×ª × ×•×›×—×™×ª`,
                                previousDate: `×™×¢×™×œ×•×ª ××™×“×™××œ×™×ª`
                            });
                        }
                    }
                }
            });
            
            return alerts.sort((a, b) => Math.abs(b.change) - Math.abs(a.change));
        }

        // ×¢×“×›×•×Ÿ ×“×™×¨×•×’ ×”×—× ×™×•× ×™× (×¨×§ ×œ××©×ª××©×™× ×¢× ××¡×¤×¨ ×—× ×™×•× ×™×)
        function updateRankings() {
            if (isSingleParking) return;
            
            const parkingStats = {};
            
            currentData.forEach(d => {
                const parkingName = d.parking_name || '×—× ×™×•×Ÿ ×œ× ××–×•×”×”';
                if (!parkingStats[parkingName]) {
                    parkingStats[parkingName] = {
                        revenue: 0,
                        entries: 0,
                        barriers: 0,
                        casualEntries: 0,
                        memberEntries: 0
                    };
                }
                
                parkingStats[parkingName].revenue += d.total_revenue_shekels || 0;
                parkingStats[parkingName].entries += d.t_entry_tot || 0;
                parkingStats[parkingName].barriers += d.t_open_b || 0;
                parkingStats[parkingName].casualEntries += d.t_entry_s || 0;
                parkingStats[parkingName].memberEntries += d.t_entry_p || 0;
            });

            const rankings = Object.entries(parkingStats)
                .map(([name, stats]) => ({
                    name: name,
                    revenue: stats.revenue,
                    entries: stats.entries,
                    barriers: stats.barriers,
                    efficiency: stats.entries > 0 ? (stats.barriers / stats.entries * 100).toFixed(1) : 0,
                    memberPercent: stats.entries > 0 ? (stats.memberEntries / stats.entries * 100).toFixed(1) : 0,
                    avgRevenuePerEntry: stats.entries > 0 ? (stats.revenue / stats.entries).toFixed(1) : 0
                }))
                .sort((a, b) => b.revenue - a.revenue);

            let html = '';
            rankings.forEach((parking, index) => {
                let medal = '';
                if (index === 0) medal = 'ğŸ¥‡ ';
                else if (index === 1) medal = 'ğŸ¥ˆ ';
                else if (index === 2) medal = 'ğŸ¥‰ ';
                
                const efficiencyColor = parking.efficiency > 130 ? '#FF3B30' : parking.efficiency > 110 ? '#FF9500' : '#30D158';
                
                html += `
                    <div class="rank-item">
                        <div class="rank-number">${index + 1}</div>
                        <div class="rank-info">
                            <div class="rank-name">${medal}${parking.name}</div>
                            <div class="rank-details">
                                ${parking.entries.toLocaleString()} ×›× ×™×¡×•×ª â€¢ 
                                ${parking.memberPercent}% ×× ×•×™×™× â€¢ 
                                ×™×¢×™×œ×•×ª: <span style="color: ${efficiencyColor}; font-weight: bold;">${parking.efficiency}%</span> â€¢ 
                                ×××•×¦×¢: â‚ª${parking.avgRevenuePerEntry}
                            </div>
                        </div>
                        <div class="rank-value">
                            â‚ª${parking.revenue.toLocaleString()}
                            <div class="rank-subvalue">${parking.barriers.toLocaleString()} ×¤×ª×™×—×•×ª</div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('rankingsContainer').innerHTML = html;
        }

        // ×”×’×“×¨×ª event listeners
        function setupEventListeners() {
            // ×›×¤×ª×•×¨×™ ×˜×¢×™× ×ª × ×ª×•× ×™×
            document.getElementById('loadDataBtn').addEventListener('click', loadParkingData);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // ×›×¤×ª×•×¨×™ ×˜×•×•×—×™× ××”×™×¨×™×
            document.querySelectorAll('.quick-range').forEach(btn => {
                btn.addEventListener('click', function() {
                    setQuickRange(this.dataset.range);
                });
            });
            
            // ×›×¤×ª×•×¨ ×—×™×¤×•×© ××ª×§×“×
            document.getElementById('investigateBtn').addEventListener('click', async function() {
                if (!userData) {
                    showError('âŒ × ×ª×•× ×™ ××©×ª××© ×œ× × ×˜×¢× ×• ×¢×“×™×™×Ÿ');
                    return;
                }
                
                try {
                    showLoading(true);
                    
                    // ×—×™×¤×•×© ×‘×˜×•×•×— ×¨×—×‘ ×××•×“ (2 ×©× ×™×)
                    const endDate = new Date();
                    const startDate = new Date(endDate.getFullYear() - 2, 0, 1);
                    
                    const params = new URLSearchParams({
                        start_date: formatDateForAPI(startDate),
                        end_date: formatDateForAPI(endDate)
                    });
                    
                    const response = await fetch(`/api/parking-data?${params}`);
                    const result = await response.json();
                    
                    if (result.success && result.data.length > 0) {
                        // × ×™×ª×•×— ×”×ª××¨×™×›×™× ×©× ××¦××•
                        const dates = result.data.map(d => d.report_date).sort();
                        const firstDate = dates[0];
                        const lastDate = dates[dates.length - 1];
                        
                        // ×¢×“×›×•×Ÿ ×”×©×“×•×ª ×¢× ×”×˜×•×•×— ×©× ××¦×
                        const firstDateObj = new Date(firstDate);
                        const lastDateObj = new Date(lastDate);
                        document.getElementById('startDate').value = formatDateForInput(firstDateObj);
                        document.getElementById('endDate').value = formatDateForInput(lastDateObj);
                        
                        currentData = result.data;
                        updateDashboard();
                        
                        showError(`ğŸ” × ××¦××• ${result.data.length} ×¨×©×•××•×ª ×‘×˜×•×•×— ${formatDateForInput(firstDateObj)} - ${formatDateForInput(lastDateObj)}`);
                    } else {
                        showError(`ğŸš§ ×œ× × ××¦××• × ×ª×•× ×™× ×¢×‘×•×¨ ${userData.parking_name}. ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª.`);
                    }
                    
                } catch (error) {
                    showError('âŒ ×©×’×™××” ×‘×—×™×¤×•×© ×”××ª×§×“×: ' + error.message);
                } finally {
                    showLoading(false);
                }
            });
            
            // ××™××•×ª ×ª××¨×™×›×™× ×‘×–××Ÿ ×”×§×œ×“×”
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            [startDateInput, endDateInput].forEach(input => {
                input.addEventListener('input', function() {
                    // ×”×•×¡×¤×ª ×¡×œ××©×™× ××•×˜×•××˜×™×ª
                    let value = this.value.replace(/\D/g, '');
                    
                    if (value.length >= 2) {
                        let day = value.substring(0, 2);
                        if (parseInt(day) > 31) day = '31';
                        value = day + '/' + value.substring(2);
                    }
                    if (value.length >= 5) {
                        let month = value.substring(3, 5);
                        if (parseInt(month) > 12) month = '12';
                        value = value.substring(0, 3) + month + '/' + value.substring(5, 9);
                    }
                    
                    this.value = value;
                    
                    // ××™× ×“×™×§×˜×•×¨ ×•×™×–×•××œ×™
                    if (value.length === 10) {
                        const date = parseInputDate(value);
                        if (date) {
                            this.style.borderColor = '#30D158';
                            this.style.backgroundColor = 'rgba(48, 209, 88, 0.05)';
                        } else {
                            this.style.borderColor = '#FF3B30';
                            this.style.backgroundColor = 'rgba(255, 59, 48, 0.05)';
                        }
                    } else {
                        this.style.borderColor = 'rgba(0, 0, 0, 0.1)';
                        this.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                    }
                });
                
                // ×˜×¢×™× ×” ×¢× Enter
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        loadParkingData();
                    }
                });
            });
        }

        // ×”×’×“×¨×ª ×˜×•×•×— ×ª××¨×™×›×™× ××”×™×¨
        function setQuickRange(range) {
            const today = new Date();
            let startDate, endDate;
            
            switch(range) {
                case 'yesterday':
                    startDate = endDate = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    endDate = today;
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'lastmonth':
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    break;
                default:
                    return;
            }
            
            document.getElementById('startDate').value = formatDateForInput(startDate);
            document.getElementById('endDate').value = formatDateForInput(endDate);
            
            // ×˜×¢×Ÿ × ×ª×•× ×™× ××•×˜×•××˜×™×ª
            loadParkingData();
        }

        // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
        function showLoading(show) {
            const loadingSection = document.getElementById('loadingSection');
            const dashboardContent = document.getElementById('dashboardContent');
            
            if (show) {
                loadingSection.classList.remove('hidden');
                dashboardContent.classList.add('hidden');
            } else {
                loadingSection.classList.add('hidden');
            }
        }

        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            const dashboardContent = document.getElementById('dashboardContent');
            
            document.getElementById('errorMessage').innerHTML = message;
            errorSection.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
        }

        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }

        function logout() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?')) {
                window.location.href = '/logout';
            }
        }

        // ×× ×™××¦×™×•×ª × ×•×¡×¤×•×ª
        document.addEventListener('DOMContentLoaded', function() {
            // ×× ×™××¦×™×™×ª ×”×•×¤×¢×” ×—×œ×§×” ×œ×§×œ×¤×™ ×”×¡×˜×˜×™×¡×˜×™×§×”
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, observerOptions);

            // ×”×ª×—×œ×” ×¢× ××œ×× ×˜×™× ××•×¡×ª×¨×™×
            const animatedElements = document.querySelectorAll('.stat-card, .chart-card, .alerts-section, .rankings');
            animatedElements.forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                el.style.transition = 'all 0.6s ease';
                observer.observe(el);
            });
        });

        // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×–××Ÿ ×××ª (××•×¤×¦×™×•× ×œ×™)
        function startRealTimeUpdates() {
            setInterval(async function() {
                // ×¨×§ ×× ×× ×—× ×• ××¦×™×’×™× × ×ª×•× ×™ ××ª××•×œ
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const today = formatDateForInput(new Date());
                const yesterday = formatDateForInput(new Date(Date.now() - 24 * 60 * 60 * 1000));
                
                if (startDate === yesterday && endDate === yesterday) {
                    await loadParkingData();
                }
            }, 5 * 60 * 1000); // ×¢×“×›×•×Ÿ ×›×œ 5 ×“×§×•×ª
        }

        // ×”×¤×¢×œ×ª ×¢×“×›×•× ×™× ×‘×–××Ÿ ×××ª ××—×¨×™ ×˜×¢×™× ×” ×¨××©×•× ×™×ª
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(startRealTimeUpdates, 10000); // ×”×ª×—×œ ××—×¨×™ 10 ×©× ×™×•×ª
        });
    </script>
</body>
</html>
