<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>לוח בקרה - חניונים</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #007AFF;
            --primary-light: #5AC8FA;
            --primary-dark: #0051D5;
            --success: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            --purple: #AF52DE;
            --background: #F2F2F7;
            --surface: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #6C6C70;
            --text-tertiary: #8E8E93;
            --border: #E5E5EA;
            --shadow: 0 2px 15px rgba(0,0,0,0.08);
            --shadow-hover: 0 8px 30px rgba(0,0,0,0.12);
            --radius: 16px;
            --radius-small: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Heebo', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            font-weight: 400;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Styles */
        .header {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: var(--shadow);
            animation: fadeInDown 0.8s ease;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            letter-spacing: -1px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .user-name {
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .logout-btn {
            padding: 10px 20px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: var(--radius-small);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3);
        }
        
        /* Control Panel */
        .control-panel {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .control-group {
            flex: 1;
            min-width: 250px;
        }
        
        .control-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }
        
        .control-input, .control-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-small);
            font-size: 16px;
            font-family: inherit;
            background: var(--surface);
            transition: all 0.3s ease;
        }
        
        .control-input:focus, .control-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .load-btn {
            padding: 12px 32px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 20%);
            color: white;
            border: none;
            border-radius: var(--radius-small);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .load-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
        }
        
        .load-btn:active {
            transform: translateY(0);
        }
        
        /* Quick Range Buttons */
        .quick-ranges {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        .quick-btn {
            padding: 8px 16px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: var(--radius-small);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quick-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
        }
        
        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        .loading-text {
            font-size: 18px;
            color: var(--text-secondary);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            animation: fadeIn 0.8s ease;
        }
        
        .stat-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 28px;
            box-shadow: var(--shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, transparent 40%, rgba(0, 122, 255, 0.05) 100%);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }
        
        .stat-card .icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius-small);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 16px;
        }
        
        .stat-card h3 {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .stat-card .subtext {
            color: var(--text-tertiary);
            font-size: 14px;
            margin-top: 8px;
        }
        
        /* Chart Sections */
        .chart-section {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            animation: fadeIn 0.8s ease;
        }
        
        .chart-section:hover {
            box-shadow: var(--shadow-hover);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .chart-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }
        
        /* Alerts Section */
        .alerts-section {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            display: none;
        }
        
        .alert-item {
            padding: 20px;
            border-radius: var(--radius-small);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
        }
        
        .alert-item:hover {
            transform: translateX(-4px);
        }
        
        .alert-item.positive {
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.1) 0%, rgba(52, 199, 89, 0.05) 100%);
            border-right: 4px solid var(--success);
        }
        
        .alert-item.negative {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.1) 0%, rgba(255, 59, 48, 0.05) 100%);
            border-right: 4px solid var(--danger);
        }
        
        .alert-icon {
            font-size: 24px;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .alert-description {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* Error State */
        .error-message {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.1) 0%, rgba(255, 59, 48, 0.05) 100%);
            border: 2px solid var(--danger);
            color: var(--danger);
            padding: 24px;
            border-radius: var(--radius);
            margin: 24px 0;
            text-align: center;
            display: none;
        }
        
        /* Single Parking Mode */
        .single-parking-mode .multi-parking-only {
            display: none !important;
        }
        
        /* Animations */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 36px; }
            .charts-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .stat-card { padding: 20px; }
            .stat-card .value { font-size: 24px; }
            .control-panel { flex-direction: column; }
            .control-group { width: 100%; }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--background);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <h1>לוח בקרה - <span id="dashboardTitle">טוען...</span></h1>
                <div class="user-info">
                    <span class="user-name" id="userName">טוען...</span>
                    <button class="logout-btn" onclick="logout()">
                        יציאה
                    </button>
                </div>
            </div>
            
            <!-- Control Panel -->
            <div class="control-panel">
                <!-- Parking Selector -->
                <div class="control-group" id="parkingSelectorGroup" style="display: none;">
                    <label class="control-label">בחר חניון</label>
                    <select id="parkingSelector" class="control-select">
                        <option value="">טוען חניונים...</option>
                    </select>
                </div>
                
                <!-- Date Range -->
                <div class="control-group">
                    <label class="control-label">מתאריך</label>
                    <input type="date" id="startDate" class="control-input">
                </div>
                
                <div class="control-group">
                    <label class="control-label">עד תאריך</label>
                    <input type="date" id="endDate" class="control-input">
                </div>
                
                <!-- Load Button -->
                <button class="load-btn" onclick="loadData()">
                    <span>📊</span>
                    <span>טען נתונים</span>
                </button>
            </div>
            
            <!-- Quick Range Buttons -->
            <div class="quick-ranges">
                <button class="quick-btn" onclick="setQuickRange('yesterday')">אתמול</button>
                <button class="quick-btn" onclick="setQuickRange('week')">השבוע</button>
                <button class="quick-btn" onclick="setQuickRange('lastWeek')">שבוע שעבר</button>
                <button class="quick-btn" onclick="setQuickRange('month')">החודש</button>
                <button class="quick-btn" onclick="setQuickRange('lastMonth')">חודש שעבר</button>
                <button class="quick-btn" onclick="setQuickRange('year')">השנה</button>
            </div>
        </div>
        
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <div class="loading-text">טוען נתונים...</div>
            </div>
        </div>
        
        <!-- Error Message -->
        <div class="error-message" id="errorMessage">
            <h3>שגיאה בטעינת הנתונים</h3>
            <p id="errorText"></p>
        </div>
        
        <!-- Dashboard Content -->
        <div id="dashboardContent">
            <!-- Stats Grid -->
            <div class="stats-grid" id="statsGrid">
                <!-- Dynamic content -->
            </div>
            
            <!-- Alerts Section -->
            <div class="alerts-section" id="alertsSection">
                <div class="chart-header">
                    <h2 class="chart-title">
                        <span>⚡</span>
                        <span>התראות ומגמות</span>
                    </h2>
                </div>
                <div id="alertsContainer">
                    <!-- Dynamic alerts -->
                </div>
            </div>
            
            <!-- Charts Grid -->
            <div class="charts-grid">
                <!-- Revenue Trends Chart -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>📈</span>
                            <span>מגמת הכנסות</span>
                        </h2>
                    </div>
                    <canvas id="revenueChart"></canvas>
                </div>
                
                <!-- Payment Methods Chart -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>💳</span>
                            <span>אמצעי תשלום</span>
                        </h2>
                    </div>
                    <canvas id="paymentChart"></canvas>
                </div>
                
                <!-- Entries Chart -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>🚗</span>
                            <span>סוגי כניסות</span>
                        </h2>
                    </div>
                    <canvas id="entriesChart"></canvas>
                </div>
                
                <!-- Daily Comparison Chart -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>📅</span>
                            <span>השוואה יומית</span>
                        </h2>
                    </div>
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
            
            <!-- Multi-Parking Charts -->
            <div class="charts-grid multi-parking-only">
                <!-- Parking Comparison Chart -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>🏢</span>
                            <span>השוואת חניונים</span>
                        </h2>
                        <p style="margin: 0; font-size: 14px; color: var(--text-secondary); font-weight: 400;">לחץ על חניון לפירוט מלא</p>
                    </div>
                    <canvas id="parkingComparisonChart"></canvas>
                    
                    <!-- Parking Details Section (for group users) -->
                    <div id="parkingDetailsSection" style="display: none; margin-top: 20px; padding: 20px; background: var(--background); border-radius: 12px;">
                        <div id="parkingDetailsHeader" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 id="parkingDetailsTitle" style="font-size: 20px; font-weight: 600;"></h3>
                            <button onclick="closeParkingDetails()" style="
                                background: none;
                                border: none;
                                font-size: 24px;
                                cursor: pointer;
                                color: var(--text-secondary);
                                padding: 5px;
                            ">×</button>
                        </div>
                        <div id="parkingDetailsContent">
                            <!-- Details will be filled here -->
                        </div>
                    </div>
                </div>
                
                <!-- Parking Ranking -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>🏆</span>
                            <span>דירוג חניונים</span>
                        </h2>
                    </div>
                    <div id="parkingRanking"></div>
                </div>
            </div>
            
            <!-- Stay Duration Chart -->
            <div class="chart-section">
                <div class="chart-header">
                    <h2 class="chart-title">
                        <span>⏱️</span>
                        <span>זמני שהייה</span>
                    </h2>
                </div>
                <canvas id="stayDurationChart" style="max-height: 250px;"></canvas>
            </div>
            
            <!-- Barrier & Encoders Section -->
            <div class="charts-grid">
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>🚧</span>
                            <span>פתיחות מחסום</span>
                        </h2>
                    </div>
                    <canvas id="barrierChart"></canvas>
                </div>
                
                <div class="chart-section">
                    <div class="chart-header">
                        <h2 class="chart-title">
                            <span>🔢</span>
                            <span>נתוני מקודדים</span>
                        </h2>
                    </div>
                    <div id="encodersInfo"></div>
                </div>
            </div>
        </div>
    </div>

<script>
// Global variables
let currentData = [];
let charts = {};
let isSingleParkingMode = false;
let isGroup = false;
let groupName = '';
let userParkings = [];

// Chart.js default configuration
Chart.defaults.font.family = "'Heebo', -apple-system, BlinkMacSystemFont, sans-serif";
Chart.defaults.color = '#6C6C70';
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.padding = 20;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
});

// Initialize dashboard
async function initializeDashboard() {
    try {
        // Set default dates (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        document.getElementById('endDate').value = formatDateForInput(today);
        document.getElementById('startDate').value = formatDateForInput(thirtyDaysAgo);
        
        // Load user info
        await loadUserInfo();
        
        // Load parking list
        await loadParkingList();
        
        // Load initial data
        await loadData();
        
        // Show special message for group users
        if (isGroup) {
            console.log('Group user detected. Special handling may be needed.');
            // CSV upload option removed per user request
        }
    } catch (error) {
        console.error('Initialization error:', error);
        showError('שגיאה באתחול המערכת');
    }
}

// Format date for input field
function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Format date for API
function formatDateForAPI(date) {
    return date.toISOString().split('T')[0];
}

// Load user info
async function loadUserInfo() {
    try {
        const response = await fetch('/api/user-info');
        const result = await response.json();
        
        if (result.success && result.user) {
            document.getElementById('userName').textContent = result.user.username || 'משתמש';
            
            // Check if this is a group (project_number = 0 or role = group_manager)
            if (result.user.project_number === 0 || result.user.role === 'group_manager') {
                isGroup = true;
                groupName = result.user.parking_name || 'קבוצה';
                document.getElementById('dashboardTitle').textContent = `קבוצת ${groupName}`;
                
                // Log user details for debugging
                console.log('Group user detected:', {
                    username: result.user.username,
                    role: result.user.role,
                    access_level: result.user.access_level,
                    project_number: result.user.project_number,
                    parking_name: result.user.parking_name
                });
            } else {
                isGroup = false;
                document.getElementById('dashboardTitle').textContent = result.user.parking_name || 'חניונים';
            }
        }
    } catch (error) {
        console.error('Error loading user info:', error);
    }
}

// Load parking list
async function loadParkingList() {
    try {
        const response = await fetch('/api/user-parkings');
        const result = await response.json();
        
        if (!result.success) {
            // Handle authentication or permission errors
            if (result.message && result.message.includes('הרשאה')) {
                showError('שגיאת הרשאה: ' + result.message);
                return;
            }
        }
        
        if (result.success && result.parkings) {
            const selector = document.getElementById('parkingSelector');
            selector.innerHTML = '';
            
            // For groups, filter parkings by group name
            let parkings = result.parkings;
            if (isGroup && groupName) {
                // Filter parkings that belong to this group
                parkings = result.parkings.filter(p => 
                    p.name && p.name.toLowerCase().includes(groupName.toLowerCase())
                );
            }
            
            // Save parkings list
            userParkings = parkings;
            
            // Check if user has multiple parkings
            if (parkings.length > 1) {
                document.getElementById('parkingSelectorGroup').style.display = 'block';
                
                // Add "all parkings" option
                const allOption = document.createElement('option');
                allOption.value = '';
                allOption.textContent = isGroup ? `כל חניוני ${groupName}` : 'כל החניונים';
                selector.appendChild(allOption);
                
                // Add individual parkings
                parkings.forEach(parking => {
                    const option = document.createElement('option');
                    option.value = parking.id;
                    option.textContent = parking.name;
                    selector.appendChild(option);
                });
            } else if (parkings.length === 1) {
                // Single parking mode
                isSingleParkingMode = true;
                document.body.classList.add('single-parking-mode');
                
                // Update title with single parking name
                document.getElementById('dashboardTitle').textContent = parkings[0].name;
            } else {
                // No parkings found
                showError('לא נמצאו חניונים עבור משתמש זה');
            }
        }
    } catch (error) {
        console.error('Error loading parkings:', error);
        showError('שגיאה בטעינת רשימת החניונים');
    }
}

// Load data from API
async function loadData() {
    try {
        showLoading(true);
        hideError();
        
        // Get date range
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            throw new Error('נא לבחור טווח תאריכים');
        }
        
        // For groups, try multiple approaches
        if (isGroup) {
            await loadDataForGroup(startDate, endDate);
        } else {
            await loadDataStandard(startDate, endDate);
        }
        
    } catch (error) {
        console.error('Error loading data:', error);
        showError(error.message || 'שגיאה בטעינת הנתונים');
    } finally {
        showLoading(false);
    }
}

// Standard data loading for non-group users
async function loadDataStandard(startDate, endDate) {
    // Build API params
    const params = new URLSearchParams({
        start_date: startDate,
        end_date: endDate
    });
    
    // Add parking filter if selected
    const selectedParking = document.getElementById('parkingSelector').value;
    if (selectedParking) {
        params.append('parking_id', selectedParking);
    }
    
    // Debug: Log request details
    console.log('Standard API Request:', {
        url: `/api/parking-data?${params}`,
        params: Object.fromEntries(params)
    });
    
    // Fetch data from API
    const response = await fetch(`/api/parking-data?${params}`);
    const result = await response.json();
    
            // Debug: Log response
        console.log('API Response:', {
            status: response.status,
            statusText: response.statusText,
            success: result.success,
            message: result.message,
            dataLength: result.data ? result.data.length : 0,
            fullResult: result
        });
        
        if (!result.success) {
            console.error('API Error Details:', {
                message: result.message,
                error: result.error,
                details: result.details
            });
            throw new Error(result.message || 'שגיאה בטעינת הנתונים');
        }
    
    // Process and display data
    currentData = result.data || [];
    console.log('Loaded data:', currentData.length, 'records');
    
    updateDashboard();
}

// Special data loading for group users
async function loadDataForGroup(startDate, endDate) {
    console.log('Loading data for group:', groupName);
    
    // Try approach 1: Load without special group parameters
    try {
        // For groups, try loading data without special parameters first
        const params = new URLSearchParams({
            start_date: startDate,
            end_date: endDate
        });
        
        // Add parking filter if selected
        const selectedParking = document.getElementById('parkingSelector').value;
        if (selectedParking) {
            params.append('parking_id', selectedParking);
        }
        
        console.log('Group API Request (Approach 1 - Standard):', {
            url: `/api/parking-data?${params}`,
            params: Object.fromEntries(params)
        });
        
        const response = await fetch(`/api/parking-data?${params}`, {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        const result = await response.json();
        
        console.log('Group API Response:', {
            status: response.status,
            success: result.success,
            message: result.message,
            dataLength: result.data ? result.data.length : 0
        });
        
        // Check if we got an error about permissions
        if (!result.success && result.message && result.message.includes('רמת הרשאה')) {
            console.log('Permission error detected, will try alternative approaches');
        } else if (result.success && result.data) {
            // If we got data, filter it for the group
            if (groupName && !selectedParking) {
                currentData = result.data.filter(d => 
                    d.parking_name && d.parking_name.toLowerCase().includes(groupName.toLowerCase())
                );
                console.log(`Filtered data for group ${groupName}:`, currentData.length, 'records');
            } else {
                currentData = result.data;
                console.log('Loaded data:', currentData.length, 'records');
            }
            
            if (currentData.length > 0) {
                updateDashboard();
                return;
            }
        }
    } catch (error) {
        console.error('Group approach 1 failed:', error);
    }
    
    // Try approach 2: Load without any filters
    try {
        console.log('Trying minimal parameters approach...');
        
        // Try with minimal parameters - maybe the server doesn't like certain combinations
        const response = await fetch(`/api/parking-data?start_date=${startDate}&end_date=${endDate}`, {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        const result = await response.json();
        
        console.log('Minimal params response:', result);
        
        if (result.success && result.data && result.data.length > 0) {
            // Got data! Now filter for the group
            if (groupName) {
                const filteredData = result.data.filter(d => 
                    d.parking_name && d.parking_name.toLowerCase().includes(groupName.toLowerCase())
                );
                
                if (filteredData.length > 0) {
                    currentData = filteredData;
                    console.log(`Successfully filtered ${currentData.length} records for group ${groupName}`);
                    updateDashboard();
                    return;
                } else {
                    // No data for this group - try to use all data
                    console.log('No data found for group name, using all available data');
                    currentData = result.data;
                    updateDashboard();
                    return;
                }
            }
        }
    } catch (error) {
        console.error('Group approach 2 failed:', error);
    }
    
    // Try approach 3: Load data for each parking individually
    if (userParkings && userParkings.length > 0) {
        try {
            console.log('Trying to load data for each parking individually...');
            
            let allData = [];
            
            for (const parking of userParkings) {
                try {
                    const params = new URLSearchParams({
                        start_date: startDate,
                        end_date: endDate,
                        parking_id: parking.id
                    });
                    
                    console.log(`Loading data for parking: ${parking.name} (${parking.id})`);
                    
                    const response = await fetch(`/api/parking-data?${params}`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        allData = allData.concat(result.data);
                    }
                } catch (error) {
                    console.error(`Failed to load data for parking ${parking.name}:`, error);
                }
            }
            
            if (allData.length > 0) {
                currentData = allData;
                console.log('Loaded combined data for all parkings:', currentData.length, 'records');
                updateDashboard();
                return;
            }
        } catch (error) {
            console.error('Group approach 3 failed:', error);
        }
    }
    
    // If all approaches fail, show detailed error with alternative options
    const errorMessage = `
        <div style="text-align: center; padding: 20px;">
            <h3>בעיה בטעינת נתוני קבוצת ${groupName}</h3>
            <p>המערכת זיהתה שאתה משתמש קבוצה, אך יש בעיה זמנית בטעינת הנתונים מהשרת.</p>
            
            <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: right;">
                <h4 style="margin-bottom: 10px;">אפשרויות זמינות:</h4>
                <ol style="margin: 10px 20px;">
                    <li style="margin: 5px 0;">נסה לבחור חניון ספציפי מהרשימה למעלה</li>
                    <li style="margin: 5px 0;">השתמש בכפתור "טען מקובץ CSV" לטעינת נתונים מקובץ</li>
                    <li style="margin: 5px 0;">נסה להתחבר מחדש למערכת</li>
                </ol>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="location.reload()" style="
                    margin: 5px;
                    padding: 10px 20px;
                    background: var(--primary);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                ">רענן דף</button>
                
                <button onclick="window.location.href='/logout'" style="
                    margin: 5px;
                    padding: 10px 20px;
                    background: #6C6C70;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                ">התחבר מחדש</button>
                
                <button onclick="tryLoadWithoutGroup()" style="
                    margin: 5px;
                    padding: 10px 20px;
                    background: #34C759;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                ">נסה ללא סינון קבוצה</button>
            </div>
            
            <p style="margin-top: 20px; font-size: 12px; color: #999;">
                קוד שגיאה: GROUP_ACCESS_ERROR | תאריך: ${new Date().toLocaleString('he-IL')}
            </p>
        </div>
    `;
    throw new Error(errorMessage);
}

// Update dashboard with current data
function updateDashboard() {
    if (currentData.length === 0) {
        showError('לא נמצאו נתונים לתקופה המבוקשת');
        return;
    }
    
    // Check if single parking mode
    const uniqueParkings = [...new Set(currentData.map(d => d.parking_name))];
    isSingleParkingMode = uniqueParkings.length === 1;
    
    if (isSingleParkingMode) {
        document.body.classList.add('single-parking-mode');
    } else {
        document.body.classList.remove('single-parking-mode');
    }
    
    // Update all components
    updateStats();
    updateCharts();
    updateAlerts();
    
    // Show dashboard content
    document.getElementById('dashboardContent').style.display = 'block';
}

// Update statistics cards
function updateStats() {
    const stats = calculateStats();
    
    const statsHTML = `
        <div class="stat-card" data-stat-type="revenue">
            <div class="icon">💰</div>
            <h3>סה"כ הכנסות</h3>
            <div class="value">
                ₪${stats.totalRevenue.toLocaleString()}
            </div>
            <div class="subtext">מכל אמצעי התשלום</div>
        </div>
        
        <div class="stat-card" data-stat-type="entries">
            <div class="icon">🚗</div>
            <h3>סה"כ כניסות</h3>
            <div class="value">
                ${stats.totalEntries.toLocaleString()}
            </div>
            <div class="subtext">${stats.dailyAvgEntries.toLocaleString()} בממוצע ליום</div>
        </div>
        
        <div class="stat-card" data-stat-type="casual">
            <div class="icon">👤</div>
            <h3>מזדמנים</h3>
            <div class="value">
                ${stats.totalCasual.toLocaleString()}
            </div>
            <div class="subtext">${stats.casualPercent.toFixed(1)}% מהכניסות</div>
        </div>
        
        <div class="stat-card" data-stat-type="members">
            <div class="icon">⭐</div>
            <h3>מנויים</h3>
            <div class="value">
                ${stats.totalMembers.toLocaleString()}
            </div>
            <div class="subtext">${stats.memberPercent.toFixed(1)}% מהכניסות</div>
        </div>
        
        ${stats.totalApp > 0 ? `
        <div class="stat-card" data-stat-type="app">
            <div class="icon">📱</div>
            <h3>אפליקציה</h3>
            <div class="value">
                ${stats.totalApp.toLocaleString()}
            </div>
            <div class="subtext">${stats.appPercent.toFixed(1)}% מהכניסות</div>
        </div>
        ` : ''}
        
        <div class="stat-card" data-stat-type="barriers" ${isGroup && !isSingleParkingMode ? 'style="cursor: pointer;"' : ''}>
            <div class="icon">🚧</div>
            <h3>פתיחות מחסום</h3>
            <div class="value">
                ${stats.totalBarrier.toLocaleString()}
            </div>
            <div class="subtext">${stats.barrierPercent.toFixed(1)}% מהכניסות</div>
        </div>
        
        <div class="stat-card" data-stat-type="cash">
            <div class="icon">💵</div>
            <h3>מזומן</h3>
            <div class="value">
                ₪${stats.totalCash.toLocaleString()}
            </div>
            <div class="subtext">${stats.cashPercent.toFixed(1)}% מההכנסות</div>
        </div>
        
        <div class="stat-card" data-stat-type="credit">
            <div class="icon">💳</div>
            <h3>אשראי</h3>
            <div class="value">
                ₪${stats.totalCredit.toLocaleString()}
            </div>
            <div class="subtext">${stats.creditPercent.toFixed(1)}% מההכנסות</div>
        </div>
        
        <div class="stat-card" data-stat-type="pango">
            <div class="icon">📲</div>
            <h3>פנגו</h3>
            <div class="value">
                ₪${stats.totalPango.toLocaleString()}
            </div>
            <div class="subtext">${stats.pangoPercent.toFixed(1)}% מההכנסות</div>
        </div>
        
        <div class="stat-card" data-stat-type="cello">
            <div class="icon">📞</div>
            <h3>סלו</h3>
            <div class="value">
                ₪${stats.totalCello.toLocaleString()}
            </div>
            <div class="subtext">${stats.celloPercent.toFixed(1)}% מההכנסות</div>
        </div>
        
        <div class="stat-card" data-stat-type="avg-revenue">
            <div class="icon">📊</div>
            <h3>ממוצע יומי</h3>
            <div class="value">
                ₪${stats.dailyAvgRevenue.toLocaleString()}
            </div>
            <div class="subtext">הכנסה יומית ממוצעת</div>
        </div>
        
        ${!isSingleParkingMode ? `
        <div class="stat-card multi-parking-only" data-stat-type="parkings">
            <div class="icon">🏢</div>
            <h3>חניונים פעילים</h3>
            <div class="value">
                ${stats.uniqueParkings}
            </div>
            <div class="subtext">מתוך רשת החניונים</div>
        </div>
        ` : ''}
    `;
    
    document.getElementById('statsGrid').innerHTML = statsHTML;
    
    // Add hover functionality for group users
    if (isGroup && !isSingleParkingMode) {
        setupStatCardHovers();
    }
}

// Calculate statistics
function calculateStats() {
    const totalRevenue = currentData.reduce((sum, d) => sum + (d.total_revenue_shekels || 0), 0);
    const totalCash = currentData.reduce((sum, d) => sum + (d.s_cash_shekels || 0), 0);
    const totalCredit = currentData.reduce((sum, d) => sum + (d.s_credit_shekels || 0), 0);
    const totalPango = currentData.reduce((sum, d) => sum + (d.s_pango_shekels || 0), 0);
    const totalCello = currentData.reduce((sum, d) => sum + (d.s_celo_shekels || 0), 0);
    
    const totalEntries = currentData.reduce((sum, d) => sum + (d.t_entry_tot || 0), 0);
    const totalCasual = currentData.reduce((sum, d) => sum + (d.t_entry_s || 0), 0);
    const totalMembers = currentData.reduce((sum, d) => sum + (d.t_entry_p || 0), 0);
    const totalApp = currentData.reduce((sum, d) => sum + (d.t_entry_ap || 0), 0);
    
    const totalBarrier = currentData.reduce((sum, d) => sum + (d.t_open_b || 0), 0);
    
    const uniqueDays = [...new Set(currentData.map(d => d.report_date))].length;
    const uniqueParkings = [...new Set(currentData.map(d => d.parking_name))].length;
    
    return {
        totalRevenue,
        totalCash,
        totalCredit,
        totalPango,
        totalCello,
        totalEntries,
        totalCasual,
        totalMembers,
        totalApp,
        totalBarrier,
        uniqueDays,
        uniqueParkings,
        
        // Percentages
        cashPercent: totalRevenue > 0 ? (totalCash / totalRevenue) * 100 : 0,
        creditPercent: totalRevenue > 0 ? (totalCredit / totalRevenue) * 100 : 0,
        pangoPercent: totalRevenue > 0 ? (totalPango / totalRevenue) * 100 : 0,
        celloPercent: totalRevenue > 0 ? (totalCello / totalRevenue) * 100 : 0,
        
        casualPercent: totalEntries > 0 ? (totalCasual / totalEntries) * 100 : 0,
        memberPercent: totalEntries > 0 ? (totalMembers / totalEntries) * 100 : 0,
        appPercent: totalEntries > 0 ? (totalApp / totalEntries) * 100 : 0,
        
        barrierPercent: totalEntries > 0 ? (totalBarrier / totalEntries) * 100 : 0,
        
        // Averages
        dailyAvgRevenue: uniqueDays > 0 ? Math.round(totalRevenue / uniqueDays) : 0,
        dailyAvgEntries: uniqueDays > 0 ? Math.round(totalEntries / uniqueDays) : 0,
    };
}

// Update all charts
function updateCharts() {
    createRevenueChart();
    createPaymentChart();
    createEntriesChart();
    createDailyChart();
    createStayDurationChart();
    createBarrierChart();
    updateEncodersInfo();
    
    if (!isSingleParkingMode) {
        createParkingComparisonChart();
        updateParkingRanking();
    }
}

// Create revenue trends chart
function createRevenueChart() {
    const ctx = document.getElementById('revenueChart').getContext('2d');
    
    // Aggregate data by date
    const dailyData = {};
    currentData.forEach(d => {
        if (!dailyData[d.report_date]) {
            dailyData[d.report_date] = { revenue: 0, entries: 0 };
        }
        dailyData[d.report_date].revenue += d.total_revenue_shekels || 0;
        dailyData[d.report_date].entries += d.t_entry_tot || 0;
    });
    
    const dates = Object.keys(dailyData).sort();
    const revenues = dates.map(date => dailyData[date].revenue);
    const entries = dates.map(date => dailyData[date].entries);
    
    if (charts.revenue) charts.revenue.destroy();
    
    charts.revenue = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'הכנסות',
                data: revenues,
                borderColor: '#007AFF',
                backgroundColor: 'rgba(0, 122, 255, 0.1)',
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                yAxisID: 'y'
            }, {
                label: 'כניסות',
                data: entries,
                borderColor: '#5AC8FA',
                backgroundColor: 'rgba(90, 200, 250, 0.1)',
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            if (context.datasetIndex === 0) {
                                return `הכנסות: ₪${context.parsed.y.toLocaleString()}`;
                            } else {
                                return `כניסות: ${context.parsed.y.toLocaleString()}`;
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '₪' + value.toLocaleString();
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: {
                        display: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Create payment methods chart
function createPaymentChart() {
    const ctx = document.getElementById('paymentChart').getContext('2d');
    
    const totalCash = currentData.reduce((sum, d) => sum + (d.s_cash_shekels || 0), 0);
    const totalCredit = currentData.reduce((sum, d) => sum + (d.s_credit_shekels || 0), 0);
    const totalPango = currentData.reduce((sum, d) => sum + (d.s_pango_shekels || 0), 0);
    const totalCello = currentData.reduce((sum, d) => sum + (d.s_celo_shekels || 0), 0);
    
    if (charts.payment) charts.payment.destroy();
    
    charts.payment = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['מזומן', 'אשראי', 'פנגו', 'סלו'],
            datasets: [{
                data: [totalCash, totalCredit, totalPango, totalCello],
                backgroundColor: [
                    '#007AFF',
                    '#5AC8FA',
                    '#AF52DE',
                    '#FF9500'
                ],
                borderWidth: 3,
                borderColor: '#FFFFFF'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return {
                                        text: `${label}: ₪${Math.round(value).toLocaleString()} (${percentage}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: '#fff',
                                        lineWidth: 2,
                                        hidden: isNaN(value),
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ₪${Math.round(context.parsed).toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Create entries chart
function createEntriesChart() {
    const ctx = document.getElementById('entriesChart').getContext('2d');
    
    const totalCasual = currentData.reduce((sum, d) => sum + (d.t_entry_s || 0), 0);
    const totalMembers = currentData.reduce((sum, d) => sum + (d.t_entry_p || 0), 0);
    const totalApp = currentData.reduce((sum, d) => sum + (d.t_entry_ap || 0), 0);
    
    const chartData = {
        labels: ['מזדמנים', 'מנויים'],
        datasets: [{
            data: [totalCasual, totalMembers],
            backgroundColor: ['#34C759', '#007AFF'],
            borderWidth: 3,
            borderColor: '#FFFFFF'
        }]
    };
    
    if (totalApp > 0) {
        chartData.labels.push('אפליקציה');
        chartData.datasets[0].data.push(totalApp);
        chartData.datasets[0].backgroundColor.push('#AF52DE');
    }
    
    if (charts.entries) charts.entries.destroy();
    
    charts.entries = new Chart(ctx, {
        type: 'pie',
        data: chartData,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return {
                                        text: `${label}: ${value.toLocaleString()} (${percentage}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: '#fff',
                                        lineWidth: 2,
                                        hidden: isNaN(value),
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                }
            }
        }
    });
}

// Create daily comparison chart
function createDailyChart() {
    const ctx = document.getElementById('dailyChart').getContext('2d');
    
    const weekdays = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
    const weeklyData = {};
    
    weekdays.forEach(day => {
        weeklyData[day] = { revenue: 0, entries: 0, count: 0 };
    });
    
    currentData.forEach(d => {
        const date = new Date(d.report_date);
        const dayName = weekdays[date.getDay()];
        if (weeklyData[dayName]) {
            weeklyData[dayName].revenue += d.total_revenue_shekels || 0;
            weeklyData[dayName].entries += d.t_entry_tot || 0;
            weeklyData[dayName].count++;
        }
    });
    
    const avgRevenues = weekdays.map(day => 
        weeklyData[day].count > 0 ? weeklyData[day].revenue / weeklyData[day].count : 0
    );
    
    const avgEntries = weekdays.map(day => 
        weeklyData[day].count > 0 ? weeklyData[day].entries / weeklyData[day].count : 0
    );
    
    if (charts.daily) charts.daily.destroy();
    
    charts.daily = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: weekdays,
            datasets: [{
                label: 'ממוצע הכנסות',
                data: avgRevenues,
                backgroundColor: '#007AFF',
                borderRadius: 8,
                yAxisID: 'y'
            }, {
                label: 'ממוצע כניסות',
                data: avgEntries,
                backgroundColor: '#5AC8FA',
                borderRadius: 8,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            if (context.datasetIndex === 0) {
                                return `הכנסות: ₪${Math.round(context.parsed.y).toLocaleString()}`;
                            } else {
                                return `כניסות: ${Math.round(context.parsed.y).toLocaleString()}`;
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '₪' + value.toLocaleString();
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: {
                        display: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Create stay duration chart
function createStayDurationChart() {
    const ctx = document.getElementById('stayDurationChart').getContext('2d');
    
    // Calculate totals for each duration category
    const durations = {
        '0-15 דקות': currentData.reduce((sum, d) => sum + (d.stay_015 || 0), 0),
        '15-30 דקות': currentData.reduce((sum, d) => sum + (d.stay_030 || 0), 0),
        '30-45 דקות': currentData.reduce((sum, d) => sum + (d.stay_045 || 0), 0),
        '45-60 דקות': currentData.reduce((sum, d) => sum + (d.stay_060 || 0), 0),
        'עד 2 שעות': currentData.reduce((sum, d) => sum + (d.stay_2 || 0), 0),
        'עד 3 שעות': currentData.reduce((sum, d) => sum + (d.stay_3 || 0), 0),
        'עד 4 שעות': currentData.reduce((sum, d) => sum + (d.stay_4 || 0), 0),
        'עד 5 שעות': currentData.reduce((sum, d) => sum + (d.stay_5 || 0), 0),
        'עד 6 שעות': currentData.reduce((sum, d) => sum + (d.stay_6 || 0), 0),
        '7-24 שעות': currentData.reduce((sum, d) => sum + (d.stay_724 || 0), 0),
    };
    
    const labels = Object.keys(durations);
    const values = Object.values(durations);
    
    // Create gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, '#007AFF');
    gradient.addColorStop(1, '#5AC8FA');
    
    if (charts.stayDuration) charts.stayDuration.destroy();
    
    charts.stayDuration = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'מספר רכבים',
                data: values,
                backgroundColor: gradient,
                borderRadius: 8,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            const total = values.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((context.parsed.y / total) * 100).toFixed(1) : 0;
                            return `${context.parsed.y.toLocaleString()} רכבים (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Create barrier chart
function createBarrierChart() {
    const ctx = document.getElementById('barrierChart').getContext('2d');
    
    // Aggregate barrier data by date
    const dailyBarrier = {};
    currentData.forEach(d => {
        if (!dailyBarrier[d.report_date]) {
            dailyBarrier[d.report_date] = 0;
        }
        dailyBarrier[d.report_date] += d.t_open_b || 0;
    });
    
    const dates = Object.keys(dailyBarrier).sort();
    const barriers = dates.map(date => dailyBarrier[date]);
    
    if (charts.barrier) charts.barrier.destroy();
    
    charts.barrier = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'פתיחות מחסום',
                data: barriers,
                borderColor: '#FF3B30',
                backgroundColor: 'rgba(255, 59, 48, 0.1)',
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Create parking comparison chart
function createParkingComparisonChart() {
    const ctx = document.getElementById('parkingComparisonChart').getContext('2d');
    
    // Aggregate data by parking
    const parkingData = {};
    currentData.forEach(d => {
        if (!parkingData[d.parking_name]) {
            parkingData[d.parking_name] = { 
                revenue: 0, 
                entries: 0,
                cash: 0,
                credit: 0,
                pango: 0,
                cello: 0,
                barriers: 0,
                casual: 0,
                members: 0,
                app: 0,
                // Add stay duration totals
                stay015: 0,
                stay030: 0,
                stay045: 0,
                stay060: 0,
                stay2: 0,
                stay3: 0,
                stay4: 0,
                stay5: 0,
                stay6: 0,
                stay724: 0,
                totalStays: 0
            };
        }
        parkingData[d.parking_name].revenue += d.total_revenue_shekels || 0;
        parkingData[d.parking_name].entries += d.t_entry_tot || 0;
        parkingData[d.parking_name].cash += d.s_cash || 0;
        parkingData[d.parking_name].credit += d.s_credit || 0;
        parkingData[d.parking_name].pango += d.s_pango || 0;
        parkingData[d.parking_name].cello += d.s_cello || 0;
        parkingData[d.parking_name].barriers += d.t_open_b || 0;
        parkingData[d.parking_name].casual += d.t_entry_s || 0;
        parkingData[d.parking_name].members += d.t_entry_p || 0;
        parkingData[d.parking_name].app += d.t_entry_app || 0;
        // Add stay duration data
        parkingData[d.parking_name].stay015 += d.stay_015 || 0;
        parkingData[d.parking_name].stay030 += d.stay_030 || 0;
        parkingData[d.parking_name].stay045 += d.stay_045 || 0;
        parkingData[d.parking_name].stay060 += d.stay_060 || 0;
        parkingData[d.parking_name].stay2 += d.stay_2 || 0;
        parkingData[d.parking_name].stay3 += d.stay_3 || 0;
        parkingData[d.parking_name].stay4 += d.stay_4 || 0;
        parkingData[d.parking_name].stay5 += d.stay_5 || 0;
        parkingData[d.parking_name].stay6 += d.stay_6 || 0;
        parkingData[d.parking_name].stay724 += d.stay_724 || 0;
        // Calculate total stays - accumulate correctly
        parkingData[d.parking_name].totalStays += (d.stay_015 || 0) + (d.stay_030 || 0) + (d.stay_045 || 0) + 
            (d.stay_060 || 0) + (d.stay_2 || 0) + (d.stay_3 || 0) + (d.stay_4 || 0) + 
            (d.stay_5 || 0) + (d.stay_6 || 0) + (d.stay_724 || 0);
    });
    
    // Sort by revenue
    const sortedParkings = Object.entries(parkingData)
        .sort((a, b) => b[1].revenue - a[1].revenue)
        .slice(0, 10); // Top 10
    
    const labels = sortedParkings.map(([name]) => name);
    const revenues = sortedParkings.map(([, data]) => data.revenue);
    const entries = sortedParkings.map(([, data]) => data.entries);
    
    if (charts.parkingComparison) charts.parkingComparison.destroy();
    
    charts.parkingComparison = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'הכנסות',
                data: revenues,
                backgroundColor: '#007AFF',
                borderRadius: 8,
                yAxisID: 'y'
            }, {
                label: 'כניסות',
                data: entries,
                backgroundColor: '#5AC8FA',
                borderRadius: 8,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            onClick: (event, elements) => {
                // Handle click only for group users
                if (isGroup && elements.length > 0) {
                    const index = elements[0].index;
                    const parkingName = labels[index];
                    const data = sortedParkings[index][1];
                    showParkingDetails(parkingName, data);
                }
            },
            onHover: (event, elements) => {
                // Change cursor on hover for group users
                if (isGroup) {
                    ctx.canvas.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                    callbacks: {
                        afterLabel: function(context) {
                            if (isGroup) {
                                return 'לחץ לפירוט מלא';
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '₪' + value.toLocaleString();
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: {
                        display: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
}

// Update parking ranking
function updateParkingRanking() {
    // Calculate metrics for each parking
    const parkingMetrics = {};
    
    currentData.forEach(d => {
        if (!parkingMetrics[d.parking_name]) {
            parkingMetrics[d.parking_name] = {
                name: d.parking_name,
                revenue: 0,
                entries: 0,
                days: new Set()
            };
        }
        parkingMetrics[d.parking_name].revenue += d.total_revenue_shekels || 0;
        parkingMetrics[d.parking_name].entries += d.t_entry_tot || 0;
        parkingMetrics[d.parking_name].days.add(d.report_date);
    });
    
    // Calculate averages and sort
    const rankings = Object.values(parkingMetrics).map(parking => ({
        name: parking.name,
        totalRevenue: parking.revenue,
        totalEntries: parking.entries,
        avgDailyRevenue: parking.revenue / parking.days.size,
        avgDailyEntries: parking.entries / parking.days.size,
        activeDays: parking.days.size
    })).sort((a, b) => b.totalRevenue - a.totalRevenue);
    
    // Create ranking HTML
    let rankingHTML = '';
    rankings.forEach((parking, index) => {
        const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
        
        rankingHTML += `
            <div class="ranking-item" style="
                display: flex;
                align-items: center;
                padding: 20px;
                margin-bottom: 12px;
                background: ${index < 3 ? 'linear-gradient(135deg, rgba(0, 122, 255, 0.05) 0%, rgba(90, 200, 250, 0.05) 100%)' : 'var(--background)'};
                border-radius: 12px;
                transition: all 0.3s ease;
            ">
                <div style="
                    font-size: 24px;
                    font-weight: 700;
                    margin-left: 20px;
                    min-width: 40px;
                ">
                    ${medal}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 18px; margin-bottom: 8px;">
                        ${parking.name}
                    </div>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; color: var(--text-secondary); font-size: 14px;">
                        <span>הכנסות: ₪${parking.totalRevenue.toLocaleString()}</span>
                        <span>כניסות: ${parking.totalEntries.toLocaleString()}</span>
                        <span>ממוצע יומי: ₪${Math.round(parking.avgDailyRevenue).toLocaleString()}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('parkingRanking').innerHTML = rankingHTML;
}

// Update encoders info
function updateEncodersInfo() {
    const totalEncoder1 = currentData.reduce((sum, d) => sum + (d.s_encoder1 || 0), 0);
    const totalEncoder2 = currentData.reduce((sum, d) => sum + (d.s_encoder2 || 0), 0);
    const totalEncoder3 = currentData.reduce((sum, d) => sum + (d.s_encoder3 || 0), 0);
    const totalEncoders = currentData.reduce((sum, d) => sum + (d.sencodertot || 0), 0);
    
    const encodersHTML = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            <div style="
                background: var(--background);
                padding: 24px;
                border-radius: 12px;
                text-align: center;
            ">
                <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">
                    מקודד 1
                </div>
                <div style="font-size: 28px; font-weight: 700; color: var(--primary);">
                    ${totalEncoder1.toLocaleString()}
                </div>
            </div>
            
            <div style="
                background: var(--background);
                padding: 24px;
                border-radius: 12px;
                text-align: center;
            ">
                <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">
                    מקודד 2
                </div>
                <div style="font-size: 28px; font-weight: 700; color: var(--primary);">
                    ${totalEncoder2.toLocaleString()}
                </div>
            </div>
            
            <div style="
                background: var(--background);
                padding: 24px;
                border-radius: 12px;
                text-align: center;
            ">
                <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">
                    מקודד 3
                </div>
                <div style="font-size: 28px; font-weight: 700; color: var(--primary);">
                    ${totalEncoder3.toLocaleString()}
                </div>
            </div>
            
            <div style="
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
                padding: 24px;
                border-radius: 12px;
                text-align: center;
            ">
                <div style="color: white; font-size: 14px; margin-bottom: 8px;">
                    סה"כ מקודדים
                </div>
                <div style="font-size: 28px; font-weight: 700; color: white;">
                    ${totalEncoders.toLocaleString()}
                </div>
            </div>
        </div>
        
        <div style="
            margin-top: 20px;
            padding: 16px;
            background: rgba(255, 159, 64, 0.1);
            border-radius: 12px;
            color: var(--warning);
            font-size: 14px;
            text-align: center;
        ">
            <strong>שים לב:</strong> נתוני המקודדים מוצגים לצפייה בלבד ואינם נכללים בסיכומים
        </div>
    `;
    
    document.getElementById('encodersInfo').innerHTML = encodersHTML;
}

// Update alerts
function updateAlerts() {
    const alerts = [];
    
    // Find significant changes
    const recentDays = 7;
    const dates = [...new Set(currentData.map(d => d.report_date))].sort().slice(-recentDays);
    
    if (dates.length >= 2) {
        const lastDate = dates[dates.length - 1];
        const prevDate = dates[dates.length - 2];
        
        const lastData = currentData.filter(d => d.report_date === lastDate);
        const prevData = currentData.filter(d => d.report_date === prevDate);
        
        const lastRevenue = lastData.reduce((sum, d) => sum + (d.total_revenue_shekels || 0), 0);
        const prevRevenue = prevData.reduce((sum, d) => sum + (d.total_revenue_shekels || 0), 0);
        
        const revenueChange = prevRevenue > 0 ? ((lastRevenue - prevRevenue) / prevRevenue) * 100 : 0;
        
        if (Math.abs(revenueChange) > 10) {
            alerts.push({
                type: revenueChange > 0 ? 'positive' : 'negative',
                icon: revenueChange > 0 ? '📈' : '📉',
                title: `שינוי של ${Math.abs(revenueChange).toFixed(1)}% בהכנסות`,
                description: `ביום ${lastDate} לעומת ${prevDate}`
            });
        }
    }
    
    // Check weekend performance
    const weekendData = currentData.filter(d => {
        const date = new Date(d.report_date);
        const day = date.getDay();
        return day === 5 || day === 6; // Friday or Saturday
    });
    
    const weekdayData = currentData.filter(d => {
        const date = new Date(d.report_date);
        const day = date.getDay();
        return day !== 5 && day !== 6;
    });
    
    if (weekendData.length > 0 && weekdayData.length > 0) {
        const avgWeekendRevenue = weekendData.reduce((sum, d) => sum + (d.total_revenue_shekels || 0), 0) / weekendData.length;
        const avgWeekdayRevenue = weekdayData.reduce((sum, d) => sum + (d.total_revenue_shekels || 0), 0) / weekdayData.length;
        
        const weekendDiff = avgWeekdayRevenue > 0 ? ((avgWeekendRevenue - avgWeekdayRevenue) / avgWeekdayRevenue) * 100 : 0;
        
        if (Math.abs(weekendDiff) > 20) {
            alerts.push({
                type: weekendDiff > 0 ? 'positive' : 'negative',
                icon: '📅',
                title: `סופי שבוע ${weekendDiff > 0 ? 'חזקים' : 'חלשים'} ב-${Math.abs(weekendDiff).toFixed(1)}%`,
                description: 'בהשוואה לימי חול'
            });
        }
    }
    
    // Show alerts
    if (alerts.length > 0) {
        document.getElementById('alertsSection').style.display = 'block';
        
        const alertsHTML = alerts.map(alert => `
            <div class="alert-item ${alert.type}">
                <div class="alert-icon">${alert.icon}</div>
                <div class="alert-content">
                    <div class="alert-title">${alert.title}</div>
                    <div class="alert-description">${alert.description}</div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('alertsContainer').innerHTML = alertsHTML;
    } else {
        document.getElementById('alertsSection').style.display = 'none';
    }
}

// Set quick date range
function setQuickRange(range) {
    const today = new Date();
    let startDate, endDate;
    
    switch(range) {
        case 'yesterday':
            startDate = endDate = new Date(today);
            startDate.setDate(startDate.getDate() - 1);
            break;
        case 'week':
            endDate = today;
            startDate = new Date(today);
            startDate.setDate(startDate.getDate() - today.getDay());
            break;
        case 'lastWeek':
            endDate = new Date(today);
            endDate.setDate(endDate.getDate() - today.getDay() - 1);
            startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 6);
            break;
        case 'month':
            endDate = today;
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            break;
        case 'lastMonth':
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            break;
        case 'year':
            endDate = today;
            startDate = new Date(today.getFullYear(), 0, 1);
            break;
    }
    
    document.getElementById('startDate').value = formatDateForInput(startDate);
    document.getElementById('endDate').value = formatDateForInput(endDate);
    
    // Auto load data
    loadData();
}

// Show loading state
function showLoading(show) {
    document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

// Show error message
function showError(message) {
    const errorTextElement = document.getElementById('errorText');
    
    // Check if message contains HTML
    if (message.includes('<') && message.includes('>')) {
        errorTextElement.innerHTML = message;
    } else {
        errorTextElement.textContent = message;
    }
    
    document.getElementById('errorMessage').style.display = 'block';
}

// Hide error message
function hideError() {
    document.getElementById('errorMessage').style.display = 'none';
}

// Logout function
function logout() {
    if (confirm('האם אתה בטוח שברצונך לצאת?')) {
        window.location.href = '/logout';
    }
}

// Try to load data without group filtering
async function tryLoadWithoutGroup() {
    try {
        showLoading(true);
        hideError();
        
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            throw new Error('נא לבחור טווח תאריכים');
        }
        
        console.log('Trying to load without group filtering...');
        
        // Temporarily disable group mode
        const originalIsGroup = isGroup;
        isGroup = false;
        
        await loadDataStandard(startDate, endDate);
        
        // Restore group mode
        isGroup = originalIsGroup;
        
    } catch (error) {
        console.error('Error loading data without group:', error);
        showError(error.message || 'שגיאה בטעינת הנתונים');
    } finally {
        showLoading(false);
    }
}

// Show parking details (for group users)
function showParkingDetails(parkingName, data) {
    // Update title
    document.getElementById('parkingDetailsTitle').textContent = `פירוט נתונים - ${parkingName}`;
    
    // Create payment chart
    const paymentCanvas = document.createElement('canvas');
    paymentCanvas.id = 'parkingPaymentChart';
    paymentCanvas.style.maxHeight = '300px';
    
    // Create entries chart
    const entriesCanvas = document.createElement('canvas');
    entriesCanvas.id = 'parkingEntriesChart';
    entriesCanvas.style.maxHeight = '300px';
    
    // Build content HTML
    const contentHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <!-- Revenue Card -->
            <div style="
                background: linear-gradient(135deg, #007AFF 0%, #5AC8FA 100%);
                padding: 24px;
                border-radius: 12px;
                color: white;
            ">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">סה"כ הכנסות</div>
                <div style="font-size: 32px; font-weight: 700;">₪${data.revenue.toLocaleString()}</div>
            </div>
            
            <!-- Entries Card -->
            <div style="
                background: linear-gradient(135deg, #34C759 0%, #30D158 100%);
                padding: 24px;
                border-radius: 12px;
                color: white;
            ">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">סה"כ כניסות</div>
                <div style="font-size: 32px; font-weight: 700;">${data.entries.toLocaleString()}</div>
            </div>
            
            <!-- Barriers Card -->
            <div style="
                background: linear-gradient(135deg, #FF3B30 0%, #FF6961 100%);
                padding: 24px;
                border-radius: 12px;
                color: white;
            ">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">פתיחות מחסום</div>
                <div style="font-size: 32px; font-weight: 700;">${data.barriers.toLocaleString()}</div>
            </div>
        </div>
        
        <!-- Charts Section -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
            <!-- Payment Breakdown -->
            <div>
                <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">התפלגות תשלומים</h4>
                <div id="paymentChartContainer"></div>
                
                <!-- Payment Details -->
                <div style="margin-top: 20px; padding: 20px; background: var(--background); border-radius: 12px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 14px;">מזומן</div>
                            <div style="font-weight: 600; font-size: 18px;">₪${data.cash.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 14px;">אשראי</div>
                            <div style="font-weight: 600; font-size: 18px;">₪${data.credit.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 14px;">פנגו</div>
                            <div style="font-weight: 600; font-size: 18px;">₪${data.pango.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 14px;">סלו</div>
                            <div style="font-weight: 600; font-size: 18px;">₪${data.cello.toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Entries Breakdown -->
            <div>
                <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">התפלגות כניסות</h4>
                <div id="entriesChartContainer"></div>
                
                <!-- Entries Details -->
                <div style="margin-top: 20px; padding: 20px; background: var(--background); border-radius: 12px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 14px;">מזדמנים</div>
                            <div style="font-weight: 600; font-size: 18px;">${data.casual.toLocaleString()}</div>
                            <div style="color: var(--text-secondary); font-size: 12px;">${data.entries > 0 ? ((data.casual/data.entries)*100).toFixed(1) : 0}%</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 14px;">מנויים</div>
                            <div style="font-weight: 600; font-size: 18px;">${data.members.toLocaleString()}</div>
                            <div style="color: var(--text-secondary); font-size: 12px;">${data.entries > 0 ? ((data.members/data.entries)*100).toFixed(1) : 0}%</div>
                        </div>
                        ${data.app > 0 ? `
                        <div>
                            <div style="color: var(--text-secondary); font-size: 14px;">אפליקציה</div>
                            <div style="font-weight: 600; font-size: 18px;">${data.app.toLocaleString()}</div>
                            <div style="color: var(--text-secondary); font-size: 12px;">${data.entries > 0 ? ((data.app/data.entries)*100).toFixed(1) : 0}%</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Daily Trend -->
        <div style="margin-top: 30px;">
            <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">מגמת הכנסות יומיות - ${parkingName}</h4>
            <canvas id="parkingTrendChart" style="max-height: 250px;"></canvas>
        </div>
        
        <!-- Stay Duration Details -->
        <div style="margin-top: 30px;">
            <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">התפלגות זמני שהייה - ${parkingName}</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                ${data.stay015 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">0-15 דקות</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay015.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay015/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
                ${data.stay030 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">15-30 דקות</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay030.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay030/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
                ${data.stay045 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">30-45 דקות</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay045.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay045/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
                ${data.stay060 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">45-60 דקות</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay060.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay060/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
                ${data.stay2 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">עד 2 שעות</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay2.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay2/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
                ${data.stay3 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">עד 3 שעות</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay3.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay3/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
                ${data.stay4 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">עד 4 שעות</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay4.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay4/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
                ${data.stay5 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">עד 5 שעות</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay5.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay5/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
                ${data.stay6 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">עד 6 שעות</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay6.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay6/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
                ${data.stay724 > 0 ? `<div style="padding: 15px; background: var(--background); border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">7-24 שעות</div>
                    <div style="font-weight: 600; font-size: 20px; color: var(--primary);">${data.stay724.toLocaleString()}</div>
                    <div style="color: var(--text-secondary); font-size: 11px;">${data.totalStays > 0 ? ((data.stay724/data.totalStays)*100).toFixed(1) : 0}%</div>
                </div>` : ''}
            </div>
            <div style="margin-top: 15px; padding: 15px; background: rgba(0, 122, 255, 0.1); border-radius: 8px; text-align: center;">
                <div style="color: var(--primary); font-size: 14px;">סה"כ רכבים שחנו</div>
                <div style="font-weight: 700; font-size: 24px; color: var(--primary);">${data.totalStays.toLocaleString()}</div>
            </div>
        </div>
    `;
    
    // Update content
    document.getElementById('parkingDetailsContent').innerHTML = contentHTML;
    
    // Add charts to containers
    document.getElementById('paymentChartContainer').appendChild(paymentCanvas);
    document.getElementById('entriesChartContainer').appendChild(entriesCanvas);
    
    // Show section
    document.getElementById('parkingDetailsSection').style.display = 'block';
    
    // Scroll to details
    document.getElementById('parkingDetailsSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    // Create charts
    createParkingPaymentChart(data);
    createParkingEntriesChart(data);
    createParkingTrendChart(parkingName);
}

// Create parking payment chart
function createParkingPaymentChart(data) {
    const ctx = document.getElementById('parkingPaymentChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['מזומן', 'אשראי', 'פנגו', 'סלו'],
            datasets: [{
                data: [data.cash, data.credit, data.pango, data.cello],
                backgroundColor: [
                    '#007AFF',
                    '#FF9500',
                    '#5AC8FA',
                    '#AF52DE'
                ],
                borderWidth: 3,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return {
                                        text: `${label}: ${percentage}%`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: '#fff',
                                        lineWidth: 3,
                                        hidden: isNaN(value) || chart.getDatasetMeta(0).data[i].hidden,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                }
            }
        }
    });
}

// Create parking entries chart
function createParkingEntriesChart(data) {
    const ctx = document.getElementById('parkingEntriesChart').getContext('2d');
    
    const labels = ['מזדמנים', 'מנויים'];
    const values = [data.casual, data.members];
    const colors = ['#34C759', '#007AFF'];
    
    if (data.app > 0) {
        labels.push('אפליקציה');
        values.push(data.app);
        colors.push('#FF9500');
    }
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors,
                borderWidth: 3,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return {
                                        text: `${label}: ${percentage}%`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: '#fff',
                                        lineWidth: 3,
                                        hidden: isNaN(value) || chart.getDatasetMeta(0).data[i].hidden,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                }
            }
        }
    });
}

// Create parking trend chart
function createParkingTrendChart(parkingName) {
    const ctx = document.getElementById('parkingTrendChart').getContext('2d');
    
    // Filter data for this parking
    const parkingData = currentData.filter(d => d.parking_name === parkingName);
    
    // Aggregate by date
    const dailyData = {};
    parkingData.forEach(d => {
        if (!dailyData[d.report_date]) {
            dailyData[d.report_date] = 0;
        }
        dailyData[d.report_date] += d.total_revenue_shekels || 0;
    });
    
    const dates = Object.keys(dailyData).sort();
    const revenues = dates.map(date => dailyData[date]);
    
    // Create gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, 200);
    gradient.addColorStop(0, 'rgba(0, 122, 255, 0.5)');
    gradient.addColorStop(1, 'rgba(0, 122, 255, 0)');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'הכנסות יומיות',
                data: revenues,
                borderColor: '#007AFF',
                backgroundColor: gradient,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#000',
                    bodyColor: '#6C6C70',
                    borderColor: '#E5E5EA',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return `הכנסות: ₪${context.parsed.y.toLocaleString()}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '₪' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Close parking details
function closeParkingDetails() {
    document.getElementById('parkingDetailsSection').style.display = 'none';
}

// Setup stat card hover functionality
function setupStatCardHovers() {
    // Create tooltip element if it doesn't exist
    let tooltip = document.getElementById('statTooltip');
    if (!tooltip) {
        tooltip = document.createElement('div');
        tooltip.id = 'statTooltip';
        tooltip.style.cssText = `
            position: absolute;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid #E5E5EA;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: none;
            max-width: 400px;
            max-height: 500px;
            overflow-y: auto;
        `;
        document.body.appendChild(tooltip);
    }
    
    // Add hover handlers to all stat cards
    const statCards = document.querySelectorAll('.stat-card[data-stat-type]');
    statCards.forEach(card => {
        const statType = card.getAttribute('data-stat-type');
        
        // Make all cards interactive for group users
        if (isGroup && !isSingleParkingMode) {
            card.style.cursor = 'pointer';
            
            card.addEventListener('mouseenter', (e) => {
                showStatTooltip(e, statType);
            });
            
            card.addEventListener('mouseleave', () => {
                hideStatTooltip();
            });
            
            card.addEventListener('click', (e) => {
                e.stopPropagation();
                showStatTooltip(e, statType, true);
            });
        }
    });
    
    // Hide tooltip when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.stat-card') && !e.target.closest('#statTooltip')) {
            hideStatTooltip();
        }
    });
}

// Show stat tooltip with parking details
function showStatTooltip(event, statType, isClick = false) {
    const tooltip = document.getElementById('statTooltip');
    const card = event.currentTarget;
    
    // Calculate parking data
    const parkingStats = {};
    currentData.forEach(d => {
        if (!parkingStats[d.parking_name]) {
            parkingStats[d.parking_name] = {
                revenue: 0,
                entries: 0,
                barriers: 0,
                casual: 0,
                members: 0,
                app: 0,
                cash: 0,
                credit: 0,
                pango: 0,
                cello: 0
            };
        }
        parkingStats[d.parking_name].revenue += d.total_revenue_shekels || 0;
        parkingStats[d.parking_name].entries += d.t_entry_tot || 0;
        parkingStats[d.parking_name].barriers += d.t_open_b || 0;
        parkingStats[d.parking_name].casual += d.t_entry_s || 0;
        parkingStats[d.parking_name].members += d.t_entry_p || 0;
        parkingStats[d.parking_name].app += d.t_entry_app || 0;
        parkingStats[d.parking_name].cash += d.s_cash || 0;
        parkingStats[d.parking_name].credit += d.s_credit || 0;
        parkingStats[d.parking_name].pango += d.s_pango || 0;
        parkingStats[d.parking_name].cello += d.s_cello || 0;
    });
    
    // Sort parkings by the relevant metric
    let sortedParkings;
    switch(statType) {
        case 'revenue':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].revenue - a[1].revenue);
            break;
        case 'entries':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].entries - a[1].entries);
            break;
        case 'barriers':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].barriers - a[1].barriers);
            break;
        case 'casual':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].casual - a[1].casual);
            break;
        case 'members':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].members - a[1].members);
            break;
        case 'app':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].app - a[1].app);
            break;
        case 'cash':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].cash - a[1].cash);
            break;
        case 'credit':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].credit - a[1].credit);
            break;
        case 'pango':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].pango - a[1].pango);
            break;
        case 'cello':
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].cello - a[1].cello);
            break;
        default:
            sortedParkings = Object.entries(parkingStats).sort((a, b) => b[1].revenue - a[1].revenue);
    }
    
    // Build tooltip content
    let content = '<div style="font-weight: 600; font-size: 16px; margin-bottom: 12px; color: #1C1C1E;">';
    switch(statType) {
        case 'revenue':
            content += 'הכנסות לפי חניון';
            break;
        case 'entries':
            content += 'כניסות לפי חניון';
            break;
        case 'barriers':
            content += 'פתיחות מחסום לפי חניון';
            break;
        case 'casual':
            content += 'מזדמנים לפי חניון';
            break;
        case 'members':
            content += 'מנויים לפי חניון';
            break;
        case 'app':
            content += 'אפליקציה לפי חניון';
            break;
        case 'cash':
            content += 'מזומן לפי חניון';
            break;
        case 'credit':
            content += 'אשראי לפי חניון';
            break;
        case 'pango':
            content += 'פנגו לפי חניון';
            break;
        case 'cello':
            content += 'סלו לפי חניון';
            break;
        default:
            content += 'פירוט לפי חניון';
    }
    content += '</div>';
    
    content += '<div style="max-height: 400px; overflow-y: auto;">';
    sortedParkings.forEach(([parkingName, stats], index) => {
        let value;
        let percentage = 0;
        let total;
        
        switch(statType) {
            case 'revenue':
                value = `₪${stats.revenue.toLocaleString()}`;
                total = sortedParkings.reduce((sum, [, s]) => sum + s.revenue, 0);
                percentage = total > 0 ? (stats.revenue / total * 100).toFixed(1) : 0;
                break;
            case 'entries':
                value = stats.entries.toLocaleString();
                total = sortedParkings.reduce((sum, [, s]) => sum + s.entries, 0);
                percentage = total > 0 ? (stats.entries / total * 100).toFixed(1) : 0;
                break;
            case 'barriers':
                value = stats.barriers.toLocaleString();
                total = sortedParkings.reduce((sum, [, s]) => sum + s.barriers, 0);
                percentage = total > 0 ? (stats.barriers / total * 100).toFixed(1) : 0;
                break;
            case 'casual':
                value = stats.casual.toLocaleString();
                total = sortedParkings.reduce((sum, [, s]) => sum + s.casual, 0);
                percentage = total > 0 ? (stats.casual / total * 100).toFixed(1) : 0;
                break;
            case 'members':
                value = stats.members.toLocaleString();
                total = sortedParkings.reduce((sum, [, s]) => sum + s.members, 0);
                percentage = total > 0 ? (stats.members / total * 100).toFixed(1) : 0;
                break;
            case 'app':
                value = stats.app.toLocaleString();
                total = sortedParkings.reduce((sum, [, s]) => sum + s.app, 0);
                percentage = total > 0 ? (stats.app / total * 100).toFixed(1) : 0;
                break;
            case 'cash':
                value = `₪${stats.cash.toLocaleString()}`;
                total = sortedParkings.reduce((sum, [, s]) => sum + s.cash, 0);
                percentage = total > 0 ? (stats.cash / total * 100).toFixed(1) : 0;
                break;
            case 'credit':
                value = `₪${stats.credit.toLocaleString()}`;
                total = sortedParkings.reduce((sum, [, s]) => sum + s.credit, 0);
                percentage = total > 0 ? (stats.credit / total * 100).toFixed(1) : 0;
                break;
            case 'pango':
                value = `₪${stats.pango.toLocaleString()}`;
                total = sortedParkings.reduce((sum, [, s]) => sum + s.pango, 0);
                percentage = total > 0 ? (stats.pango / total * 100).toFixed(1) : 0;
                break;
            case 'cello':
                value = `₪${stats.cello.toLocaleString()}`;
                total = sortedParkings.reduce((sum, [, s]) => sum + s.cello, 0);
                percentage = total > 0 ? (stats.cello / total * 100).toFixed(1) : 0;
                break;
        }
        
        const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '';
        
        content += `
            <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 12px;
                margin: 4px 0;
                background: ${index < 3 ? 'rgba(0, 122, 255, 0.05)' : 'rgba(0, 0, 0, 0.02)'};
                border-radius: 8px;
                transition: background 0.2s;
            " onmouseover="this.style.background='rgba(0, 122, 255, 0.1)'" onmouseout="this.style.background='${index < 3 ? 'rgba(0, 122, 255, 0.05)' : 'rgba(0, 0, 0, 0.02)'}'">
                <div style="display: flex; align-items: center; gap: 8px;">
                    ${medal ? `<span style="font-size: 18px;">${medal}</span>` : `<span style="color: #8E8E93; font-size: 14px; min-width: 20px;">${index + 1}.</span>`}
                    <span style="font-weight: 500; color: #1C1C1E;">${parkingName}</span>
                </div>
                <div style="text-align: left;">
                    <div style="font-weight: 600; color: #007AFF;">${value}</div>
                    <div style="font-size: 12px; color: #8E8E93;">${percentage}%</div>
                </div>
            </div>
        `;
    });
    content += '</div>';
    
    tooltip.innerHTML = content;
    
    // Position tooltip
    const rect = card.getBoundingClientRect();
    const tooltipWidth = 350;
    const tooltipHeight = 400;
    
    let left = rect.left + (rect.width / 2) - (tooltipWidth / 2);
    let top = rect.bottom + 10;
    
    // Adjust if goes off screen
    if (left < 10) left = 10;
    if (left + tooltipWidth > window.innerWidth - 10) left = window.innerWidth - tooltipWidth - 10;
    if (top + tooltipHeight > window.innerHeight - 10) {
        top = rect.top - tooltipHeight - 10;
    }
    
    tooltip.style.left = `${left}px`;
    tooltip.style.top = `${top}px`;
    tooltip.style.display = 'block';
    
    // Store click state
    tooltip.setAttribute('data-clicked', isClick ? 'true' : 'false');
}

// Hide stat tooltip
function hideStatTooltip() {
    const tooltip = document.getElementById('statTooltip');
    if (tooltip && tooltip.getAttribute('data-clicked') !== 'true') {
        tooltip.style.display = 'none';
    }
}

// Initialize
console.log('Apple Dashboard ready!');
</script>

</body>
</html> 
