<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בדיקה מקיפה של השרת</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .test { 
            margin: 10px 0; 
            padding: 15px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { 
            background-color: #d4edda; 
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error { 
            background-color: #f8d7da; 
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .pending { 
            background-color: #fff3cd; 
            color: #856404;
            border: 1px solid #ffeeba;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        h2 { 
            color: #333; 
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .warning {
            background: #ffe0b2;
            border: 1px solid #ffcc80;
            padding: 10px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>🔍 בדיקה מקיפה של השרת</h1>
    
    <div class="warning">
        <strong>⚠️ חשוב:</strong> לפני הבדיקה, נקה את מטמון הדפדפן (Ctrl+F5) או פתח בחלון גלישה בסתר
    </div>

    <button onclick="runAllTests()">▶️ הפעל את כל הבדיקות</button>
    <button onclick="clearAll()">🗑️ נקה תוצאות</button>

    <div id="results"></div>

    <script>
        const BASE_URL = 'https://s-b-parking-reports.onrender.com';
        const tests = [
            {
                name: '1. בדיקת סטטוס השרת',
                url: '/api/status',
                method: 'GET',
                checkVersion: true
            },
            {
                name: '2. בדיקת test-proxy endpoint',
                url: '/api/test-proxy',
                method: 'GET'
            },
            {
                name: '3. בדיקת proxy endpoint עם GET',
                url: '/api/company-manager/proxy',
                method: 'GET'
            },
            {
                name: '4. בדיקת proxy endpoint עם OPTIONS (CORS)',
                url: '/api/company-manager/proxy',
                method: 'OPTIONS'
            },
            {
                name: '5. בדיקת proxy endpoint עם POST',
                url: '/api/company-manager/proxy',
                method: 'POST',
                body: JSON.stringify({
                    parking_id: 'test',
                    endpoint: 'test',
                    method: 'GET'
                }),
                headers: {
                    'Content-Type': 'application/json'
                }
            },
            {
                name: '6. בדיקת root endpoint',
                url: '/',
                method: 'GET',
                checkRedirect: true
            },
            {
                name: '7. בדיקת parkings endpoint',
                url: '/api/company-manager/get-parkings',
                method: 'GET'
            },
            {
                name: '8. בדיקת זמן תגובה',
                url: '/api/status',
                method: 'GET',
                measureTime: true
            }
        ];

        function clearAll() {
            document.getElementById('results').innerHTML = '';
        }

        async function runTest(test) {
            const div = document.createElement('div');
            div.className = 'test pending';
            div.innerHTML = `<h3>${test.name}</h3><div>בודק...</div>`;
            document.getElementById('results').appendChild(div);

            const startTime = Date.now();
            const logDiv = document.createElement('div');
            logDiv.className = 'log';
            
            try {
                const options = {
                    method: test.method,
                    headers: test.headers || {}
                };
                
                if (test.body) {
                    options.body = test.body;
                }

                const response = await fetch(BASE_URL + test.url, options);
                const elapsed = Date.now() - startTime;
                
                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    data = await response.text();
                }

                let status = 'success';
                let message = `✅ ${response.status} ${response.statusText}`;
                
                if (!response.ok) {
                    status = 'error';
                    message = `❌ ${response.status} ${response.statusText}`;
                }

                div.className = `test ${status}`;
                div.innerHTML = `
                    <h3>${test.name}</h3>
                    <div><strong>תוצאה:</strong> ${message}</div>
                    <div><strong>זמן תגובה:</strong> ${elapsed}ms</div>
                `;

                // בדיקות נוספות
                if (test.checkVersion && data.version) {
                    div.innerHTML += `<div><strong>גרסה:</strong> ${data.version}</div>`;
                    if (data.version !== '2.0.8') {
                        div.innerHTML += `<div style="color: red;">⚠️ גרסה לא נכונה! צפוי: 2.0.8</div>`;
                    }
                }

                if (test.measureTime) {
                    if (elapsed > 5000) {
                        div.innerHTML += `<div style="color: orange;">⚠️ זמן תגובה איטי</div>`;
                    }
                }

                // הצגת התגובה
                logDiv.innerHTML = `<strong>Request:</strong> ${test.method} ${BASE_URL}${test.url}<br>`;
                logDiv.innerHTML += `<strong>Response Headers:</strong><br>`;
                for (let [key, value] of response.headers.entries()) {
                    logDiv.innerHTML += `${key}: ${value}<br>`;
                }
                logDiv.innerHTML += `<br><strong>Response Body:</strong><br>`;
                if (typeof data === 'object') {
                    logDiv.innerHTML += JSON.stringify(data, null, 2);
                } else {
                    logDiv.innerHTML += data.substring(0, 500) + (data.length > 500 ? '...' : '');
                }
                
            } catch (error) {
                div.className = 'test error';
                div.innerHTML = `
                    <h3>${test.name}</h3>
                    <div><strong>שגיאה:</strong> ${error.message}</div>
                `;
                logDiv.innerHTML = `<strong>Error:</strong> ${error.stack}`;
            }
            
            div.appendChild(logDiv);
        }

        async function runAllTests() {
            clearAll();
            
            // הוספת timestamp
            const timestamp = document.createElement('div');
            timestamp.innerHTML = `<strong>זמן בדיקה:</strong> ${new Date().toLocaleString('he-IL')}`;
            timestamp.style.marginBottom = '20px';
            document.getElementById('results').appendChild(timestamp);
            
            for (const test of tests) {
                await runTest(test);
                // המתנה קצרה בין בדיקות
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // סיכום
            const summary = document.createElement('div');
            summary.className = 'test';
            summary.innerHTML = '<h2>📊 סיכום הבדיקה</h2>';
            
            const successCount = document.querySelectorAll('.test.success').length;
            const errorCount = document.querySelectorAll('.test.error').length;
            
            summary.innerHTML += `
                <div>✅ הצליחו: ${successCount}</div>
                <div>❌ נכשלו: ${errorCount}</div>
            `;
            
            if (errorCount > 0) {
                summary.innerHTML += `
                    <div style="margin-top: 10px; color: red;">
                        <strong>⚠️ נמצאו בעיות!</strong><br>
                        בדוק את הלוגים למעלה לפרטים נוספים.
                    </div>
                `;
            }
            
            document.getElementById('results').appendChild(summary);
        }
    </script>
</body>
</html>
